<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گزارش مدیریتی و تحلیلی شهرک نمک‌آبرود</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for creating charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Persian Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .chart-container {
            height: 300px;
            width: 100%;
        }
        .summary-chart-container {
            height: 550px;
            width: 100%;
        }
        
        /* --- Header Styles --- */
        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem 0;
        }
        .logo { height: 100px; width: auto; object-fit: contain; }
        .logo.center { height: 180px; }
        .logo.right { height: 100px; }

        /* --- PDF & Print Styling --- */
        .pdf-page {
            page-break-inside: avoid !important; 
        }

        @media print {
            html, body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff;
            }
            .no-print {
                display: none !important;
            }
            .pdf-page {
                page-break-before: always !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-2 sm:p-4 md:p-6">

    <div id="report-content" class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-10">
        
        <!-- Header -->
        <header class="bg-white shadow-sm pb-2 mb-8">
            <div class="logo-container">
                <img src="https://uploadkon.ir/uploads/c1c428_25logo-IMPcoPNG.png" alt="لوگو ایده پرداز محیط" class="logo">
                <img src="https://uploadkon.ir/uploads/df5427_25NA-LOGO-copy.png" alt="لوگو نمک آبرود" class="logo center">
                <img src="https://uploadkon.ir/uploads/611127_25OMS-LOGO-copy.png" alt="لوگو عمران مسکن شمال" class="logo right">
            </div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800 text-center mt-2">گزارش مدیریتی و تحلیلی شهرک نمک‌آبرود</h1>
        </header>

        <!-- Overall Town Summary Page -->
        <div class="pdf-page">
             <section class="pt-2">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-indigo-900 mb-4">نمای کلی شهرک نمک‌آبرود</h2>
                <p class="text-center text-base md:text-lg text-slate-600 max-w-3xl mx-auto mb-10">این بخش، شاخص‌های کلان و وضعیت کلی کاربری اراضی در کل شهرک را نمایش می‌دهد. (توجه: مساحت کل شهرک ۷۱۹.۴۳ هکتار است که بخش‌هایی از آن در جدول کاربری زیر لحاظ نشده‌اند).</p>
                <div id="town-kpi-container" class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                    <!-- Town KPIs will be populated here -->
                </div>
                <div id="land-use-table-container">
                    <!-- Land use table will be populated here -->
                </div>
            </section>
        </div>


        <main id="neighborhoods-container">
            <!-- This will be populated by JavaScript -->
        </main>
        
        <div class="pdf-page">
            <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
            <section class="pt-2">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-indigo-900 mb-4">نمودار تعاملی مقایسه پیشرفت محلات</h2>
                 <p class="text-center text-base md:text-lg text-slate-600 max-w-3xl mx-auto mb-10">این نمودار، وضعیت پیشرفت هر حوزه پروژه را به تفکیک در تمام محلات نمایش می‌دهد. با کلیک بر روی نام هر پروژه در بالای نمودار، می‌توانید آن را مخفی یا نمایان کرده و حوزه‌های مورد نظر را با هم مقایسه کنید.</p>
                 <div class="bg-slate-50 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="summary-chart-container relative">
                        <canvas id="summary-bar-chart"></canvas>
                    </div>
                </div>
            </section>
        </div>

        <div class="pdf-page">
            <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
            <section class="pt-2">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-indigo-900 mb-4">تحلیل چالش‌ها و شاخص‌های کلیدی</h2>
                <p class="text-center text-base md:text-lg text-slate-600 max-w-3xl mx-auto mb-10">نمای کلی از وضعیت پروژه‌ها و ارزیابی مهم‌ترین چالش‌های پیش رو در سطح شهرک.</p>
                <div id="analysis-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- This will be populated by JavaScript -->
                </div>
                 <div id="comparison-table-container" class="mt-8">
                    <!-- This will be populated by JavaScript -->
                </div>
            </section>
        </div>

        <div class="pdf-page">
            <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
            <section class="pt-2">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-indigo-900 mb-8">داشبورد پروژه‌های استراتژیک (فرامحله‌ای)</h2>
                <div id="supra-local-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- This will be populated by JavaScript -->
                </div>
            </section>
        </div>

        <div class="text-center text-sm text-slate-500 pt-8 mt-12 border-t">
            <p>تهیه شده توسط مهندسین مشاور ایده پرداز محیط - شهریورماه 1404</p>
        </div>

        <footer class="text-center mt-12 pt-8 border-t-2 border-slate-200 no-print">
            <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                دانلود گزارش به صورت PDF
            </button>
             <div id="loading-spinner" class="hidden mt-4 flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-slate-600 mr-2">در حال آماده‌سازی فایل PDF...</span>
            </div>
        </footer>
    </div>
    
    <!-- MAIN APPLICATION SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const projectData = {
                "محله ۱": {
                    description: "محله‌ای کم‌تراکم با زیرساخت‌های نسبتاً متوازن که چالش اصلی آن، کمبود شدید خدمات روبنایی و نیاز به فعال‌سازی ظرفیت‌های خالی است.",
                    stats: { area: 54.23, area_percent: 7.5, density: 2.9, households: 53, population: 159, land_price: 30, building_price: 45, unbuilt_services_count: 27 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۲,۲۶۱ متر", incompleteness: 20 },
                        { name: "شبکه توزیع آب", quantity: "۱,۵۸۴ متر", incompleteness: 14 },
                        { name: "شبکه توزیع برق", quantity: "۹۲۰ متر", incompleteness: 8 },
                        { name: "شبکه توزیع گاز", quantity: "۱,۸۷۷ متر", incompleteness: 17 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۱,۰۳۲ متر", incompleteness: 100 }
                    ],
                    services: { executed: { count: 32, area: 17002 }, in_progress: { count: 4, area: 5282 }, unbuilt: { count: 27, area: 70242 } }
                },
                "محله ۲": {
                    description: "پُرجمعیت‌ترین و توسعه‌یافته‌ترین محله شهرک از نظر زیرساختی که اکنون نیازمند تمرکز بر ارتقاء کیفی و تکمیل خدمات روبنایی است.",
                    stats: { area: 66.68, area_percent: 9.3, density: 63.79, households: 1418, population: 4254, land_price: 35, building_price: 45, unbuilt_services_count: 31 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۱,۳۳۴ متر", incompleteness: 10 },
                        { name: "شبکه توزیع آب", quantity: "۸۵۱ متر", incompleteness: 7 },
                        { name: "شبکه توزیع برق", quantity: "۲۲۴ متر", incompleteness: 2 },
                        { name: "شبکه توزیع گاز", quantity: "۱,۳۶۱ متر", incompleteness: 10 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۲,۸۵۶ متر", incompleteness: 99 }
                    ],
                    services: { executed: { count: 20, area: 37303 }, in_progress: { count: 13, area: 19502 }, unbuilt: { count: 31, area: 50237 } }
                },
                "محله ۳": {
                    description: "متراکم‌ترین محله شهرک با زیرساخت‌های تقریباً کامل که اولویت اصلی آن، توسعه فضاهای تجاری محلی و رفع کمبود خدمات عمومی است.",
                    stats: { area: 37.84, area_percent: 5.3, density: 77.61, households: 979, population: 2937, land_price: 40, building_price: 50, unbuilt_services_count: 24 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۸۱۲ متر", incompleteness: 10 },
                        { name: "شبکه توزیع آب", quantity: "۵۶۴ متر", incompleteness: 7 },
                        { name: "شبکه توزیع برق", quantity: "۷۲۸ متر", incompleteness: 9 },
                        { name: "شبکه توزیع گاز", quantity: "۴۸۹ متر", incompleteness: 6 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۷,۸۳۴ متر", incompleteness: 100 }
                    ],
                    services: { executed: { count: 7, area: 8243 }, in_progress: { count: 7, area: 13839 }, unbuilt: { count: 24, area: 33129 } }
                },
                "محله ۴": {
                    description: "محله‌ای وسیع با تراکم جمعیتی پایین که به دلیل حجم بالای پروژه‌های نیمه‌تمام زیرساختی، نیازمند سرمایه‌گذاری متمرکز است.",
                    stats: { area: 69.11, area_percent: 9.6, density: 4.60, households: 106, population: 318, land_price: 30, building_price: 45, unbuilt_services_count: 48 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۳,۴۰۳ متر", incompleteness: 26 },
                        { name: "شبکه توزیع آب", quantity: "۳,۷۶۷ متر", incompleteness: 28 },
                        { name: "شبکه توزیع برق", quantity: "۳,۵۳۶ متر", incompleteness: 27 },
                        { name: "شبکه توزیع گاز", quantity: "۲,۲۶۸ متر", incompleteness: 17 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۳,۲۴۷ متر", incompleteness: 100 }
                    ],
                    services: { executed: { count: 24, area: 32359 }, in_progress: { count: 8, area: 11225 }, unbuilt: { count: 48, area: 89172 } }
                },
                "محله ۵": {
                    description: "توسعه‌یافته‌ترین محله از نظر تکمیل زیرساخت‌ها که با کمترین حجم پروژه‌های باقی‌مانده، بر توسعه خدمات تجاری و اداری متمرکز است.",
                    stats: { area: 35.66, area_percent: 5.0, density: 71.34, households: 848, population: 2544, land_price: 40, building_price: 60, unbuilt_services_count: 18 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۱۶۳ متر", incompleteness: 3 },
                        { name: "شبکه توزیع آب", quantity: "۷۱ متر", incompleteness: 1 },
                        { name: "شبکه توزیع برق", quantity: "۶۸ متر", incompleteness: 1 },
                        { name: "شبکه توزیع گاز", quantity: "۷۱ متر", incompleteness: 1 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۵,۱۰۸ متر", incompleteness: 100 }
                    ],
                    services: { executed: { count: 7, area: 69148 }, in_progress: { count: 3, area: 91977 }, unbuilt: { count: 18, area: 38797 } }
                },
                "محله ۶": {
                    description: "محله‌ای با بالاترین ارزش زمین و تمرکز بر بلندمرتبه‌سازی که چالش اصلی آن، ایجاد خدمات پشتیبان متناسب با سکونت متراکم است.",
                    stats: { area: 36.28, area_percent: 5.0, density: 27.20, households: 329, population: 987, land_price: 100, building_price: 120, unbuilt_services_count: 9 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۱,۲۱۵ متر", incompleteness: 22 },
                        { name: "شبکه توزیع آب", quantity: "۸۱۶ متر", incompleteness: 15 },
                        { name: "شبکه توزیع برق", quantity: "۶۰۲ متر", incompleteness: 11 },
                        { name: "شبکه توزیع گاز", quantity: "۶۴۳ متر", incompleteness: 11 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۵,۵۹۷ متر", incompleteness: 100 }
                    ],
                    services: { executed: { count: 5, area: 10607 }, in_progress: { count: 4, area: 7729 }, unbuilt: { count: 9, area: 28549 } }
                },
                "محله ۷": {
                    description: "محله‌ای توسعه‌نیافته با زیرساخت‌های بسیار ضعیف که اجرای کامل و بنیادین تمام شبکه‌های پایه در آن یک اولویت مطلق است.",
                    stats: { area: 35.85, area_percent: 5.0, density: 2.17, households: 26, population: 78, land_price: 20, building_price: 35, unbuilt_services_count: 14 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۳,۵۹۸ متر", incompleteness: 43 },
                        { name: "شبکه توزیع آب", quantity: "۳,۹۶۰ متر", incompleteness: 47 },
                        { name: "شبکه توزیع برق", quantity: "۴,۲۹۵ متر", incompleteness: 51 },
                        { name: "شبکه توزیع گاز", quantity: "۴,۷۶۶ متر", incompleteness: 57 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۸,۴۲۹ متر", incompleteness: 100 }
                    ],
                    services: { executed: { count: 2, area: 452 }, in_progress: { count: 5, area: 1976 }, unbuilt: { count: 14, area: 26119 } }
                },
                "محله ۸": {
                    description: "عقب‌مانده‌ترین محله از نظر پیشرفت زیرساختی که با توجه به وسعت آن، نیازمند یک برنامه توسعه جامع و سرمایه‌گذاری کلان است.",
                    stats: { area: 65.99, area_percent: 9.2, density: 4.95, households: 109, population: 327, land_price: 15, building_price: 30, unbuilt_services_count: 36 },
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۶,۷۹۱ متر", incompleteness: 54 },
                        { name: "شبکه توزیع آب", quantity: "۴,۵۰۸ متر", incompleteness: 36 },
                        { name: "شبکه توزیع برق", quantity: "۷,۰۷۳ متر", incompleteness: 56 },
                        { name: "شبکه توزیع گاز", quantity: "۷,۰۷۳ متر", incompleteness: 56 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۲,۶۷۳ متر", incompleteness: 100 }
                    ],
                    services: { executed: { count: 18, area: 4599 }, in_progress: { count: 8, area: 25519 }, unbuilt: { count: 36, area: 82173 } }
                }
            };
            const supraLocalProjects = [
                 { name: "اجرای کامل شبکه جمع‌آوری و تصفیه فاضلاب", status: "اجرا نشده", quantity: "کل شهرک (طول نامشخص)", details: "پروژه کلان و حیاتی برای کل شهرک. اجرای آن برای صدور پایان‌کار بسیاری از واحدها ضروری است.", icon: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10' },
                { 
                    name: "توسعه یکپارچه عرصه ساحلی", 
                    status: "پروژه جدید پیشنهادی", 
                    quantity: "۳۱۷,۳۱۵ متر مربع", 
                    details: "احداث مارینا (بندرگاه قایق‌های تفریحی)، ایجاد پلاژ و خدمات سرگرمی‌های ساحلی و احداث هتل‌ویلا.", 
                    icon: 'M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945C19.955 11 21 9.537 21 8s-1.045-3-2.945-3H19V4a1 1 0 00-1-1H6a1 1 0 00-1 1v1H3.055C1.045 5 0 6.537 0 8s1.045 3 3.055 3z',
                    sub_projects: [
                        { title: 'مارینا پارک ساحلی نمک‌آبرود', url: 'https://hrtorabii-404.github.io/namakabroud-report/Dashboard1/Marina/' },
                        { title: 'دهکده جامع تندرستی و آب‌درمانی نمک‌آبرود', url: 'https://hrtorabii-404.github.io/namakabroud-report/Dashboard1/wellness/' }
                    ]
                },
                { 
                    name: "توسعه پارک جنگلی", 
                    status: "پروژه جدید پیشنهادی", 
                    quantity: "۵۵۴,۱۴۲ متر مربع", 
                    details: "ایجاد پارک ماجراجویی (Adventure Park) با رویکرد اکوتوریسم و احداث اقامتگاه‌های سازگار با محیط زیست.", 
                    icon: 'M17.657 18.343A8 8 0 016.343 7.657l-1.414-1.414A10 10 0 1019.07 19.07l-1.414-1.414zM16 12a4 4 0 11-8 0 4 4 0 018 0z',
                    sub_projects: [
                        { title: 'اکوپارک جنگلی پناهگاه داروَگ', url: 'https://hrtorabii-404.github.io/namakabroud-report/Dashboard1/Darvag/' }
                    ]
                },
                { 
                    name: "توسعه ورودی شهرک", 
                    status: "پروژه جدید پیشنهادی", 
                    quantity: "۶۱۱,۳۳۴ متر مربع", 
                    details: "ایجاد مجموعه‌های بازی، مراکز آموزشی و سالن‌های ورزشی در ورودی شهرک برای جذب بازدیدکنندگان.", 
                    icon: 'M15 7a2 2 0 012 2m4 0a6 6 0 01-7.623 5.91L12 20.828l-1.377-1.91A6 6 0 013 9a2 2 0 012-2m10 0V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m10 0h-4',
                    sub_projects: [
                        { title: 'ایده ۱: "محوطه کاسپین" (The Caspian Yard)', url: 'https://hrtorabii-404.github.io/namakabroud-report/CaspianYard/' },
                        { title: 'ایده ۲: "سفره مازندران" (The Mazandaran Table)', url: 'https://hrtorabii-404.github.io/namakabroud-report/Dashboard1/SofreMazandaran/' },
                        { title: 'ایده ۳: "باغ گمشده هیرکانی" (The Lost Hyrcanian Garden)', url: 'https://hrtorabii-404.github.io/namakabroud-report/Dashboard1/HyrcanianGarden/' }
                    ]
                },
                { name: "توسعه عرصه میانی", status: "پروژه جدید پیشنهادی", quantity: "۱۷ هکتار", details: "ایجاد فضاهای گردشگری مبتنی بر غذا (کافه و رستوران) و توسعه فضاهای عمومی ورزشی و فرهنگی روباز.", icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-2a6 6 0 00-12 0v2' },
                { name: "توسعه ناحیه گردشگری تله‌کابین", status: "پروژه جدید پیشنهادی", quantity: "۶۸,۸۴۷ متر مربع", details: "ایجاد خدمات گردشگری مکمل، احداث پارکینگ طبقاتی و مراکز تجاری پشتیبان.", icon: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v4.512l-3 3-3-3V5L8 4z' },
                { name: "پروژه بام سبز نمک‌آبرود", status: "پروژه جدید پیشنهادی", quantity: "مکان‌یابی دقیق", details: "ایجاد یک جاذبه منحصربه‌فرد با دید پانوراما در عرصه‌های جنوبی شهرک.", icon: 'M3 12a9 9 0 1018 0 9 9 0 00-18 0zm13-1a1 1 0 10-2 0v2a1 1 0 102 0v-2zM7 11a1 1 0 10-2 0v2a1 1 0 102 0v-2zm7-4a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1V7z' },
                { 
                    name: "اسکای‌واک هیرکانی و گنبد نوآوری", 
                    status: "پیشنهاد پروژه خلاقانه", 
                    quantity: "پروژه استراتژیک", 
                    details: "Hyrcanian Skywalk & Innovation Dome", 
                    icon: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z',
                    url: 'https://hrtorabii-404.github.io/namakabroud-report/Dashboard1/SkyWalk/' 
                }
            ];
            const analysisData = {
                challenges: [
                    { title: "توسعه‌نیافتگی شدید در محلات ۷ و ۸", details: "این دو محله با میانگین پیشرفت زیرساختی کمتر از ۵۰٪، به عنوان نقاط بحرانی شهرک شناخته می‌شوند و نیازمند تخصیص منابع فوری هستند." },
                    { title: "کمبود خدمات روبنایی در کل شهرک", details: "حتی در محلات توسعه‌یافته، کمبود خدمات روبنایی (تجاری، فرهنگی, ورزشی) یک چالش عمومی است که بر کیفیت زندگی ساکنان تأثیر منفی می‌گذارد." },
                    { title: "عدم توازن در توسعه", details: "شکاف عمیقی بین محلات پیشرفته (مانند محله ۵ با تکمیل ۹۹٪ زیرساخت) و محلات عقب‌مانده (مانند محله ۷) وجود دارد که نیازمند یک برنامه توسعه متوازن است." }
                ],
                kpis: [
                    { value: "۷۸٪", label: "پیشرفت کل زیربنایی" },
                    { value: "۲۴٪", label: "پیشرفت کل روبنایی" },
                    { value: "محله ۵", label: "بهترین عملکرد زیرساختی" },
                    { value: "محله ۷", label: "بیشترین نیاز به توجه" }
                ]
            };

            function getColorForPercentage(percentage) {
                const p = Math.max(0, Math.min(100, percentage)) / 100;
                const red = { r: 239, g: 68, b: 68 };
                const yellow = { r: 245, g: 158, b: 11 };
                const green = { r: 34, g: 197, b: 94 };
                let r, g, b;
                if (p < 0.5) {
                    const t = p * 2;
                    r = Math.round(red.r + (yellow.r - red.r) * t);
                    g = Math.round(red.g + (yellow.g - red.g) * t);
                    b = Math.round(red.b + (yellow.b - red.b) * t);
                } else {
                    const t = (p - 0.5) * 2;
                    r = Math.round(yellow.r + (green.r - yellow.r) * t);
                    g = Math.round(yellow.g + (green.g - yellow.g) * t);
                    b = Math.round(yellow.b + (green.b - yellow.b) * t);
                }
                return `rgba(${r}, ${g}, ${b}, 0.8)`;
            }

            function createServicesChart(services, canvasId) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const total = services.executed.area + services.in_progress.area + services.unbuilt.area;
                const data = {
                    labels: [
                        `اجرا شده (${((services.executed.area / total) * 100).toFixed(1)}%)`,
                        `در حال اجرا (${((services.in_progress.area / total) * 100).toFixed(1)}%)`,
                        `اجرا نشده (${((services.unbuilt.area / total) * 100).toFixed(1)}%)`
                    ],
                    datasets: [{
                        label: 'وضعیت خدمات روبنایی',
                        data: [services.executed.area, services.in_progress.area, services.unbuilt.area],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                };
                new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { family: "'Vazirmatn', sans-serif", size: 11 } } },
                            tooltip: { 
                                bodyFont: { family: "'Vazirmatn', sans-serif" }, 
                                titleFont: { family: "'Vazirmatn', sans-serif" },
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const count = context.dataset.data.indexOf(value) === 0 ? services.executed.count : context.dataset.data.indexOf(value) === 1 ? services.in_progress.count : services.unbuilt.count;
                                        return `${label}: ${value.toLocaleString()} م.م. (${count} مورد)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function createInteractiveBarChart() {
                const projectTypes = [...new Set(Object.values(projectData).flatMap(data => data.projects.map(p => p.name)))];
                const neighborhoodNames = Object.keys(projectData);

                const datasets = projectTypes.map((type) => {
                    const dataPoints = neighborhoodNames.map(name => {
                        const project = projectData[name].projects.find(p => p.name === type);
                        return project ? 100 - project.incompleteness : null;
                    });
                    return {
                        label: type,
                        data: dataPoints,
                        backgroundColor: dataPoints.map(p => p !== null ? getColorForPercentage(p) : 'transparent'),
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1,
                        borderRadius: 4
                    };
                });

                const ctx = document.getElementById('summary-bar-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: { labels: neighborhoodNames, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%', font: { family: "'Vazirmatn', sans-serif" } } },
                            x: { ticks: { font: { family: "'Vazirmatn', sans-serif", size: 12 } } }
                        },
                        plugins: {
                            legend: { 
                                position: 'top', 
                                labels: { font: { family: "'Vazirmatn', sans-serif", size: 12 } },
                                onClick: (e, legendItem, legend) => {
                                    const index = legendItem.datasetIndex;
                                    const ci = legend.chart;
                                    if (ci.isDatasetVisible(index)) {
                                        ci.hide(index);
                                        legendItem.hidden = true;
                                    } else {
                                        ci.show(index);
                                        legendItem.hidden = false;
                                    }
                                }
                            },
                            tooltip: { 
                                bodyFont: { family: "'Vazirmatn', sans-serif" }, 
                                titleFont: { family: "'Vazirmatn', sans-serif" }, 
                                callbacks: { 
                                    label: function(context) {
                                        const neighborhoodName = context.label;
                                        const projectName = context.dataset.label;
                                        const completion = context.raw.toFixed(1);
                                        const projectDetails = projectData[neighborhoodName].projects.find(p => p.name === projectName);
                                        const quantity = projectDetails ? projectDetails.quantity : 'N/A';
                                        let status = completion > 75 ? 'پیشرفت عالی' : completion > 40 ? 'وضعیت مطلوب' : 'وضعیت بحرانی';
                                        
                                        return [
                                            `محله: ${neighborhoodName}`,
                                            `پروژه: ${projectName}`,
                                            `درصد تکمیل: ${completion}% (${status})`,
                                            `مقدار باقی‌مانده: ${quantity}`
                                        ];
                                    }
                                } 
                            }
                        }
                    }
                });
            }
            
            function populateContent() {
                const container = document.getElementById('neighborhoods-container');
                let neighborhoodIndex = 1;
                for (const [name, data] of Object.entries(projectData)) {
                    const canvasId = `services-chart-${neighborhoodIndex}`;
                    
                    const statsHtml = `
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-slate-100 p-4 rounded-lg flex items-center space-x-3 space-x-reverse shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg>
                                <div><p class="text-indigo-800 font-bold text-lg">${data.stats.area} هکتار</p><p class="text-xs text-slate-500">${data.stats.area_percent}% از کل</p></div>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg flex items-center space-x-3 space-x-reverse shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                <div><p class="text-indigo-800 font-bold text-lg">${data.stats.population} نفر</p><p class="text-xs text-slate-500">${data.stats.households} خانوار</p></div>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg flex items-center space-x-3 space-x-reverse shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                <div><p class="text-indigo-800 font-bold text-lg">${data.stats.land_price} م.ت</p><p class="text-xs text-slate-500">قیمت زمین</p></div>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg flex items-center space-x-3 space-x-reverse shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                                <div><p class="text-indigo-800 font-bold text-lg">${data.stats.unbuilt_services_count} مورد</p><p class="text-xs text-slate-500">خدمات اجرا نشده</p></div>
                            </div>
                        </div>
                    `;

                    const projectDetailsHtml = data.projects.map(p => {
                        const completion = 100 - p.incompleteness;
                        const colorName = completion > 75 ? 'green' : completion > 40 ? 'amber' : 'red';
                        return `
                            <div class="bg-white p-3 rounded-lg shadow-sm border-r-4 border-${colorName}-400">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-semibold text-slate-700">${p.name}</span>
                                    <span class="text-sm font-bold text-${colorName}-600">${completion}%</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-${colorName}-500 h-2 rounded-full" style="width: ${completion}%;"></div>
                                </div>
                                <p class="text-xs text-slate-500 mt-1 text-left">مقدار باقی‌مانده: ${p.quantity}</p>
                            </div>
                        `;
                    }).join('');

                    const sectionHtml = `
                        <div class="pdf-page">
                            <section>
                                <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
                                <h2 class="text-3xl font-bold text-indigo-900">${name}</h2>
                                <p class="text-md text-slate-600 mt-1 italic">"${data.description}"</p>
                                ${statsHtml}
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                                    <div class="space-y-4 bg-slate-50 p-4 rounded-xl">
                                        <h3 class="font-bold text-lg text-slate-800 mb-3 text-center">جزئیات پیشرفت پروژه‌های زیربنایی</h3>
                                        ${projectDetailsHtml}
                                    </div>
                                    <div class="bg-slate-50 p-4 rounded-xl flex flex-col justify-center">
                                        <h3 class="font-bold text-lg text-slate-800 mb-3 text-center">تحلیل وضعیت خدمات روبنایی</h3>
                                        <div class="chart-container relative"><canvas id="${canvasId}"></canvas></div>
                                    </div>
                                </div>
                            </section>
                        </div>`;
                    container.innerHTML += sectionHtml;
                    neighborhoodIndex++;
                }
            }

            function populateAnalysisAndKPIs() {
                const analysisContainer = document.getElementById('analysis-container');
                const kpiHtml = analysisData.kpis.map(kpi => `
                    <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-lg text-center">
                        <p class="text-4xl font-bold">${kpi.value}</p>
                        <p class="text-sm opacity-80 mt-1">${kpi.label}</p>
                    </div>
                `).join('');

                const challengesHtml = analysisData.challenges.map(c => `
                    <div class="bg-white p-4 rounded-lg border-r-4 border-amber-500 shadow-md">
                        <h4 class="font-bold text-amber-700">${c.title}</h4>
                        <p class="text-sm text-slate-600 mt-1">${c.details}</p>
                    </div>
                `).join('');

                analysisContainer.innerHTML = `
                    <div class="space-y-4">${kpiHtml}</div>
                    <div class="space-y-4">${challengesHtml}</div>
                `;

                const comparisonTableContainer = document.getElementById('comparison-table-container');
                const tableHeader = `
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-2 text-sm font-semibold text-slate-600 text-right">محله</th>
                            <th class="p-2 text-sm font-semibold text-slate-600 text-center">مساحت (هکتار)</th>
                            <th class="p-2 text-sm font-semibold text-slate-600 text-center">تراکم جمعیتی</th>
                            <th class="p-2 text-sm font-semibold text-slate-600 text-center">قیمت زمین (میلیون تومان)</th>
                        </tr>
                    </thead>
                `;
                const tableBody = Object.entries(projectData).map(([name, data]) => `
                    <tr class="border-b border-slate-200">
                        <td class="p-2 font-bold text-slate-800">${name}</td>
                        <td class="p-2 text-center text-slate-600">${data.stats.area}</td>
                        <td class="p-2 text-center text-slate-600">${data.stats.density}</td>
                        <td class="p-2 text-center text-slate-600">${data.stats.land_price}</td>
                    </tr>
                `).join('');
                
                comparisonTableContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-center text-indigo-900 mb-4 mt-10">جدول مقایسه‌ای شاخص‌های کلیدی محلات</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="w-full text-sm">${tableHeader}<tbody>${tableBody}</tbody></table>
                    </div>
                `;
            }
            
            function populateSupraLocal() {
                const container = document.getElementById('supra-local-container');
                container.innerHTML = supraLocalProjects.map(p => {
                    let innerCardHtml = `
                        <div class="flex items-start space-x-4 space-x-reverse">
                            <div class="flex-shrink-0 p-3 bg-indigo-100 rounded-full">
                                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${p.icon}"></path></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-indigo-800">${p.name}</h3>
                                <span class="text-xs font-semibold py-1 px-2.5 uppercase rounded-full text-indigo-600 bg-indigo-100">${p.status}</span>
                                 <p class="text-sm text-slate-600 mt-2"><strong class="font-semibold">مقیاس:</strong> ${p.quantity}</p>
                                <p class="text-sm text-slate-500 mt-2 border-t pt-2">${p.details}</p>
                    `;

                    if (p.sub_projects && p.sub_projects.length > 0) {
                        innerCardHtml += `<div class="mt-3 pt-3 border-t space-y-2">`;
                        p.sub_projects.forEach(sub => {
                            innerCardHtml += `
                                <a href="${sub.url}" target="_blank" rel="noopener noreferrer" class="flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                    <span>${sub.title}</span>
                                </a>
                            `;
                        });
                        innerCardHtml += `</div>`;
                    }

                    innerCardHtml += `
                            </div>
                        </div>
                    `;

                    const cardContainerClass = "bg-slate-50 rounded-xl shadow-md p-5 border-r-4 border-indigo-500";

                    if (p.url) {
                        return `<a href="${p.url}" target="_blank" rel="noopener noreferrer" class="${cardContainerClass} block hover:bg-indigo-50 transition-colors">${innerCardHtml}</a>`;
                    } else {
                        return `<div class="${cardContainerClass}">${innerCardHtml}</div>`;
                    }
                }).join('');
            }

            function populateTownKPIs() {
                const container = document.getElementById('town-kpi-container');
                const kpis = [
                    { value: "۷۱۹.۴۳ هکتار", label: "مساحت کل شهرک", icon: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' },
                    { value: "۱۱,۶۱۹ نفر", label: "جمعیت برآوردی (۱۴۰۰)", icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' },
                    { value: "۶۷۳ نفر", label: "جمعیت دائمی موجود", icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-2a6 6 0 00-12 0v2' },
                    { value: "۷۸٪", label: "پیشرفت کل زیربنایی" , icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                    { value: "۲۴٪", label: "پیشرفت کل روبنایی", icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' }
                ];
                 container.innerHTML = kpis.map(kpi => `
                    <div class="bg-indigo-50 p-4 rounded-lg flex items-center space-x-4 space-x-reverse shadow-sm">
                        <div class="flex-shrink-0 p-3 bg-indigo-200 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${kpi.icon}" /></svg>
                        </div>
                        <div><p class="text-indigo-800 font-bold text-xl">${kpi.value}</p><p class="text-sm text-slate-500">${kpi.label}</p></div>
                    </div>
                `).join('');
            }
            
            function populateLandUseTable() {
                const container = document.getElementById('land-use-table-container');
                const landUseData = [
                    { name: "مسکونی", area: 56.7, area_percent: 10.5, count: 1178, count_percent: 25.0 },
                    { name: "تجاری", area: 0.9, area_percent: 0.2, count: 19, count_percent: 0.4 },
                    { name: "اداری و انتظامی", area: 0.9, area_percent: 0.2, count: 14, count_percent: 0.3 },
                    { name: "ورزشی", area: 3.5, area_percent: 0.6, count: 4, count_percent: 0.1 },
                    { name: "تفریحی توریستی", area: 30.7, area_percent: 5.7, count: 43, count_percent: 0.9 },
                    { name: "پارک و فضای سبز", area: 7.5, area_percent: 1.4, count: 44, count_percent: 0.9 },
                    { name: "طبیعی (پارک جنگلی)", area: 163, area_percent: 30.3, count: 12, count_percent: 0.3 },
                    { name: "معابر", area: 169, area_percent: 31.4, count: 0, count_percent: 0 },
                    { name: "بایر", area: 161, area_percent: 29.9, count: 2551, count_percent: 54.3 },
                ];

                const tableHeader = `
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-3 text-sm font-semibold text-slate-600 text-right">کاربری</th>
                            <th class="p-3 text-sm font-semibold text-slate-600 text-center">تعداد قطعات</th>
                            <th class="p-3 text-sm font-semibold text-slate-600 text-center">درصد از کل قطعات</th>
                            <th class="p-3 text-sm font-semibold text-slate-600 text-center">مساحت (هکتار)</th>
                            <th class="p-3 text-sm font-semibold text-slate-600 text-center">درصد از کل مساحت</th>
                        </tr>
                    </thead>
                `;
                const tableBody = landUseData.map(item => `
                    <tr class="border-b border-slate-200">
                        <td class="p-3 font-bold text-slate-800">${item.name}</td>
                        <td class="p-3 text-center text-slate-600">${item.count.toLocaleString()}</td>
                        <td class="p-3 text-center text-slate-600">${item.count_percent}%</td>
                        <td class="p-3 text-center text-slate-600">${item.area.toLocaleString()}</td>
                        <td class="p-3 text-center text-slate-600">${item.area_percent}%</td>
                    </tr>
                `).join('');
                
                const totalCount = landUseData.reduce((sum, item) => sum + item.count, 0);
                const totalArea = landUseData.reduce((sum, item) => sum + item.area, 0);

                const tableFooter = `
                    <tfoot class="bg-slate-200 font-bold">
                        <tr>
                            <td class="p-3 text-right">جمع کل</td>
                            <td class="p-3 text-center">${totalCount.toLocaleString()}</td>
                            <td class="p-3 text-center">۱۰۰٪</td>
                            <td class="p-3 text-center">${totalArea.toFixed(2).toLocaleString()}</td>
                            <td class="p-3 text-center">۱۰۰٪</td>
                        </tr>
                    </tfoot>
                `;

                container.innerHTML = `
                    <h3 class="text-xl font-bold text-center text-indigo-900 mb-4 mt-10">جدول وضعیت کاربری اراضی شهرک</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="w-full text-sm">${tableHeader}<tbody>${tableBody}</tbody>${tableFooter}</table>
                    </div>
                `;
            }
            
            // --- Initial Load ---
            populateTownKPIs();
            populateLandUseTable();
            populateContent();
            populateAnalysisAndKPIs();
            populateSupraLocal();
            createInteractiveBarChart();
            
            let neighborhoodIndex = 1;
            for (const [name, data] of Object.entries(projectData)) {
                createServicesChart(data.services, `services-chart-${neighborhoodIndex}`);
                neighborhoodIndex++;
            }

            // --- PDF Download Logic ---
            document.getElementById('download-btn').addEventListener('click', () => {
                const btn = document.getElementById('download-btn');
                const spinner = document.getElementById('loading-spinner');
                const content = document.getElementById('report-content');

                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                spinner.classList.remove('hidden');
                window.scrollTo(0, 0);

                const opt = {
                    margin: [0.4, 0.2, 0.4, 0.2],
                    filename: 'گزارش-مدیریتی-نمک-آبرود.pdf',
                    image: { type: 'jpeg', quality: 1.0 },
                    html2canvas: { scale: 3, useCORS: true, logging: false },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                };

                setTimeout(() => {
                    html2pdf().from(content).set(opt).save().then(() => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        spinner.classList.add('hidden');
                    }).catch(err => {
                        console.error("PDF generation error:", err);
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        spinner.classList.add('hidden');
                    });
                }, 500);
            });
        });
    </script>
</body>
</html>
