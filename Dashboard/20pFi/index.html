<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد پروژه‌های پیشنهادی عرصه‌های نمک‌آبرود</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f1f5f9;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
        }
        .table-v-align td {
            vertical-align: middle;
        }
        /* Tooltip Styles */
        .tooltip {
            position: absolute;
            text-align: right;
            padding: 10px 12px;
            font-size: 13px;
            background: #1e293b;
            color: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            max-width: 300px;
            line-height: 1.6;
        }
        .treemap-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4px;
            color: #1e293b;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
            height: 100%;
            overflow: hidden;
            word-break: break-word;
            box-sizing: border-box;
        }
        .zone-label {
             display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(0,0,0,0.6);
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-slate-100 p-4 lg:p-8">

    <div class="container mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl lg:text-4xl font-bold text-slate-800">داشبورد تحلیلی پروژه‌های سرمایه‌گذاری نمک‌آبرود</h1>
            <p class="text-slate-500 mt-2">نمایش اطلاعات کلیدی و نمودارهای پویا بر اساس داده‌های جدید</p>
        </header>

        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="card p-4">
                <label for="area-filter" class="block text-sm font-medium text-slate-600 mb-2">فیلتر بر اساس عرصه</label>
                <select id="area-filter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <option value="all">همه عرصه‌ها</option>
                </select>
            </div>
            <div class="card p-4">
                <label for="zone-filter" class="block text-sm font-medium text-slate-600 mb-2">فیلتر بر اساس کد پهنه</label>
                <select id="zone-filter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <option value="all">همه پهنه‌ها</option>
                </select>
            </div>
            <div class="card p-4">
                <label for="partnership-filter" class="block text-sm font-medium text-slate-600 mb-2">فیلتر بر اساس نوع مشارکت</label>
                <select id="partnership-filter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <option value="all">همه مشارکت‌ها</option>
                </select>
            </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Card 1: Total Projects -->
            <div class="card bg-stone-100 p-6 flex flex-col items-center justify-center text-center">
                <div class="bg-stone-200 text-stone-600 p-3 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                </div>
                <p id="total-projects" class="text-4xl font-bold text-stone-800">0</p>
                <h3 class="text-base font-medium text-stone-500 mt-1">تعداد پروژه‌ها</h3>
            </div>
            <!-- Card 2: Total Area -->
            <div class="card bg-teal-50 p-6 flex flex-col items-center justify-center text-center">
                <div class="bg-teal-100 text-teal-600 p-3 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg>
                </div>
                <p id="total-area" class="text-4xl font-bold text-teal-800">0</p>
                <h3 class="text-base font-medium text-teal-500 mt-1">مساحت کل عرصه‌ها (مترمربع)</h3>
            </div>
            <!-- Card 3: Total Built Area -->
            <div class="card bg-amber-50 p-6 flex flex-col items-center justify-center text-center">
                <div class="bg-amber-100 text-amber-600 p-3 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                </div>
                <p id="total-built-area" class="text-4xl font-bold text-amber-800">0</p>
                <h3 class="text-base font-medium text-amber-500 mt-1">مجموع زیربنا (مترمربع)</h3>
            </div>
            <!-- Card 4: Average Density -->
            <div class="card bg-indigo-50 p-6 flex flex-col items-center justify-center text-center">
                <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.084-1.28-.24-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.084-1.28.24-1.857m12.76-1.857L17 15V9c0-1.355-.446-2.62-1.214-3.624M7.24 16.143L7 15V9c0-1.355.446-2.62 1.214-3.624M12 15V9c0-1.355-.446-2.62-1.214-3.624M12 15c0 2.21 1.79 4 4 4h1m-1-4c0 2.21-1.79 4-4 4H7m5-12c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z" /></svg>
                </div>
                <p id="avg-density" class="text-4xl font-bold text-indigo-800">0</p>
                <h3 class="text-base font-medium text-indigo-500 mt-1">متوسط تراکم پیشنهادی (%)</h3>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="card p-6 lg:col-span-1">
                <h3 class="text-xl font-semibold text-slate-700 mb-4">مقایسه مساحت عرصه‌ها</h3>
                <div class="chart-container">
                    <canvas id="areaComparisonChart"></canvas>
                </div>
            </div>
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-xl font-semibold text-slate-700 mb-4">مقایسه زیربنای پیشنهادی پروژه‌ها</h3>
                <div class="chart-container">
                    <canvas id="builtAreaChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Treemap Chart -->
        <div class="card p-6 mb-8">
            <h3 class="text-xl font-semibold text-slate-700 mb-4 text-center">نمودار درختی: مساحت پروژه‌ها در هر عرصه</h3>
            <div id="treemap-chart" style="min-height: 500px;"></div>
        </div>

        <!-- Table -->
        <div class="card overflow-x-auto">
            <h3 class="text-xl font-semibold text-slate-700 p-6">لیست کامل پروژه‌ها</h3>
            <table class="w-full text-sm text-right text-slate-500 table-v-align">
                <thead class="text-xs text-slate-700 uppercase bg-slate-200">
                    <tr>
                        <th scope="col" class="px-6 py-3">عرصه</th>
                        <th scope="col" class="px-6 py-3">کد پهنه</th>
                        <th scope="col" class="px-6 py-3">نام پروژه</th>
                        <th scope="col" class="px-6 py-3">مساحت پروژه (مترمربع)</th>
                        <th scope="col" class="px-6 py-3">زیربنا (مترمربع)</th>
                        <th scope="col" class="px-6 py-3">سطح اشغال (%)</th>
                        <th scope="col" class="px-6 py-3">طبقات</th>
                        <th scope="col" class="px-6 py-3">تراکم (%)</th>
                        <th scope="col" class="px-6 py-3">نوع مشارکت</th>
                    </tr>
                </thead>
                <tbody id="projects-table-body">
                    <!-- Rows will be injected by JavaScript -->
                </tbody>
            </table>
        </div>

    </div>
    
    <div class="tooltip"></div>

    <script>
        // --- UPDATED DATASET ---
        const projectsData = [
            { "area": "عرصه ساحلی", "totalArea": 518147, "zoneCode": "G11", "projectName": "مارینا و پلاژ ساحلی", "projectArea": 324691, "proposedBuiltUpArea": 1050, "occupancyPercentage": 1, "floors": null, "densityPercentage": null, "partnershipType": "بهره‌برداری توسط کارفرما", "managementInfo": "پروژه با ریسک پایین و بازگشت سرمایه سریع؛ تمرکز بر درآمدهای پایدار از اجاره غرفه‌ها و خدمات تفریحی روزانه.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Marina/" },
            { "area": "عرصه ساحلی", "totalArea": 518147, "zoneCode": "G13", "projectName": "ویلاهای لوکس ساحلی", "projectArea": 75680, "proposedBuiltUpArea": 45600, "occupancyPercentage": 30, "floors": 2, "densityPercentage": 60, "partnershipType": "مشارکت در ساخت", "managementInfo": "محصولی لوکس با ارزش افزوده بالا؛ هدف‌گذاری بازار مشتریان خاص و ایجاد برندینگ ممتاز برای شهرک.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Villa/" },
            { "area": "عرصه ساحلی", "totalArea": 518147, "zoneCode": "G14", "projectName": "سوئیت‌های ساحلی", "projectArea": 56997, "proposedBuiltUpArea": 68396, "occupancyPercentage": 20, "floors": 6, "densityPercentage": 120, "partnershipType": "JV (سرمایه‌گذاری مشترک)", "managementInfo": "بهره‌وری بالای زمین با تراکم ساختمانی مناسب؛ جذاب برای خانواده‌ها به دلیل وجود مرکز رفاهی قدرتمند و مشاعات.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Suite/" },
            { "area": "عرصه ساحلی", "totalArea": 518147, "zoneCode": "G15", "projectName": "هتل ۵ ستاره ساحلی", "projectArea": 60779, "proposedBuiltUpArea": 151948, "occupancyPercentage": 10, "floors": 25, "densityPercentage": 250, "partnershipType": "JV (سرمایه‌گذاری مشترک)", "managementInfo": "پروژه شاخص و نمادین با پتانسیل درآمدی چندگانه از اقامت، همایش‌ها و رستوران‌های لوکس.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/hotel/" },
            { "area": "پارک جنگلی", "totalArea": 1051323, "zoneCode": "G21", "projectName": "اکوکمپ لینورا (بوستان بنفشه)", "projectArea": 1051323, "proposedBuiltUpArea": 105132, "occupancyPercentage": 5, "floors": 2, "densityPercentage": 10, "partnershipType": "واگذاری یکپارچه به بهره‌بردار", "managementInfo": "مقصد گردشگری پایدار و منحصربه‌فرد؛ جذاب برای بازار رو به رشد اکوتوریسم و دوست‌داران طبیعت با حداقل مداخله در محیط.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Banafsheh/" },
            { "area": "دامنه کوه مدوبن", "totalArea": 537176, "zoneCode": "G22", "projectName": "اکواوایلد شمشاد (بوستان شمشاد)", "projectArea": 537176, "proposedBuiltUpArea": 53718, "occupancyPercentage": 5, "floors": 2, "densityPercentage": 10, "partnershipType": "BOT", "managementInfo": "جاذبه اصلی گردشگری با ترکیب حیات وحش و هیجان؛ پتانسیل بالای فروش بلیط و جذب بازدیدکننده انبوه.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Shemshad/" },
            { "area": "ورودی شهرک", "totalArea": 638538, "zoneCode": "S12", "projectName": "زمین پارتی گلف (Pitch & Putt)", "projectArea": 50000, "proposedBuiltUpArea": 30000, "occupancyPercentage": 16, "floors": null, "densityPercentage": 60, "partnershipType": "اجاره بلندمدت", "managementInfo": "جذب مشتریان خاص و وفادار؛ درآمد پایدار از طریق اجاره بلندمدت و خدمات کلوپ مرکزی لوکس.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Golf/" },
            { "area": "ورودی شهرک", "totalArea": 638538, "zoneCode": "S12", "projectName": "پیست موتورسواری سوپرکراس", "projectArea": 40000, "proposedBuiltUpArea": 24000, "occupancyPercentage": 30, "floors": null, "densityPercentage": 60, "partnershipType": "اجاره بلندمدت", "managementInfo": "پروژه‌ای هیجان‌انگیز و کم‌نظیر در منطقه؛ پتانسیل جذب رویدادهای ملی و مخاطبان جوان و پرانرژی.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Motor/" },
            { "area": "ورودی شهرک", "totalArea": 638538, "zoneCode": "S12 / S13", "projectName": "مجموعه ورزشی و شهربازی مدرن", "projectArea": 344289, "proposedBuiltUpArea": 206573, "occupancyPercentage": 30, "floors": null, "densityPercentage": 60, "partnershipType": "JV (سرمایه‌گذاری مشترک)", "managementInfo": "مگا-پروژه با جذابیت گسترده برای تمام سنین؛ جریان‌های درآمدی متنوع از ورزش و سرگرمی با ظرفیت پذیرش بالا.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Shahrbazi/" },
            { "area": "ورودی شهرک", "totalArea": 638538, "zoneCode": "S11", "projectName": "مرکز سلامت و تندرستی", "projectArea": 114249, "proposedBuiltUpArea": 91399, "occupancyPercentage": 40, "floors": 2, "densityPercentage": 80, "partnershipType": "BOT", "managementInfo": "مقصد جامع گردشگری سلامت در سطح منطقه‌ای؛ هدف‌گذاری بازار لوکس با ارائه خدمات پزشکی و تندرستی پیشرفته.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Darmani/" },
            { "area": "ورودی شهرک", "totalArea": 638538, "zoneCode": "S13", "projectName": "مرکز نوآوری و فناوری گردشگری", "projectArea": 90000, "proposedBuiltUpArea": 54000, "occupancyPercentage": 30, "floors": 2, "densityPercentage": 60, "partnershipType": "مشارکت در ساخت", "managementInfo": "پروژه‌ای استراتژیک با ارزش بلندمدت؛ جذب سرمایه، استعداد و شرکت‌های نوآور برای آینده گردشگری منطقه.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Fanavari/" },
            { "area": "مراکز محلات", "totalArea": 115826, "zoneCode": "S22", "projectName": "مرکز محله ۱ (تم فرهنگی)", "projectArea": 40000, "proposedBuiltUpArea": 16000, "occupancyPercentage": 20, "floors": null, "densityPercentage": 40, "partnershipType": "ساخت توسط کارفرما و اجاره", "managementInfo": "ایجاد یک قطب فرهنگی و اجتماعی برای شهرک؛ دارای ارزش معنوی بالا و جذاب برای حمایت‌های فرهنگی.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/MahalehFarhangi/" },
            { "area": "مراکز محلات", "totalArea": 115826, "zoneCode": "S22", "projectName": "مرکز محله ۲ (تم پذیرایی)", "projectArea": 15826, "proposedBuiltUpArea": 6330, "occupancyPercentage": 20, "floors": 2, "densityPercentage": 40, "partnershipType": "ساخت توسط کارفرما و اجاره", "managementInfo": "کانسپت پرطرفدار با پاخور بالا و بازگشت سرمایه سریع از طریق اجاره واحدهای متعدد غذایی.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/MahalehFood/" },
            { "area": "مراکز محلات", "totalArea": 115826, "zoneCode": "S22", "projectName": "مرکز محله ۳ (تم بازی بزرگسالان)", "projectArea": 25000, "proposedBuiltUpArea": 10000, "occupancyPercentage": 20, "floors": null, "densityPercentage": 40, "partnershipType": "مشارکت در ساخت", "managementInfo": "مرکز سرگرمی مدرن برای نسل جوان؛ پتانسیل درآمدی بالا از بازی‌های نوین و خدمات پذیرایی تماتیک.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/MahalehBozorgsal/" },
            { "area": "مراکز محلات", "totalArea": 115826, "zoneCode": "S22", "projectName": "مرکز محله ۴ (تم بازی کودکان)", "projectArea": 35000, "proposedBuiltUpArea": 14000, "occupancyPercentage": 20, "floors": null, "densityPercentage": 40, "partnershipType": "مشارکت در ساخت", "managementInfo": "مقصد اصلی خانواده‌ها با پتانسیل تکرار بازدید بالا؛ تمرکز بر ایجاد یک محیط امن، آموزشی و سرگرم‌کننده.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/MahalehKoodak/" },
            { "area": "عرصه میانی", "totalArea": 449490, "zoneCode": "G31", "projectName": "دهکده گردشگری خوراک", "projectArea": 170000, "proposedBuiltUpArea": 68000, "occupancyPercentage": 20, "floors": 2, "densityPercentage": 40, "partnershipType": "ساخت توسط کارفرما و اجاره", "managementInfo": "ترکیب گردشگری و خوراک با هویت فرهنگی قوی؛ قابلیت میزبانی از جشنواره‌های فصلی و جذب گردشگر بین‌المللی.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Khorak/" },
            { "area": "عرصه میانی", "totalArea": 449490, "zoneCode": "G32", "projectName": "دهکده هنر و صنایع دستی", "projectArea": 279490, "proposedBuiltUpArea": 133898, "occupancyPercentage": 20, "floors": null, "densityPercentage": 48, "partnershipType": "مشارکت در ساخت", "managementInfo": "مرکز فرهنگی-اقتصادی با پتانسیل فروش و صادرات صنایع دستی؛ ایجاد تجربه‌ای زنده از هنر ایرانی و جهانی.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/SanayeDasti/" },
            { "area": "عرصه تله‌کابین", "totalArea": 61512, "zoneCode": "S41", "projectName": "تجاری و پارکینگ تله‌کابین", "projectArea": 61512, "proposedBuiltUpArea": 61512, "occupancyPercentage": 25, "floors": 4, "densityPercentage": 100, "partnershipType": "BOT / BOLT", "managementInfo": "دروازه ورودی تله‌کابین با مخاطب تضمین‌شده؛ حداکثرسازی درآمد از طریق خدمات تجاری و سرگرمی برای بازدیدکنندگان.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Parking/" },
            { "area": "پروژه استراتژیک", "totalArea": 70000, "zoneCode": "-", "projectName": "پل سبزآبی", "projectArea": 20000, "proposedBuiltUpArea": 4000, "occupancyPercentage": 10, "floors": 2, "densityPercentage": 20, "partnershipType": "DBOT", "managementInfo": "پروژه‌ای نمادین برای اتصال عرصه‌ها و ایجاد یک جاذبه خطی جدید؛ افزایش ارزش افزوده برای هر دو پایانه ورودی و ساحلی.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/Pol/" },
            { "area": "پروژه استراتژیک", "totalArea": 70000, "zoneCode": "-", "projectName": "پارک ماجراجویی ابرها", "projectArea": 50000, "proposedBuiltUpArea": 2500, "occupancyPercentage": 5, "floors": 1, "densityPercentage": 5, "partnershipType": "BOT", "managementInfo": "تجربه ماجراجویی منحصربه‌فرد در بام نمک‌آبرود؛ استفاده بهینه از زیرساخت تله‌کابین با حداقل مداخله در طبیعت.", "link": "https://hrtorabii-404.github.io/namakabroud-report/Package/ParkAbr/" }
        ];

        // --- CHART & DASHBOARD LOGIC ---
        
        // Chart instances
        let builtAreaChart, areaComparisonChart;
        Chart.defaults.font.family = "'Vazirmatn', sans-serif"; // Set default font for all charts

        // DOM Elements
        const areaFilter = document.getElementById('area-filter');
        const zoneFilter = document.getElementById('zone-filter');
        const partnershipFilter = document.getElementById('partnership-filter');
        const tableBody = document.getElementById('projects-table-body');
        const tooltip = d3.select(".tooltip");
        
        // KPI Elements
        const totalProjectsEl = document.getElementById('total-projects');
        const totalAreaEl = document.getElementById('total-area');
        const totalBuiltAreaEl = document.getElementById('total-built-area');
        const avgDensityEl = document.getElementById('avg-density');

        // --- UNIFIED COLOR MAPPING ---
        const areaColorMap = new Map([
            ["عرصه ساحلی", "#bae6fd"],
            ["پارک جنگلی", "#86efac"],
            ["دامنه کوه مدوبن", "#bbf7d0"],
            ["ورودی شهرک", "#fed7aa"],
            ["مراکز محلات", "#fef08a"],
            ["عرصه میانی", "#fbcfe8"],
            ["عرصه تله‌کابین", "#a7f3d0"],
            ["پروژه استراتژیک", "#e7e5e4"]
        ]);
        
        const areaTailwindColorMap = new Map([
            ["عرصه ساحلی", "bg-sky-100"],
            ["پارک جنگلی", "bg-emerald-100"],
            ["دامنه کوه مدوبن", "bg-green-100"],
            ["ورودی شهرک", "bg-orange-100"],
            ["مراکز محلات", "bg-yellow-100"],
            ["عرصه میانی", "bg-pink-100"],
            ["عرصه تله‌کابین", "bg-teal-100"],
            ["پروژه استراتژیک", "bg-stone-100"]
        ]);

        // Utility to format numbers with commas
        const formatNumber = (num) => num || num === 0 ? num.toLocaleString('fa-IR') : '-';

        // Function to populate filter dropdowns
        function populateFilters() {
            const areas = [...new Set(projectsData.map(p => p.area))];
            const zoneCodes = [...new Set(projectsData.map(p => p.zoneCode))].filter(z => z !== null && z !== undefined);
            const partnerships = [...new Set(projectsData.map(p => p.partnershipType))];

            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
            zoneCodes.forEach(zone => {
                if(zone) {
                    const option = document.createElement('option');
                    option.value = zone;
                    option.textContent = zone;
                    zoneFilter.appendChild(option);
                }
            });
            partnerships.forEach(partnership => {
                const option = document.createElement('option');
                option.value = partnership;
                option.textContent = partnership;
                partnershipFilter.appendChild(option);
            });
        }

        // Main function to update all dashboard components
        function updateDashboard() {
            const selectedArea = areaFilter.value;
            const selectedZone = zoneFilter.value;
            const selectedPartnership = partnershipFilter.value;

            const filteredData = projectsData.filter(p => {
                const areaMatch = selectedArea === 'all' || p.area === selectedArea;
                const zoneMatch = selectedZone === 'all' || p.zoneCode === selectedZone;
                const partnershipMatch = selectedPartnership === 'all' || p.partnershipType === selectedPartnership;
                return areaMatch && zoneMatch && partnershipMatch;
            });

            updateKPIs(filteredData);
            updateAreaComparisonChart(filteredData);
            updateBuiltAreaChart(filteredData);
            updateTreemap(filteredData);
            updateTable(filteredData);
        }

        function updateKPIs(data) {
            totalProjectsEl.textContent = formatNumber(data.length);

            const uniqueAreas = new Map();
            data.forEach(p => {
                if (p.area && p.totalArea && !uniqueAreas.has(p.area)) {
                    uniqueAreas.set(p.area, p.totalArea);
                }
            });
            const totalArea = Array.from(uniqueAreas.values()).reduce((sum, area) => sum + (area || 0), 0);
            totalAreaEl.textContent = formatNumber(totalArea);

            const totalBuiltArea = data.reduce((sum, p) => sum + (p.proposedBuiltUpArea || 0), 0);
            totalBuiltAreaEl.textContent = formatNumber(totalBuiltArea);

            const densities = data.map(p => p.densityPercentage).filter(d => d !== null && d !== undefined);
            const avgDensity = densities.length > 0 ? (densities.reduce((a, b) => a + b, 0) / densities.length) : 0;
            avgDensityEl.textContent = formatNumber(Math.round(avgDensity));
        }
        
        function updateAreaComparisonChart(data) {
            const ctx = document.getElementById('areaComparisonChart').getContext('2d');
            const areaData = data.reduce((acc, p) => {
                 if (p.totalArea) {
                    acc[p.area] = p.totalArea;
                 }
                 return acc;
            }, {});

            const labels = Object.keys(areaData);
            const chartData = Object.values(areaData);
            const backgroundColors = labels.map(label => areaColorMap.get(label) || '#cccccc');

            if (areaComparisonChart) {
                areaComparisonChart.destroy();
            }

            areaComparisonChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'مساحت عرصه (مترمربع)',
                        data: chartData,
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatNumber(context.parsed) + ' مترمربع';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateBuiltAreaChart(data) {
            const ctx = document.getElementById('builtAreaChart').getContext('2d');
            const labels = data.map(p => p.projectName);
            const chartData = data.map(p => p.proposedBuiltUpArea);
            const backgroundColors = data.map(p => areaColorMap.get(p.area) || '#cccccc');
            const borderColors = data.map(p => d3.color(areaColorMap.get(p.area) || '#cccccc').darker(0.5));


            if (builtAreaChart) {
                builtAreaChart.destroy();
            }

            builtAreaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'زیربنای پیشنهادی (مترمربع)',
                        data: chartData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => formatNumber(value) } } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += formatNumber(context.parsed.y) + ' مترمربع';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateTable(data) {
            tableBody.innerHTML = '';
            const groupedByArea = data.reduce((acc, p) => {
                if (!acc[p.area]) {
                    acc[p.area] = [];
                }
                acc[p.area].push(p);
                return acc;
            }, {});

            for (const areaName in groupedByArea) {
                const projectsInArea = groupedByArea[areaName];
                const rowCount = projectsInArea.length;
                const bgColor = areaTailwindColorMap.get(areaName) || 'bg-slate-50';
                
                projectsInArea.forEach((p, index) => {
                    const row = document.createElement('tr');
                    row.className = `${bgColor} border-b border-white hover:bg-opacity-70`;
                    
                    let cells = '';
                    if (index === 0) {
                        cells += `<td class="px-6 py-4 font-medium text-slate-900" rowspan="${rowCount}">${p.area}</td>`;
                    }
                    
                    cells += `
                        <td class="px-6 py-4">${p.zoneCode}</td>
                        <td class="px-6 py-4 font-medium text-slate-800">
                           <a href="${p.link}" target="_blank" class="text-sky-600 hover:text-sky-800 hover:underline transition-colors duration-200">
                             ${p.projectName}
                           </a>
                        </td>
                        <td class="px-6 py-4">${formatNumber(p.projectArea)}</td>
                        <td class="px-6 py-4">${formatNumber(p.proposedBuiltUpArea)}</td>
                        <td class="px-6 py-4">${formatNumber(p.occupancyPercentage)}</td>
                        <td class="px-6 py-4">${formatNumber(p.floors)}</td>
                        <td class="px-6 py-4">${formatNumber(p.densityPercentage)}</td>
                        <td class="px-6 py-4">${p.partnershipType}</td>
                    `;
                    row.innerHTML = cells;

                    // Add tooltip event listeners to the row
                    row.addEventListener('mouseover', (event) => {
                        tooltip.transition().duration(200).style("opacity", .95);
                        tooltip.html(`<strong>نکات مدیریتی:</strong><br/>${p.managementInfo}`)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    });
                    row.addEventListener('mouseout', () => {
                        tooltip.transition().duration(500).style("opacity", 0);
                    });

                    tableBody.appendChild(row);
                });
            }
        }
        
        // --- TREEMAP FUNCTION ---
        const treemapTooltip = d3.select(".tooltip");
        
        function updateTreemap(data) {
            const selector = '#treemap-chart';
            const container = d3.select(selector);
            if (container.empty()) return;
            container.selectAll("*").remove();

            const treemapData = {
                name: "root",
                children: Array.from(d3.group(data, d => d.area), ([key, value]) => ({
                    name: key,
                    children: value.map(d => ({ name: d.projectName, value: d.projectArea }))
                }))
            };

            const width = container.node().getBoundingClientRect().width;
            const height = 500;

            const treemap = d3.treemap().size([width, height]).padding(3).paddingTop(28);
            const root = d3.hierarchy(treemapData).sum(d => d.value).sort((a, b) => b.value - a.value);
            treemap(root);

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height)
                .style("font-family", "Vazirmatn");

            const node = svg.selectAll("g")
                .data(root.descendants())
                .join("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            node.append("rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => {
                    if (d.depth === 0) return "transparent";
                    if (d.depth === 1) return areaColorMap.get(d.data.name);
                    return d3.color(areaColorMap.get(d.parent.data.name)).brighter(0.6);
                })
                .attr("rx", 5)
                .style("opacity", 0)
                .transition().duration(800)
                .style("opacity", 1);
            
            node.on("mouseover", (event, d) => {
                if(d.depth < 2) return;
                treemapTooltip.transition().duration(200).style("opacity", .9);
                treemapTooltip.html(`<strong>${d.data.name}</strong><br/>مساحت: ${formatNumber(d.value)} م²`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                treemapTooltip.transition().duration(500).style("opacity", 0);
            });

            const zoneLabels = node.filter(d => d.depth === 1);
            zoneLabels.append("foreignObject")
                .attr("x", 0).attr("y", 0)
                .attr("width", d => d.x1 - d.x0)
                .attr("height", 28)
                .append("xhtml:div")
                .attr("class", "zone-label")
                .html(d => d.data.name);

            const projectLabels = node.filter(d => d.depth === 2);
            projectLabels.append("foreignObject")
                .attr("x", 2).attr("y", 2)
                .attr("width", d => (d.x1 - d.x0) - 4)
                .attr("height", d => (d.y1 - d.y0) - 4)
                .style("display", d => (d.x1 - d.x0 < 50 || d.y1 - d.y0 < 40) ? "none" : "block")
                .append("xhtml:div")
                .attr("class", "treemap-label")
                .html(d => `${d.data.name}<br><span style="font-size: 11px; opacity: 0.7;">(${formatNumber(d.value)} م²)</span>`);
        }

        // --- INITIALIZATION ---
        
        areaFilter.addEventListener('change', updateDashboard);
        zoneFilter.addEventListener('change', updateDashboard);
        partnershipFilter.addEventListener('change', updateDashboard);

        document.addEventListener('DOMContentLoaded', () => {
            populateFilters();
            updateDashboard();
            
            const chartContainer = document.querySelector('#treemap-chart');
            new ResizeObserver(() => {
                 updateDashboard();
            }).observe(chartContainer);
        });
    </script>

</body>
</html>
