<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد پویای پروژه‌ها</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f1f5f9;
        }
        .chart-container {
            position: relative;
            height: 50vh;
            width: 100%;
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #a8a29e;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #78716c;
        }
        .tooltip-input {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .has-tooltip:hover .tooltip-input {
            visibility: visible;
            opacity: 1;
        }
        /* New styles for the detailed row tooltip */
        #details-tooltip {
            position: absolute;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            transform: scale(0.95);
            pointer-events: none; /* Important so it doesn't interfere with mouse events on the table */
            z-index: 100;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800">داشبورد مدیریتی پکیج‌های سرمایه‌گذاری</h1>
            <p class="text-slate-500 mt-2">تحلیل، فیلتر و ویرایش پویای داده‌های پروژه</p>
        </header>

        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 p-6 bg-white rounded-xl shadow-md">
            <div>
                <label for="filter-area" class="block text-sm font-medium text-slate-700 mb-1">نام عرصه</label>
                <select id="filter-area" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <option value="all">همه</option>
                </select>
            </div>
            <div>
                <label for="filter-zone" class="block text-sm font-medium text-slate-700 mb-1">کد پهنه</label>
                <select id="filter-zone" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <option value="all">همه</option>
                </select>
            </div>
            <div>
                <label for="filter-partnership" class="block text-sm font-medium text-slate-700 mb-1">نوع مشارکت</label>
                <select id="filter-partnership" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <option value="all">همه</option>
                </select>
            </div>
             <div>
                <label for="filter-usage" class="block text-sm font-medium text-slate-700 mb-1">کاربری مصوب</label>
                <select id="filter-usage" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <option value="all">همه</option>
                </select>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Card 1: Total Area -->
            <div class="bg-sky-50 p-5 rounded-xl shadow-md flex items-center gap-4">
                <div class="bg-sky-100 p-3 rounded-full">
                    <svg class="w-6 h-6 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 9.563C9 9.252 9.252 9 9.563 9h4.874c.311 0 .563.252.563.563v4.874c0 .311-.252.563-.563.563H9.563A.563.563 0 019 14.437V9.563z" />
                    </svg>
                </div>
                <div>
                    <span class="text-sm text-slate-500">مجموع مساحت پکیج‌ها</span>
                    <span id="total-area-card" class="block text-2xl font-bold text-slate-800 mt-1">0</span>
                </div>
            </div>
            <!-- Card 2: Total Built Area -->
            <div class="bg-emerald-50 p-5 rounded-xl shadow-md flex items-center gap-4">
                <div class="bg-emerald-100 p-3 rounded-full">
                     <svg class="w-6 h-6 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
                    </svg>
                </div>
                <div>
                    <span class="text-sm text-slate-500">مجموع زیربنای پیشنهادی</span>
                    <span id="total-built-area-card" class="block text-2xl font-bold text-slate-800 mt-1">0</span>
                </div>
            </div>
            <!-- Card 3: Total Projects -->
            <div class="bg-amber-50 p-5 rounded-xl shadow-md flex items-center gap-4">
                 <div class="bg-amber-100 p-3 rounded-full">
                    <svg class="w-6 h-6 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C6.095 4.01 5.25 4.973 5.25 6.108V18.75c0 1.243.87 2.25 1.969 2.25H15a2.25 2.25 0 002.25-2.25v-2.532m-5.8 0c-.376.023-.75.05-1.124.08a9.091 9.091 0 01-1.416-.042" />
                    </svg>
                </div>
                <div>
                    <span class="text-sm text-slate-500">تعداد کل پکیج‌ها</span>
                    <span id="total-projects-card" class="block text-2xl font-bold text-slate-800 mt-1">0</span>
                </div>
            </div>
            <!-- Card 4: Average Density -->
            <div class="bg-violet-50 p-5 rounded-xl shadow-md flex items-center gap-4">
                 <div class="bg-violet-100 p-3 rounded-full">
                    <svg class="w-6 h-6 text-violet-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                </div>
                <div>
                    <span class="text-sm text-slate-500">متوسط تراکم پیشنهادی</span>
                    <span id="avg-density-card" class="block text-2xl font-bold text-slate-800 mt-1">0%</span>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 gap-8 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-slate-800 mb-4">مقایسه زیربنای پیشنهادی (مترمربع)</h2>
                <div class="chart-container">
                    <canvas id="builtAreaChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-slate-800 mb-4">مقایسه مساحت کل عرصه‌ها (مترمربع)</h2>
                <div class="chart-container">
                    <canvas id="areaComparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold text-slate-800">جدول کامل پکیج‌ها</h2>
                 <button id="reset-button" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition text-sm font-medium shadow-sm active:scale-95">
                    بازنشانی داده‌ها
                </button>
            </div>
            <div class="overflow-x-auto table-container">
                <table class="w-full text-sm text-slate-500 whitespace-nowrap">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">نام عرصه</th>
                            <th scope="col" class="px-6 py-3">پکیج سرمایه‌گذاری</th>
                            <th scope="col" class="px-6 py-3">مساحت (مترمربع)</th>
                            <th scope="col" class="px-6 py-3">تراکم پیشنهادی (%)</th>
                            <th scope="col" class="px-6 py-3">زیربنای پیشنهادی (مترمربع)</th>
                            <th scope="col" class="px-6 py-3">نوع مشارکت</th>
                        </tr>
                    </thead>
                    <tbody id="projects-table-body">
                        <!-- Rows will be injected by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Detailed Tooltip Container -->
    <div id="details-tooltip" class="w-80 bg-slate-800 text-white p-4 rounded-lg shadow-2xl border border-slate-600"></div>


    <script>
        const initialProjectsData = [
            { id: 1, areaName: 'عرصه ساحلی', approvedUsage: 'تفریحی و توریستی', zoneCode: 'G12', projectName: 'تثبیت و بهره‌برداری از خدمات ساحلی', projectArea: 74000, proposedOccupancy: null, proposedFloors: null, proposedDensity: null, proposedBuiltArea: 0, partnershipType: 'بهره‌برداری توسط کارفرما', subProjects: ['پلاژهای موجود', 'خدمات پشتیبان ساحلی'] },
            { id: 2, areaName: 'عرصه ساحلی', approvedUsage: 'تفریحی و توریستی', zoneCode: 'G13', projectName: 'اقامت موقت لوکس', projectArea: 76000, proposedOccupancy: 30, proposedFloors: 2, proposedDensity: 60, proposedBuiltArea: 45600, partnershipType: 'فروش قطعات یا مشارکت در ساخت', subProjects: ['شهرک ویلایی لوکس (احداث ۷۶ ویلا)'] },
            { id: 3, areaName: 'عرصه ساحلی', approvedUsage: 'تفریحی و توریستی', zoneCode: 'G14', projectName: 'اقامت موقت', projectArea: 57000, proposedOccupancy: 20, proposedFloors: 6, proposedDensity: 120, proposedBuiltArea: 68400, partnershipType: 'JV (سرمایه‌گذاری مشترک)', subProjects: ['مجتمع آپارتمانی ۶ طبقه'] },
            { id: 4, areaName: 'عرصه ساحلی', approvedUsage: 'تفریحی و توریستی', zoneCode: 'G15', projectName: 'هتلینگ بلندمرتبه', projectArea: 61000, proposedOccupancy: 10, proposedFloors: 25, proposedDensity: 250, proposedBuiltArea: 152500, partnershipType: 'JV (سرمایه‌گذاری مشترک)', subProjects: ['هتل ۵ ستاره ۲۵ طبقه'] },
            { id: 5, areaName: 'پروژه استراتژیک', approvedUsage: 'اتصال بین عرصه‌ای', zoneCode: '-', projectName: 'پکیج سرمایه‌گذاری پل طبیعت', projectArea: 20000, proposedOccupancy: 10, proposedFloors: 2, proposedDensity: 20, proposedBuiltArea: 4000, partnershipType: 'DBOT', subProjects: ['پل معلق (اسکای واک)', 'خدمات جانبی (ایستگاه دوچرخه، کافه، گیمینگ)'] },
            { id: 6, areaName: 'دامنه کوه مدوبن', approvedUsage: 'تفریحی و توریستی', zoneCode: 'G21', projectName: 'پکیج گردشگری تفرجی', projectArea: 1501000, proposedOccupancy: 5, proposedFloors: 2, proposedDensity: 10, proposedBuiltArea: 150100, partnershipType: 'واگذاری یکپارچه به بهره‌بردار', subProjects: ['آکواریوم و باغ پرندگان', 'رستوران‌های محلی و بازارچه صنایع دستی'] },
            { id: 7, areaName: 'دامنه کوه مدوبن', approvedUsage: 'تفریحی و توریستی', zoneCode: 'G22', projectName: 'پکیج گردشگری ماجراجویی', projectArea: 537000, proposedOccupancy: 5, proposedFloors: 2, proposedDensity: 10, proposedBuiltArea: 53700, partnershipType: 'BOT', subProjects: ['پارک ماجراجویی (Adventure Park)', 'زیپ‌لاین، بانجی جامپینگ و...', 'سایت گلمپینگ و کلبه‌های چوبی', 'مسیرهای پیاده‌روی و دوچرخه‌سواری'] },
            { id: 8, areaName: 'عرصه ورودی', approvedUsage: 'تفریح و آموزش', zoneCode: 'S12', projectName: 'پکیج ورزشی و آموزشی شمال', projectArea: 260000, proposedOccupancy: 30, proposedFloors: 2, proposedDensity: 60, proposedBuiltArea: 156000, partnershipType: 'JV / اجاره بلندمدت', subProjects: ['مجموعه ورزشی روباز (گلف، استخر)', 'پیست موتورسواری'] },
            { id: 9, areaName: 'عرصه ورودی', approvedUsage: 'تفریح و آموزش', zoneCode: 'S13', projectName: 'پکیج سرگرمی و آموزشی جنوب', projectArea: 260000, proposedOccupancy: 30, proposedFloors: 2, proposedDensity: 60, proposedBuiltArea: 156000, partnershipType: 'JV / مشارکت در ساخت', subProjects: ['شهر بازی سرپوشیده مدرن', 'آکادمی آموزش غواصی و ورزش‌های آبی'] },
            { id: 10, areaName: 'عرصه مراکز محلات', approvedUsage: 'فرهنگی و تفریحی', zoneCode: 'S22', projectName: 'پکیج خدمات فرهنگی و تفریحی', projectArea: 171000, proposedOccupancy: 20, proposedFloors: 2, proposedDensity: 40, proposedBuiltArea: 68400, partnershipType: 'ساخت توسط کارفرما و اجاره', subProjects: ['مجموعه تئاتر و هنرهای نمایشی', 'پردیس کافه کتاب و گالری‌های هنری'] },
            { id: 11, areaName: 'عرصه میانی', approvedUsage: 'خدمات عمومی', zoneCode: 'G31', projectName: 'پکیج گردشگری خوراک و محصولات بومی', projectArea: 170000, proposedOccupancy: 20, proposedFloors: 2, proposedDensity: 40, proposedBuiltArea: 68000, partnershipType: 'ساخت توسط کارفرما و اجاره', subProjects: ['بلوار غذا (Food Street)', 'بازارچه فروش محصولات بومی و جنگلی'] },
            { id: 12, areaName: 'عرصه میانی', approvedUsage: 'خدمات عمومی', zoneCode: '-', projectName: 'پکیج خدمات عمومی و رفاهی', projectArea: 260000, proposedOccupancy: 20, proposedFloors: 5, proposedDensity: 100, proposedBuiltArea: 260000, partnershipType: 'مشارکت در ساخت', subProjects: ['مجتمع خدمات عمومی، ورزشی و فرهنگی'] },
            { id: 13, areaName: 'عرصه تله‌کابین', approvedUsage: 'گردشگری مکمل', zoneCode: 'S41', projectName: 'پکیج تجاری و پارکینگ تله‌کابین', projectArea: 68847, proposedOccupancy: 25, proposedFloors: 6, proposedDensity: 100, proposedBuiltArea: 103271, partnershipType: 'BOT / BOLT', subProjects: ['پارکینگ طبقاتی هوشمند (۳ طبقه)', 'مرکز خرید و فودکورت (۳ طبقه تجاری)'] }
        ];

        // Clean and normalize data before use
        initialProjectsData.forEach(p => {
            if (p.approvedUsage === 'تفریحی توریستی') {
                p.approvedUsage = 'تفریحی و توریستی';
            }
        });

        let projects = JSON.parse(JSON.stringify(initialProjectsData));
        let initialAreaTotals = {};
        let builtAreaChart, areaComparisonChart;

        const tableBody = document.getElementById('projects-table-body');
        const filterArea = document.getElementById('filter-area');
        const filterZone = document.getElementById('filter-zone');
        const filterPartnership = document.getElementById('filter-partnership');
        const filterUsage = document.getElementById('filter-usage');
        const resetButton = document.getElementById('reset-button');
        const totalAreaCard = document.getElementById('total-area-card');
        const totalBuiltAreaCard = document.getElementById('total-built-area-card');
        const totalProjectsCard = document.getElementById('total-projects-card');
        const avgDensityCard = document.getElementById('avg-density-card');
        const detailsTooltip = document.getElementById('details-tooltip');

        const formatNumber = (num) => num ? new Intl.NumberFormat('fa-IR').format(num) : 'N/A';
        
        // Custom sort order
        const areaOrder = ['عرصه ساحلی', 'دامنه کوه مدوبن', 'عرصه ورودی', 'عرصه میانی', 'عرصه مراکز محلات', 'پروژه استراتژیک', 'عرصه تله‌کابین'];
        const customSort = (a, b) => areaOrder.indexOf(a.areaName) - areaOrder.indexOf(b.areaName);

        function renderTable(data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-slate-500">هیچ پکیجی با فیلترهای انتخابی یافت نشد.</td></tr>`;
                return;
            }

            // Logic for merging cells
            let lastAreaName = null;
            const dataWithRowspan = data.map((item, index) => {
                if (item.areaName !== lastAreaName) {
                    const count = data.filter(d => d.areaName === item.areaName).length;
                    lastAreaName = item.areaName;
                    return { ...item, rowspan: count, isFirstOfGroup: true };
                }
                return { ...item, rowspan: 0, isFirstOfGroup: false };
            });

            dataWithRowspan.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50 group';
                // Store all data in the row for the tooltip
                row.dataset.details = JSON.stringify(p);

                let areaCell = '';
                if (p.isFirstOfGroup) {
                    areaCell = `<td class="px-6 py-4 align-middle text-center border-l" rowspan="${p.rowspan}">${p.areaName}</td>`;
                }

                row.innerHTML = `
                    ${areaCell}
                    <td class="px-6 py-4 font-medium text-slate-900">${p.projectName}</td>
                    <td class="px-6 py-4">
                        <div class="relative has-tooltip">
                            <input type="number" value="${p.projectArea}" data-id="${p.id}" class="area-input w-32 p-1 border rounded-md text-center bg-slate-50 focus:bg-white focus:ring-1 focus:ring-sky-500 transition" />
                            <div class="tooltip-input absolute bottom-full mb-2 w-max max-w-xs p-2 bg-slate-700 text-white text-xs rounded-md shadow-lg z-10"></div>
                        </div>
                    </td>
                    <td class="px-6 py-4">${formatNumber(p.proposedDensity)}</td>
                    <td class="px-6 py-4 font-semibold text-sky-700" id="built-area-${p.id}">${formatNumber(p.proposedBuiltArea)}</td>
                    <td class="px-6 py-4">${p.partnershipType}</td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.area-input').forEach(input => {
                input.addEventListener('input', handleAreaChange);
                input.parentElement.addEventListener('mouseenter', updateInputTooltipInfo);
            });
        }
        
        function renderCharts(data) {
            renderBuiltAreaChart(data);
            renderAreaComparisonChart(data);
        }

        function renderBuiltAreaChart(data) {
            const ctx = document.getElementById('builtAreaChart').getContext('2d');
            const labels = data.map(p => p.projectName);
            const chartData = data.map(p => p.proposedBuiltArea);

            if (builtAreaChart) builtAreaChart.destroy();
            builtAreaChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'زیربنای پیشنهادی', data: chartData, backgroundColor: 'rgba(56, 189, 248, 0.6)', borderColor: 'rgba(14, 165, 233, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { font: { family: "'Vazirmatn', sans-serif" } } }, x: { ticks: { font: { family: "'Vazirmatn', sans-serif" } } } }, plugins: { legend: { display: false }, tooltip: { bodyFont: { family: "'Vazirmatn', sans-serif" }, titleFont: { family: "'Vazirmatn', sans-serif" }, callbacks: { label: (c) => `${c.dataset.label}: ${formatNumber(c.raw)} مترمربع` } } } }
            });
        }
        
        function renderAreaComparisonChart(data) {
            const ctx = document.getElementById('areaComparisonChart').getContext('2d');
            const aggregatedData = data.reduce((acc, p) => ({ ...acc, [p.areaName]: (acc[p.areaName] || 0) + p.projectArea }), {});
            const labels = Object.keys(aggregatedData);
            const chartData = Object.values(aggregatedData);

            if (areaComparisonChart) areaComparisonChart.destroy();
            areaComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'مساحت کل عرصه', data: chartData, backgroundColor: 'rgba(34, 197, 94, 0.6)', borderColor: 'rgba(22, 163, 74, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { font: { family: "'Vazirmatn', sans-serif" } } }, y: { ticks: { font: { family: "'Vazirmatn', sans-serif" } } } }, plugins: { legend: { display: false }, tooltip: { bodyFont: { family: "'Vazirmatn', sans-serif" }, titleFont: { family: "'Vazirmatn', sans-serif" }, callbacks: { label: (c) => `${c.dataset.label}: ${formatNumber(c.raw)} مترمربع` } } } }
            });
        }
        
        function updateKpiCards(data) {
            const totalArea = data.reduce((s, p) => s + p.projectArea, 0);
            const totalBuiltArea = data.reduce((s, p) => s + p.proposedBuiltArea, 0);
            const projectsWithDensity = data.filter(p => p.proposedDensity);
            const avgDensity = projectsWithDensity.length > 0 ? projectsWithDensity.reduce((s, p) => s + p.proposedDensity, 0) / projectsWithDensity.length : 0;
            totalAreaCard.textContent = formatNumber(totalArea);
            totalBuiltAreaCard.textContent = formatNumber(totalBuiltArea);
            totalProjectsCard.textContent = formatNumber(data.length);
            avgDensityCard.textContent = `%${formatNumber(Math.round(avgDensity))}`;
        }

        function updateInputTooltipInfo(e) {
            const inputElement = e.currentTarget.querySelector('.area-input');
            const tooltipElement = e.currentTarget.querySelector('.tooltip-input');
            const projectId = parseInt(inputElement.dataset.id);
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            const currentTotalForArea = projects.filter(p => p.areaName === project.areaName).reduce((s, p) => s + p.projectArea, 0);
            const remainingArea = initialAreaTotals[project.areaName] - currentTotalForArea;
            tooltipElement.textContent = `مساحت باقی‌مانده از عرصه: ${formatNumber(remainingArea)} مترمربع`;
            tooltipElement.classList.remove('bg-red-600');
            tooltipElement.classList.add('bg-slate-700');
        }

        function handleAreaChange(e) {
            const inputElement = e.target;
            const tooltipElement = inputElement.parentElement.querySelector('.tooltip-input');
            const projectId = parseInt(inputElement.dataset.id);
            const newArea = parseInt(inputElement.value) || 0;
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            const oldArea = project.projectArea;
            const areaName = project.areaName;
            const initialTotalForArea = initialAreaTotals[areaName];
            const otherProjectsInAreaTotal = projects.filter(p => p.areaName === areaName && p.id !== projectId).reduce((s, p) => s + p.projectArea, 0);

            if (newArea < 0 || (newArea + otherProjectsInAreaTotal > initialTotalForArea)) {
                inputElement.value = oldArea;
                inputElement.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                tooltipElement.textContent = `خطا: مجموع مساحت از کل عرصه (${formatNumber(initialTotalForArea)}) بیشتر است.`;
                tooltipElement.classList.remove('bg-slate-700');
                tooltipElement.classList.add('bg-red-600');
                setTimeout(() => {
                    inputElement.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
                    updateInputTooltipInfo({ currentTarget: inputElement.parentElement });
                }, 2500);
                return;
            }
            project.projectArea = newArea;
            if (project.proposedDensity) project.proposedBuiltArea = Math.round(newArea * (project.proposedDensity / 100));
            applyFilters();
        }
        
        function applyFilters() {
            const areaValue = filterArea.value;
            const zoneValue = filterZone.value;
            const partnershipValue = filterPartnership.value;
            const usageValue = filterUsage.value;
            let filteredData = projects.filter(p => 
                (areaValue === 'all' || p.areaName === areaValue) &&
                (zoneValue === 'all' || p.zoneCode === zoneValue) &&
                (partnershipValue === 'all' || p.partnershipType === partnershipValue) &&
                (usageValue === 'all' || p.approvedUsage === usageValue)
            );
            // Sort data based on the custom order
            filteredData.sort(customSort);
            renderTable(filteredData);
            renderCharts(filteredData);
            updateKpiCards(filteredData);
        }

        function populateFilters() {
            ['filter-area', 'filter-zone', 'filter-partnership', 'filter-usage'].forEach(id => document.getElementById(id).innerHTML = '<option value="all">همه</option>');
            const areas = [...new Set(projects.map(p => p.areaName))];
            const zones = [...new Set(projects.map(p => p.zoneCode))];
            const partnerships = [...new Set(projects.map(p => p.partnershipType))];
            const usages = [...new Set(projects.map(p => p.approvedUsage))];
            areas.sort((a,b) => areaOrder.indexOf(a) - areaOrder.indexOf(b)).forEach(val => filterArea.innerHTML += `<option value="${val}">${val}</option>`);
            zones.forEach(val => filterZone.innerHTML += `<option value="${val}">${val}</option>`);
            partnerships.forEach(val => filterPartnership.innerHTML += `<option value="${val}">${val}</option>`);
            usages.forEach(val => filterUsage.innerHTML += `<option value="${val}">${val}</option>`);
        }
        
        function initializeDashboard() {
            // Sort the main data array initially
            projects.sort(customSort);
            
            initialAreaTotals = initialProjectsData.reduce((acc, p) => ({ ...acc, [p.areaName]: (acc[p.areaName] || 0) + p.projectArea }), {});
            populateFilters();
            applyFilters();
            [filterArea, filterZone, filterPartnership, filterUsage].forEach(f => f.addEventListener('change', applyFilters));
            resetButton.addEventListener('click', () => {
                projects = JSON.parse(JSON.stringify(initialProjectsData));
                projects.sort(customSort); // Re-sort after reset
                populateFilters();
                applyFilters();
            });

            // Event listeners for the detailed row tooltip
            tableBody.addEventListener('mouseover', e => {
                const row = e.target.closest('tr');
                if (!row || !row.dataset.details) return;
                
                const data = JSON.parse(row.dataset.details);
                const subProjectsList = data.subProjects.map(sp => `<li class="py-1">${sp}</li>`).join('');

                detailsTooltip.innerHTML = `
                    <h3 class="text-lg font-bold border-b border-slate-600 pb-2 mb-3">${data.projectName}</h3>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <span class="text-slate-400">سطح اشغال:</span> <span class="font-semibold">${formatNumber(data.proposedOccupancy)}%</span>
                        <span class="text-slate-400">طبقات:</span> <span class="font-semibold">${formatNumber(data.proposedFloors)}</span>
                        <span class="text-slate-400">تراکم:</span> <span class="font-semibold">${formatNumber(data.proposedDensity)}%</span>
                        <span class="text-slate-400">کد پهنه:</span> <span class="font-semibold">${data.zoneCode}</span>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-600">
                        <h4 class="font-semibold mb-2">اجزای پکیج:</h4>
                        <ul class="list-disc list-inside text-sm text-slate-300">${subProjectsList}</ul>
                    </div>
                `;
                detailsTooltip.style.visibility = 'visible';
                detailsTooltip.style.opacity = '1';
                detailsTooltip.style.transform = 'scale(1)';
            });

            tableBody.addEventListener('mousemove', e => {
                // Position tooltip slightly away from the cursor
                detailsTooltip.style.left = `${e.pageX + 15}px`;
                detailsTooltip.style.top = `${e.pageY + 15}px`;
            });

            tableBody.addEventListener('mouseout', e => {
                detailsTooltip.style.visibility = 'hidden';
                detailsTooltip.style.opacity = '0';
                detailsTooltip.style.transform = 'scale(0.95)';
            });
        }

        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
