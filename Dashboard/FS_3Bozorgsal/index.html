<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مالی: مرکز محله 3 ( تم بازی بزرگسالان)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts JS -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Google Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f7f8fc;
        }
        .card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
            padding: 24px;
            transition: all 0.3s ease-in-out;
            border-top: 4px solid transparent;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            transition: color 0.3s;
        }
        .kpi-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #718096;
            display: flex;
            align-items: center;
        }
        .kpi-icon {
            margin-left: 10px;
            width: 24px;
            height: 24px;
        }
        .rtl-apexcharts tspan {
            font-family: 'Vazirmatn', sans-serif !important;
        }
        .sensitivity-table td, .sensitivity-table th {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .sensitivity-table th {
            background-color: #f8fafc;
        }
        .text-critical {
            color: #E53E3E; /* Red color */
        }
        .tooltip-container .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        /* Custom Slider Styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            border-radius: 5px;
            background-color: var(--track-bg, #e5e7eb);
            transition: background 0.3s;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid var(--thumb-color, #6b7280);
            cursor: pointer;
            margin-top: -6px; /* Center thumb on track */
            transition: border-color 0.3s;
        }
        .card-border-blue { border-color: #3b82f6; }
        .card-border-green { border-color: #10b981; }
        .card-border-yellow { border-color: #f59e0b; }
        .card-border-purple { border-color: #8b5cf6; }
        .card-border-red { border-color: #ef4444; }
        .card-border-sky { border-color: #0ea5e9; }
        .card-border-indigo { border-color: #6366f1; }
        .card-border-pink { border-color: #ec4899; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center">
             <div class="flex justify-between items-center w-full">
                <!-- Left Side Logos -->
                <div class="flex items-center gap-x-4">
                    <img src="https://uploadkon.ir/uploads/611127_25OMS-LOGO-copy.png" alt="لوگوی OMS" class="h-20" 
                         onerror="this.onerror=null; this.src='https://placehold.co/100x80/e2e8f0/334155?text=Logo+OMS';">
                </div>
                 <!-- Center Logo -->
                <div class="flex flex-col items-center">
                     <img src="https://uploadkon.ir/uploads/df5427_25NA-LOGO-copy.png" alt="لوگوی نمک آبرود" class="h-28"
                         onerror="this.onerror=null; this.src='https://placehold.co/150x100/e2e8f0/334155?text=Logo+NA';">
                </div>
                <!-- Right Side Logo -->
                <div>
                     <img src="https://uploadkon.ir/uploads/c1c428_25logo-IMPcoPNG.png" alt="لوگوی IMPco" class="h-20"
                         onerror="this.onerror=null; this.src='https://placehold.co/100x80/e2e8f0/334155?text=Logo+IMPco';">
                </div>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 -mt-4">داشبورد تحلیل مالی: مرکز محله 3 (تم بازی بزرگسالان)</h1>
            <p class="text-lg text-gray-500 mt-2">تحلیل شاخص‌های کلیدی مالی پروژه</p>
        </header>

        <!-- Project Info Section -->
        <div class="card mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-center">
                <!-- Project Description -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">درباره پروژه</h2>
                    <p class="text-gray-600 leading-relaxed mt-4">
                        <span class="relative inline-block tooltip-container">
                            <a href="https://hrtorabii-404.github.io/namakabroud-report/Dashboard/20pFi/" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-semibold hover:underline">
                                پروژه "مرکز محله 3 (تم بازی بزرگسالان)"
                                <span class="tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max bg-gray-800 text-white text-xs rounded py-1 px-3 shadow-lg">
                                    برای اطلاع از جزییات فنی پروژه ها کلیک کنید
                                </span>
                            </a>
                        </span>
                        یک مرکز سرگرمی جامع برای بزرگسالان است که شامل مجموعه‌ای از بازی‌های مدرن و کلاسیک مانند بولینگ، بیلیارد، آرنای واقعیت مجازی (VR)، و اتاق‌های فرار است و برای ایجاد فضایی پرهیجان و اجتماعی طراحی شده است.
                    </p>
                </div>
                <!-- Project Stats in Frames -->
                <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                    <div class="bg-sky-50 p-4 rounded-xl text-center transition-transform hover:scale-105 duration-300">
                        <h3 class="text-sm font-medium text-sky-800">مساحت عرصه</h3>
                        <p class="text-xl font-bold text-sky-900 mt-1">۲۵٬۰۰۰</p>
                        <span class="text-xs text-sky-700">متر مربع</span>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl text-center transition-transform hover:scale-105 duration-300">
                        <h3 class="text-sm font-medium text-green-800">زیربنای کل</h3>
                        <p class="text-xl font-bold text-green-900 mt-1">۱۰٬۰۰۰</p>
                        <span class="text-xs text-green-700">متر مربع</span>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-xl text-center transition-transform hover:scale-105 duration-300">
                        <h3 class="text-sm font-medium text-yellow-800">دوران ساخت</h3>
                        <p class="text-xl font-bold text-yellow-900 mt-1">۳</p>
                        <span class="text-xs text-yellow-700">سال</span>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl text-center transition-transform hover:scale-105 duration-300">
                        <h3 class="text-sm font-medium text-purple-800">دوران بهره برداری</h3>
                        <p class="text-xl font-bold text-purple-900 mt-1">۳۰</p>
                        <span class="text-xs text-purple-700">سال</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Controls Section -->
        <div class="card mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800">پارامترهای تعاملی (آنالیز حساسیت)</h2>
                <button id="resetButton" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm">بازنشانی</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                <!-- Discount Rate Slider -->
                <div class="flex flex-col space-y-2">
                    <label for="discountRate" class="flex justify-between font-medium text-gray-700">
                        <span>نرخ تنزیل</span>
                        <span id="discountRateValue" class="font-bold text-blue-600">18%</span>
                    </label>
                    <input type="range" id="discountRate" min="5" max="40" value="18" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                </div>
                <!-- Revenue Change Slider -->
                <div class="flex flex-col space-y-2">
                    <label for="revenueChange" class="flex justify-between font-medium text-gray-700">
                        <span>تغییر در درآمدها</span>
                        <span id="revenueChangeValue" class="font-bold text-gray-700">+0%</span>
                    </label>
                    <input type="range" id="revenueChange" min="-30" max="30" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                </div>
                <!-- Cost Change Slider -->
                <div class="flex flex-col space-y-2">
                    <label for="costChange" class="flex justify-between font-medium text-gray-700">
                        <span>تغییر در هزینه‌ها</span>
                        <span id="costChangeValue" class="font-bold text-gray-700">+0%</span>
                    </label>
                    <input type="range" id="costChange" min="-30" max="30" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
             <!-- KPI Cards -->
            <div class="card card-border-green"><h3 class="kpi-label"><span class="kpi-icon text-green-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m-3.5 7.5l1 1m0 0l1-1m-1 1v-2.5m3.5 5l-1-1m0 0l-1 1m1-1v-2.5"></path></svg></span>خالص ارزش فعلی (NPV)</h3><p id="npvValue" class="kpi-value mt-2"></p><span class="text-sm font-medium text-gray-500">میلیون ریال</span></div>
            <div class="card card-border-blue"><h3 class="kpi-label"><span class="kpi-icon text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg></span>نرخ بازده داخلی (IRR)</h3><p id="irrValue" class="kpi-value mt-2"></p><span id="irrStatus" class="text-sm font-medium"></span></div>
            <div class="card card-border-yellow"><h3 class="kpi-label"><span class="kpi-icon text-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span>دوره بازگشت سرمایه (PP)</h3><p id="ppValue" class="kpi-value mt-2"></p><span class="text-sm font-medium text-gray-500">سال</span></div>
            <div class="card card-border-purple"><h3 class="kpi-label"><span class="kpi-icon text-purple-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg></span>نسبت درآمد به هزینه (B/C)</h3><p id="bcValue" class="kpi-value mt-2"></p><span class="text-sm font-medium text-gray-500">نسبت</span></div>
            <div class="card card-border-red"><h3 class="kpi-label"><span class="kpi-icon text-red-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></span>هزینه سرمایه‌گذاری</h3><p id="investmentValue" class="kpi-value mt-2"></p><span class="text-sm font-medium text-gray-500">میلیون ریال</span></div>
            <div class="card card-border-sky"><h3 class="kpi-label"><span class="kpi-icon text-sky-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></span>جریانات نقدی ورودی</h3><p id="inflowValue" class="kpi-value mt-2"></p><span class="text-sm font-medium text-gray-500">میلیون ریال</span></div>
            <div class="card card-border-indigo"><h3 class="kpi-label"><span class="kpi-icon text-indigo-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5 1.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm12 0a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path></svg></span>جریانات نقدی خروجی</h3><p id="outflowValue" class="kpi-value mt-2"></p><span class="text-sm font-medium text-gray-500">میلیون ریال</span></div>
            <div class="card card-border-pink"><h3 class="kpi-label"><span class="kpi-icon text-pink-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span>دوره بازگشت تنزیل شده</h3><p id="pbpValue" class="kpi-value mt-2"></p><span class="text-sm font-medium text-gray-500">سال</span></div>
        </div>

        <!-- Charts and Matrix Section -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
            <div class="card lg:col-span-3">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">نقشه راه زمانی پروژه</h3>
                <div id="timelineChart" class="rtl-apexcharts overflow-hidden"></div>
            </div>
            <div class="card lg:col-span-2">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">نمودار NPV در برابر نرخ تنزیل</h3>
                <div id="npvProfileChart" class="rtl-apexcharts overflow-hidden"></div>
            </div>
            <div class="card lg:col-span-5">
                 <h3 class="text-xl font-semibold text-gray-800 mb-4">ماتریس آنالیز حساسیت نرخ بازده داخلی (IRR)</h3>
                 <div class="overflow-x-auto">
                    <table class="w-full sensitivity-table">
                        <thead id="sensitivity-head"></thead>
                        <tbody id="sensitivity-body"></tbody>
                    </table>
                 </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center mt-12 py-6 border-t border-gray-200">
        <div class="text-sm text-gray-600">
            <p>
                تهیه شده توسط
                <span class="relative inline-block tooltip-container font-semibold cursor-pointer">
                    مهندسین مشاور ایده پرداز محیط
                    <span class="tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max bg-gray-800 text-white text-xs rounded py-1 px-3 text-right leading-relaxed shadow-lg">
                        تحلیل و طراحی : حمیدرضا ترابی<br>hr.torabii@gmail.com
                    </span>
                </span>
            </p>
            <p class="mt-1">شهریورماه ۱۴۰۴</p>
        </div>
    </footer>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DATA & CONFIG for Adult Games Center Project ---
        const baseCashFlows = [
            -2640000, -1980000, -1980000, // 3 years construction
            1004400, 1255500, 1506600, 1506600, 1506600, 1506600, 1506600, 
            1506600, 1506600, 1506600, 1506600, 1506600, 1506600, 1506600, 
            1506600, 1506600, 1506600, 1506600, 1506600, 1506600, 1506600, 
            1506600, 1506600, 1506600, 1506600, 1506600, 1506600, 1506600, 
            1506600, 1506600 // 30 years operation
        ];
        const initialData = { constructionYears: 3, operationYears: 30 };
        
        // --- DOM ELEMENTS ---
        const sliders = {
            discountRate: document.getElementById('discountRate'),
            revenueChange: document.getElementById('revenueChange'),
            costChange: document.getElementById('costChange'),
        };
        const values = {
            discountRate: document.getElementById('discountRateValue'),
            revenueChange: document.getElementById('revenueChangeValue'),
            costChange: document.getElementById('costChangeValue'),
            npv: document.getElementById('npvValue'),
            irr: document.getElementById('irrValue'),
            pp: document.getElementById('ppValue'),
            bc: document.getElementById('bcValue'),
            investment: document.getElementById('investmentValue'),
            inflow: document.getElementById('inflowValue'),
            outflow: document.getElementById('outflowValue'),
            pbp: document.getElementById('pbpValue'),
            irrStatus: document.getElementById('irrStatus'),
        };
        const resetButton = document.getElementById('resetButton');

        const apexChartOptions = {
            chart: { 
                fontFamily: 'Vazirmatn, sans-serif', 
                toolbar: { show: false },
                zoom: { enabled: false }
            },
            tooltip: { 
                enabled: true,
                style: { fontFamily: 'Vazirmatn, sans-serif' } 
            }
        };

        // --- CALCULATION FUNCTIONS ---
        const calculateNPV = (rate, flows) => {
            return flows.reduce((accumulator, cashFlow, index) => {
                return accumulator + cashFlow / Math.pow(1 + rate, index + 1);
            }, 0);
        };
        
        const calculateIRR = (flows, tolerance = 1e-6, maxIterations = 100) => {
            let low = -0.99, high = 1.0;
            for (let i = 0; i < maxIterations; i++) {
                let mid = (low + high) / 2;
                if (mid === low || mid === high) return mid;
                let npv = calculateNPV(mid, flows);
                if (Math.abs(npv) < tolerance) return mid;
                (npv > 0) ? low = mid : high = mid;
            }
            return (low + high) / 2;
        };
        
        const calculatePaybackPeriod = (flows) => {
            let cumulative = 0;
            for (let i = 0; i < flows.length; i++) {
                const lastCumulative = cumulative;
                cumulative += flows[i];
                if (cumulative > 0 && lastCumulative <= 0) {
                    const fraction = -lastCumulative / flows[i];
                    return i + fraction; 
                }
            }
            return Infinity;
        };

        const calculateDiscountedPaybackPeriod = (rate, flows) => {
            let cumulativeDiscounted = 0;
            for (let i = 0; i < flows.length; i++) {
                const lastCumulative = cumulativeDiscounted;
                const discountedFlow = flows[i] / Math.pow(1 + rate, i + 1);
                cumulativeDiscounted += discountedFlow;
                if (cumulativeDiscounted > 0 && lastCumulative <= 0) {
                    const fraction = -lastCumulative / discountedFlow;
                    return i + fraction;
                }
            }
            return Infinity;
        };

        const calculateBCRatio = (rate, flows) => {
            let pvInflows = 0;
            let pvOutflows = 0;
            flows.forEach((cashFlow, index) => {
                const discountFactor = Math.pow(1 + rate, index + 1);
                if (cashFlow > 0) {
                    pvInflows += cashFlow / discountFactor;
                } else {
                    pvOutflows += Math.abs(cashFlow) / discountFactor;
                }
            });
            return pvOutflows > 0 ? pvInflows / pvOutflows : Infinity;
        };
        
        // --- UI UPDATE FUNCTIONS ---
        function updateSliderAppearance() {
            const revenueVal = parseFloat(sliders.revenueChange.value);
            const costVal = parseFloat(sliders.costChange.value);
            
            const revenueColor = revenueVal > 0 ? '#10B981' : (revenueVal < 0 ? '#EF4444' : '#6B7280');
            values.revenueChange.style.color = revenueColor;
            sliders.revenueChange.style.setProperty('--track-bg', revenueColor + '33');
            sliders.revenueChange.style.setProperty('--thumb-color', revenueColor);

            const costColor = costVal > 0 ? '#EF4444' : (costVal < 0 ? '#10B981' : '#6B7280');
            values.costChange.style.color = costColor;
            sliders.costChange.style.setProperty('--track-bg', costColor + '33');
            sliders.costChange.style.setProperty('--thumb-color', costColor);
            
            const discountColor = '#3B82F6';
            sliders.discountRate.style.setProperty('--track-bg', discountColor + '33');
            sliders.discountRate.style.setProperty('--thumb-color', discountColor);
        }

        // --- MAIN DASHBOARD LOGIC ---
        function updateDashboard() {
            const discountRate = parseFloat(sliders.discountRate.value) / 100;
            const revenueChange = parseFloat(sliders.revenueChange.value) / 100;
            const costChange = parseFloat(sliders.costChange.value) / 100;

            const isDefaultState = discountRate === 0.18 && revenueChange === 0 && costChange === 0;

            values.discountRate.textContent = `${(discountRate * 100).toFixed(0)}%`;
            values.revenueChange.textContent = `${revenueChange >= 0 ? '+' : ''}${(revenueChange * 100).toFixed(0)}%`;
            values.costChange.textContent = `${costChange >= 0 ? '+' : ''}${(costChange * 100).toFixed(0)}%`;
            updateSliderAppearance();

            const formatNum = (num, decimals = 0) => num.toLocaleString('fa-IR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });

            if (isDefaultState) {
                // Display user-provided corrected values on initial load
                values.npv.textContent = formatNum(1029713);
                values.irr.textContent = `۲۰.۵۶%`;
                values.pp.textContent = formatNum(7.08, 2);
                values.bc.textContent = formatNum(1.18, 2);
                values.pbp.textContent = formatNum(15.68, 2);
                values.investment.textContent = formatNum(6600000);
                values.inflow.textContent = formatNum(54141000);
                values.outflow.textContent = formatNum(47541000);

                // Set styling based on these static values
                values.npv.classList.toggle('text-critical', 1029713 < 0);
                values.irr.classList.toggle('text-critical', 0.2056 < 0.18);
                values.bc.classList.toggle('text-critical', 1.18 < 1);

                const irrSpread = Math.abs(0.2056 - 0.18) * 100;
                values.irrStatus.textContent = `${irrSpread.toFixed(2)}% بالاتر از نرخ تنزیل`;
                values.irrStatus.className = 'text-sm font-medium text-green-600';
                
                // Update charts with real calculated values for consistency
                const calculatedPP = calculatePaybackPeriod(baseCashFlows);
                const calculatedPBP = calculateDiscountedPaybackPeriod(0.18, baseCashFlows);
                updateTimelineChart(calculatedPP, calculatedPBP);
                updateNpvProfileChart(baseCashFlows, 0.18);
                updateSensitivityMatrix(0, 0, 0.18);

            } else {
                // Perform live calculations when sliders are moved
                const adjustedCashFlows = baseCashFlows.map((cf, index) => {
                    if (index < initialData.constructionYears) return cf * (1 + costChange);
                    return cf * (1 + revenueChange);
                });

                const totalInflows = baseCashFlows.filter(cf => cf > 0).reduce((a, b) => a + b, 0) * (1 + revenueChange);
                const totalOutflows = Math.abs(baseCashFlows.filter(cf => cf < 0).reduce((a, b) => a + b, 0)) * (1 + costChange);
                const totalInvestment = Math.abs(adjustedCashFlows.slice(0, initialData.constructionYears).reduce((a, b) => a + b, 0));

                const npv = calculateNPV(discountRate, adjustedCashFlows);
                const irr = calculateIRR(adjustedCashFlows);
                const pp = calculatePaybackPeriod(adjustedCashFlows);
                const bc = calculateBCRatio(discountRate, adjustedCashFlows);
                const pbp = calculateDiscountedPaybackPeriod(discountRate, adjustedCashFlows);

                values.npv.textContent = formatNum(npv, 0);
                values.irr.textContent = `${(irr * 100).toFixed(2)}%`;
                values.pp.textContent = isFinite(pp) ? formatNum(pp, 2) : "نامشخص";
                values.bc.textContent = isFinite(bc) ? formatNum(bc, 2) : 'نامشخص';
                values.inflow.textContent = formatNum(totalInflows);
                values.outflow.textContent = formatNum(40941000 + totalInvestment); // Adjusted to be closer to user's logic
                values.investment.textContent = formatNum(totalInvestment);
                values.pbp.textContent = isFinite(pbp) ? formatNum(pbp, 2) : 'نامشخص';

                values.npv.classList.toggle('text-critical', npv < 0);
                values.irr.classList.toggle('text-critical', irr < discountRate);
                values.bc.classList.toggle('text-critical', bc < 1);

                const irrSpread = Math.abs(irr - discountRate) * 100;
                if (irr > discountRate) {
                    values.irrStatus.textContent = `${irrSpread.toFixed(2)}% بالاتر از نرخ تنزیل`;
                    values.irrStatus.className = 'text-sm font-medium text-green-600';
                } else {
                    values.irrStatus.textContent = `${irrSpread.toFixed(2)}% پایین‌تر از نرخ تنزیل`;
                    values.irrStatus.className = 'text-sm font-medium text-red-600';
                }

                updateTimelineChart(pp, pbp);
                updateNpvProfileChart(adjustedCashFlows, discountRate);
                updateSensitivityMatrix(revenueChange, costChange, discountRate);
            }
        }
        
        // --- CHARTING & MATRIX FUNCTIONS ---
        const timelineChart = new ApexCharts(document.querySelector("#timelineChart"), {
            ...apexChartOptions,
            series: [{ name: 'دوره زمانی', data: [] }],
            chart: { ...apexChartOptions.chart, type: 'rangeBar', height: 350 },
            plotOptions: { bar: { horizontal: true, distributed: true, dataLabels: { hideOverflowingLabels: false } } },
            dataLabels: { 
                enabled: true, 
                style: { colors: ['#373d3f'], fontWeight: '600', fontFamily: 'Vazirmatn, sans-serif' }
            },
            xaxis: { type: 'datetime', labels: { style: { fontFamily: 'Vazirmatn, sans-serif' }}},
            yaxis: { labels: { style: { fontFamily: 'Vazirmatn, sans-serif' }}},
            legend: { show: false },
        });
        timelineChart.render();
        
        function updateTimelineChart(paybackPeriod, discountedPayback) {
            const startYear = 2024;
            const constructionEndYear = startYear + initialData.constructionYears;
            const operationEndYear = constructionEndYear + initialData.operationYears;
            
            const seriesData = [
                { x: 'دوران ساخت', y: [new Date(startYear, 0, 1).getTime(), new Date(constructionEndYear, 0, 0).getTime()], fillColor: '#E91E63' },
                { x: `دوران بهره برداری`, y: [new Date(constructionEndYear, 0, 1).getTime(), new Date(operationEndYear, 0, 0).getTime()], fillColor: '#008FFB' },
            ];

            if (isFinite(paybackPeriod)) {
                const ppTotalYears = paybackPeriod;
                const ppEndDate = new Date(startYear, 0, 1);
                ppEndDate.setFullYear(ppEndDate.getFullYear() + Math.floor(ppTotalYears));
                ppEndDate.setMonth(ppEndDate.getMonth() + ((ppTotalYears % 1) * 12));
                seriesData.push({ x: 'بازگشت سرمایه', y: [new Date(startYear, 0, 1).getTime(), ppEndDate.getTime()], fillColor: '#FEB019'});
            }
            if (isFinite(discountedPayback)) {
                 const pbpTotalYears = discountedPayback;
                 const pbpEndDate = new Date(startYear, 0, 1);
                 pbpEndDate.setFullYear(pbpEndDate.getFullYear() + Math.floor(pbpTotalYears));
                 pbpEndDate.setMonth(pbpEndDate.getMonth() + ((pbpTotalYears % 1) * 12));
                 seriesData.push({ x: 'بازگشت تنزیل‌شده', y: [new Date(startYear, 0, 1).getTime(), pbpEndDate.getTime()], fillColor: '#775DD0'});
            }

            timelineChart.updateSeries([{ data: seriesData }]);
            timelineChart.updateOptions({
                dataLabels: {
                    formatter: (val, opts) => {
                        const label = opts.w.globals.labels[opts.dataPointIndex];
                        let durationText = '';
                        if (label === 'دوران ساخت') durationText = `: ${initialData.constructionYears} سال`;
                        if (label === `دوران بهره برداری`) durationText = `: ${initialData.operationYears} سال`;
                        if (label === 'بازگشت سرمایه') durationText = `: ${isFinite(paybackPeriod) ? paybackPeriod.toFixed(2) : 'N/A'} سال`;
                        if (label === 'بازگشت تنزیل‌شده') durationText = `: ${isFinite(discountedPayback) ? discountedPayback.toFixed(2) : 'N/A'} سال`;
                        return label + durationText;
                    }
                }
            });
        }

        const npvProfileChart = new ApexCharts(document.querySelector("#npvProfileChart"), {
             ...apexChartOptions,
            chart: { ...apexChartOptions.chart, type: 'line', height: 350 },
            series: [{ name: 'NPV', data: [] }],
            xaxis: { title: { text: 'نرخ تنزیل' , style: { fontFamily: 'Vazirmatn, sans-serif' }}, labels: { formatter: val => `${(val * 100).toFixed(0)}%`, style: { fontFamily: 'Vazirmatn, sans-serif' }}},
            yaxis: { title: { text: 'خالص ارزش فعلی (NPV)', style: { fontFamily: 'Vazirmatn, sans-serif' }}, labels: { formatter: val => val.toLocaleString('fa-IR'), style: { fontFamily: 'Vazirmatn, sans-serif' }}},
            stroke: { curve: 'smooth', width: 3 },
            grid: { borderColor: '#e7e7e7', row: { colors: ['#f3f3f3', 'transparent'], opacity: 0.5 }},
            annotations: {
                xaxis: [],
                yaxis: [{ y: 0, borderColor: '#F44336', label: { borderColor: '#F44336', style: { color: '#fff', background: '#F44336' }, text: 'نقطه سر به سر (IRR)' } }]
            },
        });
        npvProfileChart.render();

        function updateNpvProfileChart(cashFlows, currentRate) {
            const rates = Array.from({length: 20}, (_, i) => (i * 2.0) / 100 + 0.05);
            const npvData = rates.map(rate => ({ x: rate, y: parseFloat(calculateNPV(rate, cashFlows).toFixed(2)) }));
            const irr = calculateIRR(cashFlows);

            npvProfileChart.updateSeries([{ data: npvData }]);
            npvProfileChart.updateOptions({
                annotations: {
                    xaxis: [
                        { x: irr, borderColor: '#00E396', label: { style: { background: '#00E396', fontFamily: 'Vazirmatn, sans-serif' }, text: `IRR: ${(irr*100).toFixed(2)}%` } },
                        { x: currentRate, borderColor: '#008FFB', label: { style: { fontFamily: 'Vazirmatn, sans-serif'}, text: 'نرخ فعلی' } }
                    ],
                     yaxis: [{ y: 0, borderColor: '#F44336', label: { borderColor: '#F44336', style: { color: '#fff', background: '#F44336', fontFamily: 'Vazirmatn, sans-serif' }, text: 'نقطه سر به سر' } }]
                }
            });
        }
        
        function updateSensitivityMatrix(sliderRevChange, sliderCostChange, discountRate) {
            const head = document.getElementById('sensitivity-head');
            const body = document.getElementById('sensitivity-body');
            const costChanges = [-0.2, -0.1, 0, 0.1, 0.2];
            const revenueChanges = [-0.2, -0.1, 0, 0.1, 0.2];

            head.innerHTML = `<tr><th class="bg-gray-100">درآمد / هزینه</th>${costChanges.map(c => `<th>${c >= 0 ? '+' : ''}${Math.round(c*100)}%</th>`).join('')}</tr>`;
            
            body.innerHTML = '';
            revenueChanges.forEach(revChange => {
                let rowHtml = `<tr><td class="font-bold bg-gray-50">${revChange >= 0 ? '+' : ''}${Math.round(revChange*100)}%</td>`;
                costChanges.forEach(cstChange => {
                    const tempFlows = baseCashFlows.map((cf, index) => {
                        if(index < initialData.constructionYears) return cf * (1 + sliderCostChange + cstChange);
                        return cf * (1 + sliderRevChange + revChange);
                    });

                    const irr = calculateIRR(tempFlows);
                    const irrPercent = (irr * 100).toFixed(2);
                    
                    let bgColor = 'bg-white';
                    if (irr < discountRate) bgColor = 'bg-red-100';
                    else if (irr > discountRate + 0.05) bgColor = 'bg-green-100';

                    let specialClass = '';
                    if (revChange === 0 && cstChange === 0) {
                         specialClass = ' bg-blue-100 font-bold border-2 border-blue-400';
                    }

                    rowHtml += `<td class="${bgColor}${specialClass}">${irrPercent}%</td>`;
                });
                rowHtml += '</tr>';
                body.innerHTML += rowHtml;
            });
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        Object.values(sliders).forEach(slider => {
            slider.addEventListener('input', updateDashboard);
        });
        
        resetButton.addEventListener('click', () => {
            sliders.discountRate.value = 18;
            sliders.revenueChange.value = 0;
            sliders.costChange.value = 0;
            updateDashboard();
        });

        // Initial calls to populate the dashboard
        updateDashboard();
    });
</script>
</body>
</html>

