<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد جامع راهبری مالی و اجرایی نمک‌آبرود | افق ۱۴۰۵-۱۴۰۹</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f4f7f9; color: #0f172a; overflow-x: hidden; }
        
        /* Tooltips */
        .has-tooltip { position: relative; cursor: help; display: inline-flex; align-items: center; }
        .custom-tooltip { visibility: hidden; position: absolute; top: 130%; right: 50%; transform: translateX(50%); width: 240px; background: #0f172a; color: white; border-radius: 8px; padding: 12px; font-size: 0.75rem; text-align: justify; opacity: 0; transition: 0.3s ease; pointer-events: none; z-index: 99999; line-height: 1.6; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); font-weight: normal; }
        .custom-tooltip::before { content: ""; position: absolute; bottom: 100%; right: 50%; margin-right: -6px; border-width: 6px; border-style: solid; border-color: transparent transparent #0f172a transparent; }
        .has-tooltip:hover .custom-tooltip { visibility: visible; opacity: 1; top: 140%; }
        
        /* Premium Neumorphic KPI Cards with FontAwesome Watermark */
        .kpi-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; z-index: 1; cursor: default; }
        .kpi-card::before { content: ''; position: absolute; inset: 0; border-radius: 1.25rem; padding: 2px; background: transparent; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; transition: background 0.4s; z-index: -1; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1); }
        .kpi-card.hover-blue:hover::before { background: linear-gradient(135deg, transparent, #3b82f6, transparent); }
        .kpi-card.hover-green:hover::before { background: linear-gradient(135deg, transparent, #10b981, transparent); }
        .kpi-card.hover-amber:hover::before { background: linear-gradient(135deg, transparent, #f59e0b, transparent); }
        
        /* Modern FontAwesome Watermark Icons */
        .watermark-icon { position: absolute; left: -1.5rem; bottom: -2rem; font-size: 8rem; opacity: 0.04; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; z-index: 0; }
        .kpi-card:hover .watermark-icon { opacity: 0.15; transform: scale(1.15) rotate(-15deg); }

        /* Smooth Accordion Magic */
        .accordion-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.4s ease-in-out; }
        .accordion-wrapper.open { grid-template-rows: 1fr; }
        .accordion-inner { overflow: hidden; }

        /* Graphical Table Styles */
        .graphical-table th { padding: 12px 8px; font-weight: 800; font-size: 0.75rem; }
        .graphical-table td { padding: 12px 8px; font-size: 0.85rem; border-top: 1px solid #f1f5f9; }

        /* Swimlanes & Kanban Modernized */
        .lane-wrapper { transition: all 0.3s ease; border-right: 4px solid transparent; }
        .lane-wrapper:hover { border-right-color: #cbd5e1; }
        .drop-zone-active { background-color: #f8fafc !important; border: 2px dashed #3b82f6 !important; border-right-color: #3b82f6 !important; }
        
        /* Modern Project Card Widget */
        .project-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: grab; display: flex; align-items: stretch; position: relative; overflow: hidden; }
        .project-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.08); z-index: 10; border-color: #cbd5e1; }
        .project-card:active { cursor: grabbing; transform: scale(0.96); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); z-index: 50; }
        .grip-handle { display: flex; flex-direction: column; justify-content: center; padding: 0 8px; color: #94a3b8; cursor: grab; background: #f8fafc; border-right: 1px solid #f1f5f9; transition: background 0.2s; }
        
        /* Phase Dots & Progress */
        .phase-dots { display: flex; gap: 3px; width: 100%; }
        .phase-dot { height: 4px; border-radius: 2px; flex: 1; background-color: #e2e8f0; }
        .phase-dot.active { background-color: var(--accent-color); }
        .prog-container { width: 100%; height: 8px; background-color: #e2e8f0; border-radius: 4px; overflow: hidden; display: flex; }
        .prog-fill { height: 100%; transition: width 0.4s ease, background-color 0.4s ease; }
        .prog-overflow { height: 100%; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 5px, #fca5a5 5px, #fca5a5 10px); transition: width 0.4s ease; }

        /* UI Controls */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #cbd5e1; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 20px; width: 20px; border-radius: 50%; background: #0f172a; cursor: pointer; -webkit-appearance: none; margin-top: -7px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; position: relative; z-index: 10; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .housing-slider::-webkit-slider-thumb { background: #10b981 !important; }

        /* Sidebar & Layout */
        .sidebar-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); transition: opacity 0.3s; z-index: 40; }
        .dimmed { opacity: 0.3; filter: grayscale(70%); transition: all 0.4s; pointer-events: none; }
        .focused { transform: scale(1.01); box-shadow: 0 0 0 2px #3b82f6; z-index: 20; border-color: transparent; }

        /* Roadmap Capsules */
        .roadmap-line { position: absolute; top: 20px; left: 0; right: 0; height: 3px; background: #e2e8f0; z-index: 0; }
        .roadmap-node { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; width: 20%; }
        .roadmap-dot { width: 16px; height: 16px; border-radius: 50%; background: white; border: 3px solid #3b82f6; box-shadow: 0 0 0 4px #eff6ff; margin-bottom: 12px; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="p-0 text-slate-800 flex flex-col min-h-screen">

    <header class="w-full bg-white shadow-[0_4px_20px_-10px_rgba(0,0,0,0.1)] border-b-4 border-b-sky-600 p-4 md:py-5 md:px-8 flex flex-col md:flex-row justify-between items-center z-50 relative">
        <div class="w-1/3 flex justify-start mb-4 md:mb-0">
            <img src="https://uploadkon.ir/uploads/c1c428_25logo-IMPcoPNG.png" alt="بنیاد مستضعفان" class="h-12 md:h-16 object-contain hover:scale-105 transition-transform duration-300">
        </div>
        <div class="w-full md:w-1/3 text-center mb-4 md:mb-0">
            <img src="https://uploadkon.ir/uploads/df5427_25NA-LOGO-copy.png" alt="نمک آبرود" class="h-16 md:h-24 object-contain mx-auto mb-2 drop-shadow-md hover:scale-105 transition-transform duration-300">
            <h1 class="text-xl md:text-2xl font-black text-slate-800 tracking-tight">داشبورد جامع راهبری مالی و اجرایی</h1>
            <p class="text-[11px] md:text-sm text-slate-500 font-bold mt-1 tracking-wide">هوش تجاری و شبیه‌ساز استراتژیک پروژه‌ها</p>
            <div class="h-0.5 w-16 md:w-24 bg-sky-500 mx-auto mt-2 rounded-full"></div>
        </div>
        <div class="w-1/3 flex justify-end">
            <img src="https://uploadkon.ir/uploads/611127_25OMS-LOGO-copy.png" alt="عمران و مسکن" class="h-10 md:h-14 object-contain hover:scale-105 transition-transform duration-300">
        </div>
    </header>

    <div id="settingsOverlay" class="fixed inset-0 overlay hidden xl:hidden" onclick="toggleSettings()"></div>
    
    <div class="w-full max-w-[1650px] mx-auto flex flex-col xl:flex-row gap-6 items-start relative px-4 md:px-6 py-6 flex-1">
        
        <aside id="settingsSidebar" class="sidebar-panel fixed inset-y-0 right-0 w-80 bg-white z-50 transform translate-x-full overflow-y-auto custom-scrollbar shadow-2xl xl:shadow-none xl:translate-x-0 xl:static xl:w-[22%] xl:bg-transparent xl:block xl:sticky xl:top-6 xl:h-[calc(100vh-2rem)]">
            <div class="p-5 xl:p-0">
                <div class="flex justify-between items-center xl:hidden mb-6 border-b pb-3">
                    <h2 class="font-black text-lg text-slate-800">پنل تنظیمات و اهرم‌ها</h2>
                    <button onclick="toggleSettings()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="space-y-5 pb-10">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                        <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-3">
                            <h3 class="font-black text-slate-800 flex items-center text-sm">
                                <span class="w-1.5 h-5 bg-sky-500 rounded-sm ml-2"></span>تنظیمات کلان
                            </h3>
                            <button onclick="resetAll()" class="text-[10px] font-bold text-slate-500 hover:text-sky-600 bg-slate-50 px-2 py-1 rounded border border-slate-200 transition-colors">بازنشانی</button>
                        </div>
                        <p class="text-[10px] text-slate-400 mb-5 leading-relaxed text-justify">
                            این بخش کنترل‌گر اصلی منابع مالی شماست. با تغییر این اهرم‌ها، ظرفیت بودجه مجاز برای هزینه‌های زیرساختی به صورت زنده محاسبه می‌شود.
                        </p>
                        
                        <div class="mb-5">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold text-slate-600">رشد گردشگری</span>
                                <span id="val-inflation" class="font-black text-sky-600 bg-sky-50 px-1.5 rounded">35%</span>
                            </div>
                            <input type="range" id="sl-inflation" min="20" max="60" value="35">
                            <p class="text-[9px] text-slate-400 mt-1">رشد سالانه درآمدهای گردشگری ناشی از تورم و افزایش تعرفه.</p>
                        </div>

                        <div class="mb-5">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold text-slate-600">ضریب تحقق پروژه‌ها</span>
                                <span id="val-realization" class="font-black text-sky-600 bg-sky-50 px-1.5 rounded">100%</span>
                            </div>
                            <input type="range" id="sl-realization" min="50" max="100" value="100">
                            <p class="text-[9px] text-slate-400 mt-1">ضریب اطمینان و شبیه‌ساز تأخیر در پیش‌فروش مسکونی.</p>
                        </div>

                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold text-slate-600">سهم مجاز زیرساخت</span>
                                <span id="val-infrashare" class="font-black text-sky-600 bg-sky-50 px-1.5 rounded">30%</span>
                            </div>
                            <input type="range" id="sl-infrashare" min="10" max="50" value="30">
                            <p class="text-[9px] text-slate-400 mt-1 leading-relaxed">درصد پولی که مجازید از کل درآمدها صرف زیرساخت‌های شهرک کنید.</p>
                        </div>
                    </div>

                    <div class="bg-slate-800 text-white rounded-2xl shadow-lg relative border border-slate-700 z-50">
                        <div class="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none z-0">
                            <div class="absolute -right-12 -top-12 w-32 h-32 bg-emerald-500 rounded-full blur-[50px] opacity-30"></div>
                        </div>
                        
                        <div class="p-5 relative z-10">
                            <div class="flex flex-col mb-4">
                                <h3 class="font-black text-sm flex items-center mb-1.5">
                                    <span class="w-1.5 h-5 bg-emerald-400 rounded-sm ml-2"></span>تخصیص مسکونی
                                </h3>
                                <p class="text-[10px] text-slate-400 leading-relaxed pr-3 text-justify">درصد تخصیص و پیش‌فروش در هر سال. سیستم روی ۱۰۰٪ قفل است تا از خطای محاسباتی جلوگیری شود.</p>
                            </div>
                            
                            <div class="mb-5 bg-slate-900/50 p-3 rounded-lg border border-slate-600">
                                <div class="flex justify-between text-[10px] mb-2 font-bold text-slate-300">
                                    <span>مجموع: <b id="val-total-alloc" class="text-emerald-400 text-xs">60%</b></span>
                                    <span>آزاد: <b id="val-free-alloc" class="text-white text-xs">40%</b></span>
                                </div>
                                <div class="w-full bg-slate-700 rounded-full h-1.5 flex overflow-hidden">
                                    <div id="bar-alloc" class="bg-emerald-400 h-full transition-all duration-300" style="width: 60%"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-x-4 gap-y-4" id="housing-sliders-container"></div>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="w-full xl:w-[78%] flex flex-col gap-6 z-10">
                
                <section class="bg-gradient-to-l from-slate-800 to-slate-700 text-white p-5 md:p-6 rounded-2xl relative overflow-hidden shadow-lg">
                    <div class="absolute -right-20 -top-20 w-64 h-64 bg-sky-500 rounded-full blur-[80px] opacity-20 pointer-events-none"></div>
                    <div class="relative z-10 flex flex-col md:flex-row gap-5 items-start">
                        <div class="bg-white/10 p-4 rounded-2xl shrink-0 backdrop-blur-sm hidden md:block border border-white/10">
                            <i class="fa-solid fa-layer-group text-sky-400 text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-lg md:text-xl font-black mb-2 text-sky-300">راهنمای داشبورد: از داده تا تصمیم</h2>
                            <p class="text-[11px] md:text-sm leading-relaxed text-slate-300 text-justify">
                                این داشبورد استراتژیک برای مدل‌سازی سناریوهای مالی مگاپروژه‌های نمک‌آبرود (۱۴۰۵-۱۴۰۹) طراحی شده است.<br>
                                <b>۱. خلق درآمد:</b> ترکیبی از گردشگری و مسکونی است که با اهرم‌های تنظیمات قابل شبیه‌سازی است.<br>
                                <b>۲. بودجه مجاز:</b> بر اساس قوانین بالادستی، سقف بودجه توسعه زیرساخت‌ها معادل <b class="text-white">۳۰٪ از کل سود/درآمدها</b> است.
                            </p>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="kpi-container">
                    
                    <div class="kpi-card hover-blue p-5 group">
                        <i class="fa-solid fa-sack-dollar watermark-icon text-sky-500"></i>
                        <div class="relative z-10">
                            <p class="text-[11px] font-bold text-slate-500 uppercase mb-4" id="lbl-kpi-1">درآمد کل پیش‌بینی شده ۵ ساله</p>
                            <p class="text-3xl font-black text-slate-800 mb-1 transition-colors group-hover:text-sky-600" id="kpi-total-revenue">0 <span class="text-sm font-bold text-slate-400">همت</span></p>
                            <p class="text-[10px] text-slate-500 font-medium" id="sub-kpi-1">مجموع درآمدهای مسکونی و گردشگری</p>
                        </div>
                    </div>

                    <div class="kpi-card hover-green p-5 group">
                        <i class="fa-solid fa-vault watermark-icon text-emerald-500"></i>
                        <div class="relative z-10">
                            <p class="text-[11px] font-bold text-slate-500 uppercase mb-4" id="lbl-kpi-2">بودجه مجاز زیرساخت (۳۰٪)</p>
                            <p class="text-3xl font-black text-slate-800 mb-1 transition-colors group-hover:text-emerald-600" id="kpi-infra-budget">0 <span class="text-sm font-bold text-slate-400 group-hover:text-emerald-400">همت</span></p>
                            <p class="text-[10px] text-slate-500 font-medium" id="kpi-infra-sub">سقف مالی مجاز مصوب بنیاد</p>
                        </div>
                    </div>

                    <div class="kpi-card hover-amber p-5 group">
                        <i class="fa-solid fa-chart-pie watermark-icon text-amber-500"></i>
                        <div class="relative z-10">
                            <p class="text-[11px] font-bold text-slate-500 uppercase mb-4" id="lbl-kpi-3">برآورد هزینه کل پروژه‌ها</p>
                            <p class="text-3xl font-black text-slate-800 mb-1 transition-colors group-hover:text-amber-600" id="kpi-used">0 <span class="text-sm font-bold text-slate-400 group-hover:text-amber-400">همت</span></p>
                            <p class="text-[10px] text-slate-500 font-medium" id="sub-kpi-3">مجموع هزینه‌های فازبندی شده</p>
                        </div>
                    </div>

                    <div class="kpi-card p-5 group" id="kpi-balance-card">
                        <i class="fa-solid fa-scale-balanced watermark-icon transition-all duration-300" id="kpi-balance-watermark"></i>
                        <div class="relative z-10">
                            <p class="text-[11px] font-bold text-slate-500 uppercase mb-4" id="lbl-kpi-4">مانده نقدینگی نهایی</p>
                            <p class="text-3xl font-black mb-1" id="kpi-balance">0 <span class="text-sm font-bold">همت</span></p>
                            <p class="text-[10px] font-bold mt-1 text-slate-500" id="sub-kpi-4">نقدینگی رسوب‌کرده در پایان پروژه</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <button onclick="toggleAccordion()" class="w-full flex justify-between items-center p-4 md:p-5 bg-slate-50 hover:bg-slate-100 transition-colors focus:outline-none">
                        <span class="text-sm md:text-base font-black text-slate-800 flex items-center">
                            <span class="w-1.5 h-5 bg-emerald-500 rounded-sm ml-2"></span>
                            جدول و نمودار گرافیکی جریان نقدی کل (۱۴۰۴ تا ۱۴۰۹)
                        </span>
                        <div class="bg-white p-1 rounded shadow-sm border border-slate-200 text-slate-500">
                            <i id="accordion-arrow" class="fa-solid fa-chevron-down transform transition-transform duration-400 text-sm px-1"></i>
                        </div>
                    </button>
                    
                    <div id="accordion-content" class="accordion-wrapper">
                        <div class="accordion-inner">
                            <div class="border-t border-slate-200 p-4 md:p-6 bg-white">
                                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 items-center">
                                    
                                    <div class="overflow-x-auto w-full bg-white rounded-xl shadow-inner border border-slate-100">
                                        <table class="w-full text-center border-collapse graphical-table">
                                            <thead>
                                                <tr class="bg-gradient-to-l from-slate-50 to-slate-100 border-b border-slate-200 text-slate-500">
                                                    <th>سال</th>
                                                    <th class="text-purple-600">مسکونی</th>
                                                    <th class="text-rose-500">گردشگری</th>
                                                    <th class="bg-blue-50/50 text-blue-800 border-x border-slate-100">ظرفیت کل (۱۰۰٪)</th>
                                                    <th id="th-shareholder">سهم شرکا</th>
                                                    <th id="th-infra" class="bg-emerald-50/50 text-emerald-800 border-r border-slate-100">بودجه مجاز</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cash-flow-tbody" class="divide-y divide-slate-100 text-slate-700"></tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="h-64 w-full relative">
                                        <canvas id="cashFlowChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 md:p-6 overflow-x-auto custom-scrollbar">
                    <h3 class="text-sm font-black text-slate-800 mb-6 flex items-center">
                        <span class="w-1.5 h-4 bg-blue-500 rounded-sm ml-2"></span>نقشه راه توزیع مگاپروژه‌ها (پیش‌نیاز برنامه‌ریزی)
                    </h3>
                    <div class="relative min-w-[750px] py-4">
                        <div class="roadmap-line"></div>
                        <div class="flex justify-between relative z-10 w-full">
                            
                            <div class="roadmap-node">
                                <div class="roadmap-dot"></div>
                                <div class="text-[11px] font-bold text-slate-700 mb-3 bg-white px-3 py-0.5 rounded border border-slate-200 shadow-sm">سال ۱۴۰۵</div>
                                <div class="flex flex-col gap-2 items-center w-full px-2">
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-bridge text-emerald-500"></i> پل ورودی</span>
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-road text-slate-500"></i> معبر غربی</span>
                                </div>
                            </div>

                            <div class="roadmap-node">
                                <div class="roadmap-dot"></div>
                                <div class="text-[11px] font-bold text-slate-700 mb-3 bg-white px-3 py-0.5 rounded border border-slate-200 shadow-sm">سال ۱۴۰۶</div>
                                <div class="flex flex-col gap-2 items-center w-full px-2">
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-map-location-dot text-purple-500"></i> زیرساخت (فاز۱)</span>
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-truck-medical text-rose-500"></i> ابنیه خدماتی</span>
                                </div>
                            </div>

                            <div class="roadmap-node">
                                <div class="roadmap-dot"></div>
                                <div class="text-[11px] font-bold text-slate-700 mb-3 bg-white px-3 py-0.5 rounded border border-slate-200 shadow-sm">سال ۱۴۰۷</div>
                                <div class="flex flex-col gap-2 items-center w-full px-2">
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-water text-blue-500"></i> تصفیه (فاز۱)</span>
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-bolt text-amber-500"></i> نیروگاه (فاز۱)</span>
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-cloud-showers-heavy text-sky-500"></i> زهکشی (فاز۱)</span>
                                </div>
                            </div>

                            <div class="roadmap-node">
                                <div class="roadmap-dot"></div>
                                <div class="text-[11px] font-bold text-slate-700 mb-3 bg-white px-3 py-0.5 rounded border border-slate-200 shadow-sm">سال ۱۴۰۸</div>
                                <div class="flex flex-col gap-2 items-center w-full px-2">
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-water text-blue-500"></i> تصفیه (فاز۲)</span>
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-bolt text-amber-500"></i> نیروگاه (فاز۲)</span>
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-cloud-showers-heavy text-sky-500"></i> زهکشی (فاز۲)</span>
                                </div>
                            </div>

                            <div class="roadmap-node">
                                <div class="roadmap-dot"></div>
                                <div class="text-[11px] font-bold text-slate-700 mb-3 bg-white px-3 py-0.5 rounded border border-slate-200 shadow-sm">سال ۱۴۰۹</div>
                                <div class="flex flex-col gap-2 items-center w-full px-2">
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-water text-blue-500"></i> تصفیه (فاز۳)</span>
                                    <span class="text-[10px] bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 shadow-sm font-bold flex items-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition cursor-default w-full justify-center"><i class="fa-solid fa-bolt text-amber-500"></i> نیروگاه (فاز۳)</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div id="filter-banner" class="hidden bg-sky-600 text-white px-5 py-3 rounded-xl flex justify-between items-center shadow-md">
                    <span class="text-sm font-bold flex items-center"><i class="fa-solid fa-filter ml-2"></i><span id="filter-text">فیلتر اعمال شده</span></span>
                    <button onclick="clearFilter()" class="text-xs bg-white text-sky-700 font-bold px-3 py-1.5 rounded-lg shadow-sm hover:bg-slate-100 transition"><i class="fa-solid fa-xmark ml-1"></i>نمایش کل ۵ سال</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 p-5 md:p-6 relative">
                        <h3 class="text-base font-black text-slate-800 mb-1">روند بودجه در دسترس در برابر هزینه‌های پیش‌بینی شده</h3>
                        <p class="text-[10px] font-bold text-slate-400 mb-4 bg-slate-50 inline-block px-2 py-1 rounded">سال ۱۴۰۴ غیرقابل کلیک است. روی ستون‌های بعدی (۱۴۰۵ تا ۱۴۰۹) کلیک کنید.</p>
                        <div class="h-60 w-full"><canvas id="barChart"></canvas></div>
                    </div>
                    <div class="lg:col-span-1 bg-white rounded-2xl shadow-sm border border-slate-200 p-5 md:p-6 flex flex-col justify-center">
                        <h3 class="text-base font-black text-slate-800 mb-4 text-center">ساختار توزیع ۱۳ همت</h3>
                        <div class="h-48 relative">
                            <canvas id="donutChart"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <span class="text-[10px] font-bold text-slate-400">هزینه کل پروژه‌ها</span>
                                <span class="text-xl font-black text-slate-800">13,000</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 mb-10">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-slate-100 pb-4">
                        <div>
                            <h3 class="text-lg font-black text-slate-800 flex items-center">
                                <span class="w-2 h-6 bg-indigo-500 rounded-sm ml-2"></span>
                                شبیه‌ساز هوشمند پروژه‌ها (سطرهای سالانه)
                            </h3>
                            <p class="text-xs font-bold text-slate-500 mt-2"><i class="fa-solid fa-hand-pointer text-slate-300 ml-1"></i>کارت‌ها را گرفته و بین سطرهای افقیِ سال‌ها جابجا کنید. نوارهای وضعیت، به صورت زنده کسری/مازاد را نشان می‌دهند.</p>
                        </div>
                        <button onclick="resetProjects()" class="mt-3 md:mt-0 text-xs font-bold bg-slate-50 border border-slate-200 hover:bg-slate-100 hover:text-sky-600 text-slate-600 px-4 py-2 rounded-lg transition shadow-sm"><i class="fa-solid fa-rotate-left ml-1"></i>بازنشانی فازها</button>
                    </div>
                    <div class="flex flex-col gap-4" id="swimlane-board"></div>
                </div>

            </main>
        </div>

    <footer class="w-full bg-slate-800 text-slate-400 text-center py-5 text-xs font-medium relative z-[100] border-t border-slate-700">
        تهیه شده توسط 
        <span class="relative group cursor-pointer text-white font-bold inline-block mx-1">
            مهندسین مشاور ایده پرداز محیط
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-3 hidden group-hover:block bg-slate-900 text-white text-xs p-3 rounded-xl shadow-[0_10px_25px_-5px_rgba(0,0,0,0.5)] w-56 text-center border border-slate-600 transition-all z-[9999]">
                <p class="font-black text-sky-400 mb-1">تحلیل و طراحی:</p>
                <p class="font-bold text-base mb-1 text-white">حمیدرضا ترابی</p>
                <p class="text-slate-400 font-mono text-[10px]">hr.torabii@gmail.com</p>
                <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-slate-600"></div>
            </div>
        </span>
        - اسفند ماه ۱۴۰۴
    </footer>

    <button onclick="toggleSettings()" class="xl:hidden fixed bottom-6 left-6 z-40 bg-sky-600 text-white p-4 rounded-full shadow-[0_10px_20px_rgba(2,132,199,0.4)] hover:bg-sky-700 transition transform hover:scale-105 flex items-center gap-2">
        <i class="fa-solid fa-sliders animate-pulse"></i>
        <span class="font-bold hidden sm:inline">تنظیمات مالی</span>
    </button>

    <script>
        // --- UI Interactions ---
        function toggleSettings() {
            const sidebar = document.getElementById('settingsSidebar');
            const overlay = document.getElementById('settingsOverlay');
            if(sidebar.classList.contains('translate-x-full')) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function toggleAccordion() {
            const content = document.getElementById('accordion-content');
            const arrow = document.getElementById('accordion-arrow');
            content.classList.toggle('open');
            arrow.classList.toggle('rotate-180');
        }

        // --- 1. CONFIG & DATA ---
        const TOTAL_HOUSING_POOL = 87256; 
        const TOURISM_BASE_1404 = 1423.7;
        const HOUSING_1404 = 3874;

        // FontAwesome Icons mapping
        const defaultProjects = [
            { id: 1, name: "تصفیه‌خانه", phase: 1, totalPhase: 3, cost: 1000, year: 1407, icon: "fa-water", color: "#3b82f6", bg: "bg-blue-50" },
            { id: 2, name: "تصفیه‌خانه", phase: 2, totalPhase: 3, cost: 1500, year: 1408, icon: "fa-water", color: "#3b82f6", bg: "bg-blue-50" },
            { id: 3, name: "تصفیه‌خانه", phase: 3, totalPhase: 3, cost: 1500, year: 1409, icon: "fa-water", color: "#3b82f6", bg: "bg-blue-50" },
            { id: 4, name: "نیروگاه DG", phase: 1, totalPhase: 3, cost: 1000, year: 1407, icon: "fa-bolt", color: "#f59e0b", bg: "bg-amber-50" },
            { id: 5, name: "نیروگاه DG", phase: 2, totalPhase: 3, cost: 1350, year: 1408, icon: "fa-bolt", color: "#f59e0b", bg: "bg-amber-50" },
            { id: 6, name: "نیروگاه DG", phase: 3, totalPhase: 3, cost: 1000, year: 1409, icon: "fa-bolt", color: "#f59e0b", bg: "bg-amber-50" },
            { id: 7, name: "زهکشی سیلاب", phase: 1, totalPhase: 2, cost: 1200, year: 1407, icon: "fa-cloud-showers-heavy", color: "#0ea5e9", bg: "bg-sky-50" },
            { id: 8, name: "زهکشی سیلاب", phase: 2, totalPhase: 2, cost: 1250, year: 1408, icon: "fa-cloud-showers-heavy", color: "#0ea5e9", bg: "bg-sky-50" },
            { id: 9, name: "زیرساخت ۸ محله", phase: 1, totalPhase: 3, cost: 750, year: 1406, icon: "fa-map-location-dot", color: "#8b5cf6", bg: "bg-purple-50" },
            { id: 10, name: "زیرساخت ۸ محله", phase: 2, totalPhase: 3, cost: 800, year: 1407, icon: "fa-map-location-dot", color: "#8b5cf6", bg: "bg-purple-50" },
            { id: 11, name: "زیرساخت ۸ محله", phase: 3, totalPhase: 3, cost: 800, year: 1408, icon: "fa-map-location-dot", color: "#8b5cf6", bg: "bg-purple-50" },
            { id: 12, name: "ساختمان خدماتی", phase: 1, totalPhase: 1, cost: 350, year: 1406, icon: "fa-truck-medical", color: "#f43f5e", bg: "bg-rose-50" },
            { id: 13, name: "پل ورودی", phase: 1, totalPhase: 1, cost: 280, year: 1405, icon: "fa-bridge", color: "#10b981", bg: "bg-emerald-50" },
            { id: 14, name: "معبر غربی", phase: 1, totalPhase: 1, cost: 220, year: 1405, icon: "fa-road", color: "#64748b", bg: "bg-slate-50" }
        ];

        let state = { inflation: 35, realization: 100, infraShare: 30, allocations: [0, 10, 20, 20, 10] };
        let projects = JSON.parse(JSON.stringify(defaultProjects));
        let yearlyData = [];
        let activeFilterYear = null; 
        
        let barChartInstance = null;
        let donutChartInstance = null;
        let cfChartInstance = null;

        // --- 2. LOGIC ---
        function calculateFinancials() {
            yearlyData = [];
            for(let i=0; i<6; i++) { 
                let year = 1404 + i;
                let housing = (year === 1404) ? HOUSING_1404 : TOTAL_HOUSING_POOL * (state.allocations[i-1] / 100) * (state.realization / 100);
                let tourism = (year === 1404) ? TOURISM_BASE_1404 : TOURISM_BASE_1404 * Math.pow(1 + (state.inflation / 100), i);

                let totalYearly = housing + tourism;
                let infraBudget = totalYearly * (state.infraShare / 100);
                let shareholder = totalYearly - infraBudget;
                let usedBudget = projects.filter(p => p.year === year).reduce((sum, p) => sum + p.cost, 0);

                yearlyData.push({
                    year: year, housing: housing, tourism: tourism, totalRev: totalYearly, 
                    shareholder: shareholder, infraAvailable: infraBudget, infraUsed: usedBudget, 
                    balance: infraBudget - usedBudget
                });
            }
            updateUI();
        }

        // --- 3. UI RENDERER ---
        function updateUI() {
            let scopeData = yearlyData.filter(d => d.year >= 1405); 
            let isFiltered = activeFilterYear !== null;
            
            if(isFiltered) {
                scopeData = yearlyData.filter(d => d.year === activeFilterYear);
                document.getElementById('filter-banner').classList.remove('hidden');
                document.getElementById('filter-text').innerText = `تحلیل فوکوس: اطلاعات سال ${activeFilterYear}`;
            } else {
                document.getElementById('filter-banner').classList.add('hidden');
            }

            let totRev = scopeData.reduce((sum, d) => sum + d.totalRev, 0);
            let totInfra = scopeData.reduce((sum, d) => sum + d.infraAvailable, 0);
            let totUsed = scopeData.reduce((sum, d) => sum + d.infraUsed, 0);
            let netBalance = totInfra - totUsed;

            document.getElementById('lbl-kpi-1').innerText = isFiltered ? `درآمد پیش‌بینی شده (${activeFilterYear})` : 'درآمد کل پیش‌بینی شده ۵ ساله';
            document.getElementById('lbl-kpi-2').innerText = isFiltered ? `سقف بودجه مجاز (${activeFilterYear})` : `بودجه مجاز زیرساخت (${state.infraShare}٪)`;
            document.getElementById('lbl-kpi-3').innerText = isFiltered ? `برآورد هزینه پروژه‌ها (${activeFilterYear})` : 'برآورد هزینه کل پروژه‌ها';
            document.getElementById('lbl-kpi-4').innerText = isFiltered ? `تراز مالی (${activeFilterYear})` : 'مانده نقدینگی نهایی';

            document.getElementById('kpi-infra-sub').innerText = `سقف مجاز مصوب (${state.infraShare}٪)`;

            document.getElementById('kpi-total-revenue').innerHTML = `${(totRev/1000).toFixed(1)} <span class="text-sm font-bold text-slate-400">همت</span>`;
            document.getElementById('kpi-infra-budget').innerHTML = `${(totInfra/1000).toFixed(1)} <span class="text-sm font-bold text-emerald-400 group-hover:text-emerald-500 transition-colors">همت</span>`;
            document.getElementById('kpi-used').innerHTML = `${(totUsed/1000).toFixed(1)} <span class="text-sm font-bold text-amber-400 group-hover:text-amber-500 transition-colors">همت</span>`;
            
            let balEl = document.getElementById('kpi-balance');
            let balCard = document.getElementById('kpi-balance-card');
            let balWatermark = document.getElementById('kpi-balance-watermark');
            let subKpi4 = document.getElementById('sub-kpi-4');
            
            balEl.innerHTML = `${Math.abs(netBalance/1000).toFixed(1)} <span class="text-sm font-bold">همت</span>`;
            
            if(netBalance < 0) {
                balEl.className = "text-3xl font-black mb-1 text-rose-600";
                balCard.className = "kpi-card p-5 group bg-rose-50 border-rose-200";
                balWatermark.className = "fa-solid fa-scale-balanced watermark-icon text-rose-500 transition-all duration-300";
                subKpi4.innerText = "هشدار: کسری بودجه استراتژیک!";
                subKpi4.className = "text-[10px] font-bold text-rose-500 mt-1";
            } else {
                balEl.className = "text-3xl font-black mb-1 text-slate-800 transition-colors group-hover:text-emerald-600";
                balCard.className = "kpi-card p-5 group hover-green";
                balWatermark.className = "fa-solid fa-scale-balanced watermark-icon text-slate-300 group-hover:text-emerald-500 group-hover:opacity-10 transition-all duration-300";
                subKpi4.innerText = isFiltered ? "مازاد نقدینگی در این سال" : "نقدینگی رسوب‌کرده در پایان پروژه";
                subKpi4.className = "text-[10px] text-slate-500 font-medium mt-1";
            }

            renderCashFlowData();
            renderCharts();
            renderSwimlanes();
        }

        // --- 4. GRAPHICAL TABLE ---
        function renderCashFlowData() {
            document.getElementById('th-shareholder').innerText = `سهم شرکا (${100 - state.infraShare}٪)`;
            document.getElementById('th-infra').innerText = `بودجه زیرساخت (${state.infraShare}٪)`;

            const tbody = document.getElementById('cash-flow-tbody');
            tbody.innerHTML = '';
            yearlyData.forEach(d => {
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="font-black text-slate-700 border-x border-slate-100">${d.year}</td>
                        <td class="text-purple-600 font-semibold">${Math.round(d.housing).toLocaleString()}</td>
                        <td class="text-rose-500 font-semibold">${Math.round(d.tourism).toLocaleString()}</td>
                        <td class="border-x border-slate-100 bg-blue-50/30">
                            <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded shadow-sm font-black text-xs">${Math.round(d.totalRev).toLocaleString()}</span>
                        </td>
                        <td class="text-slate-500">${Math.round(d.shareholder).toLocaleString()}</td>
                        <td class="border-r border-slate-100 bg-emerald-50/30">
                            <span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded shadow-sm font-black text-xs">${Math.round(d.infraAvailable).toLocaleString()}</span>
                        </td>
                    </tr>
                `;
            });

            const labels = yearlyData.map(d => d.year);
            const housingData = yearlyData.map(d => (d.housing/1000).toFixed(2));
            const tourismData = yearlyData.map(d => (d.tourism/1000).toFixed(2));
            const infraData = yearlyData.map(d => (d.infraAvailable/1000).toFixed(2));

            if(cfChartInstance) cfChartInstance.destroy();
            cfChartInstance = new Chart(document.getElementById('cashFlowChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'بودجه مجاز زیرساخت', data: infraData, type: 'line', borderColor: '#10b981', borderWidth: 3, pointBackgroundColor: '#ffffff', pointBorderColor: '#10b981', pointBorderWidth: 2, pointRadius: 5, fill: false, order: 0, tension: 0.3 },
                        { label: 'مسکونی (همت)', data: housingData, backgroundColor: '#a855f7', stack: 'Stack 0', order: 1, borderRadius: 4 },
                        { label: 'گردشگری (همت)', data: tourismData, backgroundColor: '#fb7185', stack: 'Stack 0', order: 1, borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: {font:{family: 'Vazirmatn', weight:'bold'}} }, tooltip: {titleFont: {family: 'Vazirmatn'}, bodyFont:{family: 'Vazirmatn'}} },
                    scales: { x: { stacked: true, grid: {display: false} }, y: { stacked: true, grid: {borderDash: [4,4]} } },
                    animation: { duration: 600 }
                }
            });
        }

        // --- 5. MODERN KANBAN SWIMLANES ---
        function renderSwimlanes() {
            const board = document.getElementById('swimlane-board');
            board.innerHTML = '';
            const kanbanData = yearlyData.filter(d => d.year >= 1405);

            kanbanData.forEach(data => {
                let isFilteredOut = activeFilterYear !== null && data.year !== activeFilterYear;
                let wrapClass = isFilteredOut ? 'dimmed' : (activeFilterYear === data.year ? 'focused' : '');
                
                let ratio = data.infraAvailable > 0 ? (data.infraUsed / data.infraAvailable) : 2;
                let isDanger = ratio > 1;
                let fillWidth = Math.min(ratio * 100, 100);
                let overflowWidth = isDanger ? Math.min(((data.infraUsed - data.infraAvailable)/data.infraAvailable)*100, 100) : 0;
                let fillColor = ratio <= 0.8 ? '#10b981' : (ratio <= 1 ? '#f59e0b' : '#ef4444');

                let statusText = isDanger 
                    ? `<span class="text-rose-600 font-bold">⚠ کسری: ${Math.round(Math.abs(data.balance)).toLocaleString()} م.ت</span>`
                    : `<span class="text-emerald-600 font-bold">✔ مانده: ${Math.round(data.balance).toLocaleString()} م.ت</span>`;

                let rowHtml = `
                    <div class="flex flex-col lg:flex-row bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden lane-wrapper ${wrapClass}" 
                         data-year="${data.year}" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="drop(event)">
                        
                        <div class="w-full lg:w-64 bg-slate-50 p-4 border-b lg:border-b-0 lg:border-l border-slate-200 shrink-0 flex flex-col justify-center relative">
                            ${isDanger ? `<div class="absolute right-0 top-0 bottom-0 w-1.5 bg-rose-500"></div>` : `<div class="absolute right-0 top-0 bottom-0 w-1.5 bg-emerald-500"></div>`}
                            <h4 class="font-black text-slate-800 text-lg mb-4 flex items-center gap-2"><span class="bg-white px-2 py-0.5 rounded shadow-sm border border-slate-100">سال ${data.year}</span></h4>
                            <div class="flex justify-between items-center text-[11px] font-bold text-slate-500 mb-1.5"><span>ظرفیت بودجه مجاز:</span><span class="text-slate-800">${Math.round(data.infraAvailable).toLocaleString()}</span></div>
                            <div class="flex justify-between items-center text-[11px] font-bold text-slate-500 mb-2.5"><span>برآورد هزینه پروژه‌ها:</span><span class="text-slate-800">${Math.round(data.infraUsed).toLocaleString()}</span></div>
                            <div class="prog-container mb-2"><div class="prog-fill" style="width: ${fillWidth}%; background-color: ${fillColor}"></div>${isDanger ? `<div class="prog-overflow" style="width: ${overflowWidth}%"></div>` : ''}</div>
                            <div class="text-[10px] mt-1 text-left">${statusText}</div>
                        </div>

                        <div class="flex-1 p-4 flex flex-wrap gap-4 drop-zone min-h-[140px] items-start content-start" id="zone-${data.year}">
                `;

                let yearProjects = projects.filter(p => p.year === data.year);
                yearProjects.forEach(p => {
                    let dotsHtml = '';
                    if(p.totalPhase > 1) { for(let i=1; i<=p.totalPhase; i++) { dotsHtml += `<div class="phase-dot ${i<=p.phase ? 'active' : ''}"></div>`; } }

                    rowHtml += `
                        <div class="project-card w-full sm:w-[260px] group bg-white hover:bg-slate-50" style="--accent-color: ${p.color}" id="proj-${p.id}" draggable="true" ondragstart="drag(event)" ondragend="dragEnd(event)">
                            <div class="w-14 ${p.bg} flex items-center justify-center text-2xl shrink-0 border-l border-slate-100 transition-colors group-hover:bg-white">
                                <i class="fa-solid ${p.icon} group-hover:scale-125 transition-transform duration-300" style="color: ${p.color}"></i>
                            </div>
                            <div class="flex-1 p-3 flex flex-col justify-between">
                                <div class="text-sm font-black text-slate-800 mb-2">${p.name}</div>
                                <div class="flex items-center justify-between mt-auto">
                                    <div class="bg-slate-800 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">${p.cost.toLocaleString()} م.ت</div>
                                    ${p.totalPhase > 1 ? `<div class="flex flex-col items-end w-14"><span class="text-[8px] text-slate-400 font-bold mb-0.5">فاز ${p.phase}</span><div class="phase-dots w-full">${dotsHtml}</div></div>` : ''}
                                </div>
                            </div>
                            <div class="grip-handle group-hover:text-slate-600 transition-colors bg-slate-50 group-hover:bg-slate-100">
                                <i class="fa-solid fa-grip-vertical text-xs opacity-50"></i>
                            </div>
                        </div>
                    `;
                });
                rowHtml += `</div></div>`;
                board.innerHTML += rowHtml;
            });
        }

        // --- 6. DRAG & DROP EVENTS ---
        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drop-zone-active'); }
        function leaveDrop(ev) { ev.currentTarget.classList.remove('drop-zone-active'); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.currentTarget.id); }
        function dragEnd(ev) { document.querySelectorAll('.lane-wrapper').forEach(el => { el.classList.remove('drop-zone-active'); }); }
        function drop(ev) {
            ev.preventDefault();
            let targetCol = ev.currentTarget;
            targetCol.classList.remove('drop-zone-active');
            let data = ev.dataTransfer.getData("text");
            if(data.startsWith('proj-')) {
                let newYear = parseInt(targetCol.getAttribute('data-year'));
                let projIndex = projects.findIndex(p => p.id === parseInt(data.replace('proj-', '')));
                if(projIndex > -1) { projects[projIndex].year = newYear; calculateFinancials(); }
            }
        }
        function resetProjects() { projects = JSON.parse(JSON.stringify(defaultProjects)); calculateFinancials(); }

        // --- 7. CHARTS ---
        Chart.defaults.font.family = 'Vazirmatn';
        
        function renderCharts() {
            const labels = yearlyData.map(d => `سال ${d.year}`);
            const available = yearlyData.map(d => (d.infraAvailable/1000).toFixed(2));
            const used = yearlyData.map(d => (d.infraUsed/1000).toFixed(2));
            
            const bgColors = yearlyData.map(d => {
                if(d.year === 1404) return '#cbd5e1'; 
                let isDimmed = activeFilterYear !== null && d.year !== activeFilterYear;
                let ratio = d.infraAvailable > 0 ? (d.infraUsed / d.infraAvailable) : 2;
                let color = ratio <= 0.8 ? '#10b981' : (ratio <= 1 ? '#f59e0b' : '#ef4444');
                return isDimmed ? '#e2e8f0' : color;
            });

            if(barChartInstance) barChartInstance.destroy();
            barChartInstance = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'سقف بودجه مجاز', data: available, type: 'line', borderColor: '#3b82f6', borderWidth: 2, fill: false, tension: 0.3, pointBackgroundColor: '#3b82f6', pointRadius: 4, order: 0 },
                        { label: 'برآورد هزینه پروژه‌ها', data: used, backgroundColor: bgColors, borderRadius: 6, barPercentage: 0.5, order: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            let idx = elements[0].index;
                            let clickedYear = yearlyData[idx].year;
                            if(clickedYear === 1404) return; 
                            activeFilterYear = (activeFilterYear === clickedYear) ? null : clickedYear;
                            updateUI(); 
                        }
                    },
                    plugins: { tooltip: { mode: 'index', intersect: false, titleFont: {family: 'Vazirmatn'}, bodyFont:{family: 'Vazirmatn'} }, legend: { labels: { font: {family: 'Vazirmatn', weight: 'bold'} } } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4] } }, x: { grid: { display: false } } },
                    animation: { duration: 300 }
                }
            });

            if(!donutChartInstance) {
                let groupedCosts = {};
                defaultProjects.forEach(p => {
                    let baseName = p.name.split('(')[0].trim();
                    groupedCosts[baseName] = (groupedCosts[baseName] || 0) + p.cost;
                });
                let donutLabels = Object.keys(groupedCosts);
                let donutData = Object.values(groupedCosts);

                donutChartInstance = new Chart(document.getElementById('donutChart'), {
                    type: 'doughnut',
                    data: {
                        labels: donutLabels,
                        datasets: [{ data: donutData, backgroundColor: ['#3b82f6', '#f59e0b', '#0ea5e9', '#8b5cf6', '#f43f5e', '#10b981', '#64748b'], borderWidth: 2, borderColor: '#fff' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
                });
            }
        }

        function clearFilter() { activeFilterYear = null; updateUI(); }

        // --- 8. SLIDERS & LOCK LOGIC ---
        function setupHousingSliders() {
            const container = document.getElementById('housing-sliders-container');
            container.innerHTML = '';
            const years = [1405, 1406, 1407, 1408, 1409];
            
            years.forEach((year, index) => {
                let col = document.createElement('div');
                col.innerHTML = `
                    <div class="flex justify-between items-center text-[10px] font-bold text-slate-300 mb-1">
                        <span>سال ${year}</span>
                        <span id="val-alloc-${index}" class="text-emerald-400 bg-slate-700 px-1 py-0.5 rounded">${state.allocations[index]}%</span>
                    </div>
                    <input type="range" class="housing-slider" data-index="${index}" min="0" max="100" value="${state.allocations[index]}">
                `;
                container.appendChild(col);

                col.querySelector('input').addEventListener('input', function(e) {
                    let newVal = parseInt(e.target.value);
                    let otherSum = state.allocations.reduce((sum, val, i) => i === index ? sum : sum + val, 0);
                    if (otherSum + newVal > 100) newVal = 100 - otherSum; 
                    
                    e.target.value = newVal;
                    state.allocations[index] = newVal;
                    document.getElementById(`val-alloc-${index}`).innerText = newVal + '%';
                    updateAllocProgressBar(); calculateFinancials();
                });
            });
            updateAllocProgressBar();
        }

        function updateAllocProgressBar() {
            let total = state.allocations.reduce((a,b)=>a+b, 0);
            document.getElementById('val-total-alloc').innerText = total + '%';
            document.getElementById('val-free-alloc').innerText = (100 - total) + '%';
            document.getElementById('bar-alloc').style.width = total + '%';
        }

        function resetAll() {
            document.getElementById('sl-inflation').value = 35; document.getElementById('sl-realization').value = 100; document.getElementById('sl-infrashare').value = 30;
            state.inflation = 35; state.realization = 100; state.infraShare = 30; state.allocations = [0, 10, 20, 20, 10];
            document.getElementById('val-inflation').innerText = '35%'; document.getElementById('val-realization').innerText = '100%'; document.getElementById('val-infrashare').innerText = '30%';
            setupHousingSliders(); activeFilterYear = null; calculateFinancials();
        }

        document.getElementById('sl-inflation').addEventListener('input', (e) => { state.inflation = parseInt(e.target.value); document.getElementById('val-inflation').innerText = state.inflation + '%'; calculateFinancials(); });
        document.getElementById('sl-realization').addEventListener('input', (e) => { state.realization = parseInt(e.target.value); document.getElementById('val-realization').innerText = state.realization + '%'; calculateFinancials(); });
        document.getElementById('sl-infrashare').addEventListener('input', (e) => { state.infraShare = parseInt(e.target.value); document.getElementById('val-infrashare').innerText = state.infraShare + '%'; calculateFinancials(); });

        setupHousingSliders(); calculateFinancials();
    </script>
    
    <script>
    window.addEventListener('keydown', function(e){
      if (e.key === 'Backspace') {
        const el = e.target;
        const tag = el && el.tagName;
        const isEditable = tag === 'INPUT' || tag === 'TEXTAREA' || (el && el.isContentEditable);
        if (!isEditable) {
          e.preventDefault();
          window.parent.postMessage({ type: 'NAVIGATE_BACK' }, '*');
        }
      }
    });
    </script>
</body>
</html>
