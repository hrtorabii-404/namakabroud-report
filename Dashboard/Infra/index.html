<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد شبیه‌ساز هزینه‌های زیرساختی</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.0.0/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; color: #334155; overflow-x: hidden; }
        
        .glass-panel {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Minimalist Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #0ea5e9; cursor: pointer; margin-top: -6px;
            box-shadow: 0 0 8px rgba(14, 165, 233, 0.5); border: 2px solid #fff;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 4px; }
        input[type=range]:focus { outline: none; }
        
        /* Animated Summary Cards */
        .card-glow-macro {
            background: linear-gradient(135deg, rgba(238,242,255,1) 0%, rgba(224,231,255,1) 50%, rgba(199,210,254,0.4) 100%);
            background-size: 200% 200%; animation: glowShift 4s ease infinite; border: 1px solid #c7d2fe;
        }
        .card-glow-local {
            background: linear-gradient(135deg, rgba(255,251,235,1) 0%, rgba(254,243,199,1) 50%, rgba(253,230,138,0.4) 100%);
            background-size: 200% 200%; animation: glowShift 4s ease infinite; border: 1px solid #fde68a;
        }
        @keyframes glowShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        /* Progress Bar Soft Animation */
        .animate-stripes {
            background-image: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
            background-size: 1.2rem 1.2rem; animation: move-stripes 1.5s linear infinite;
        }
        @keyframes move-stripes { from { background-position: 1.2rem 0; } to { background-position: 0 0; } }

        /* Custom Tooltips */
        .custom-tooltip {
            position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background-color: rgba(15, 23, 42, 0.95); color: #fff; text-align: right;
            padding: 12px; border-radius: 8px; width: max-content; min-width: 150px;
            opacity: 0; visibility: hidden; transition: opacity 0.2s; z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); pointer-events: none;
        }
        .group\/chart:hover .custom-tooltip, .group:hover .custom-tooltip { opacity: 1; visibility: visible; }
        .custom-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
        }

        /* Hover animations for summary cards */
        .summary-card:hover .watermark-icon { transform: scale(1.3) translate(10px, -10px); opacity: 0.15 !important; }

        /* Tabs Styling */
        .tab-btn { transition: all 0.2s ease; border-right: 4px solid transparent; }
        .tab-btn.active { border-right-color: #0ea5e9; background-color: #f0f9ff; color: #0369a1; font-weight: 800; }
        .tab-btn:hover:not(.active) { background-color: #f8fafc; border-right-color: #cbd5e1; }

        @media print { .no-print { display: none !important; } body { background-color: white; } .animate-stripes, .card-glow-macro, .card-glow-local { animation: none !important;} }
    </style>
</head>
<body class="pb-16">

    <header class="bg-white py-8 border-b border-slate-200 no-print mb-10 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <div class="flex justify-center items-center gap-6 md:gap-12 mb-6">
                <img src="https://uploadkon.ir/uploads/c1c428_25logo-IMPcoPNG.png" alt="لوگو ایده پرداز محیط" class="h-16 md:h-20 object-contain">
                <img src="https://uploadkon.ir/uploads/df5427_25NA-LOGO-copy.png" alt="لوگو نمک آبرود" class="h-24 md:h-32 object-contain drop-shadow-md">
                <img src="https://uploadkon.ir/uploads/611127_25OMS-LOGO-copy.png" alt="لوگو عمران مسکن شمال" class="h-16 md:h-20 object-contain">
            </div>
            <h1 class="text-3xl md:text-4xl font-black text-slate-800 mb-3">داشبورد شبیه‌ساز هزینه‌های زیرساختی</h1>
            <p class="text-lg md:text-xl font-bold text-slate-500 mb-1">تحلیل جامع هزینه‌های تکمیل زیرساخت‌ها و پروژه‌های نیمه‌تمام</p>
            <p class="text-sm md:text-base font-medium text-slate-400">تحلیل حساسیت ارزی و اولویت‌بندی سرمایه‌گذاری</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4" id="dashboard-content">

        <div class="glass-panel rounded-3xl p-6 md:p-10 mb-10 text-center relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-slate-500 font-bold mb-2 text-lg">برآورد کل بودجه مورد نیاز زیرساخت</p>
                <h2 class="text-6xl md:text-7xl font-black text-slate-800 mb-10 transition-all duration-300" id="total-budget">
                    ۱۳,۰۰۰ <span class="text-2xl md:text-3xl text-slate-400 font-bold">میلیارد تومان</span>
                </h2>
                
                <div class="max-w-lg mx-auto bg-white rounded-2xl p-5 border border-slate-200 shadow-sm relative z-20">
                    <div class="flex justify-between items-center mb-5">
                        <div class="flex items-center gap-2 text-slate-700">
                            <i class="fa-solid fa-money-bill-transfer text-emerald-500 text-xl"></i>
                            <h3 class="font-bold text-sm">شبیه‌ساز ارزی (دلار)</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="resetSlider()" title="بازنشانی به نرخ پایه" class="w-7 h-7 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 hover:text-slate-700 transition hover:-rotate-180 duration-300">
                                <i class="fa-solid fa-rotate-left text-xs"></i>
                            </button>
                            <div class="bg-slate-50 px-3 py-1 rounded border border-slate-200">
                                <span class="text-emerald-600 font-black text-lg" id="current-rate-display">۱۶۵,۰۰۰</span> <span class="text-[10px] font-bold text-slate-400">تومان</span>
                            </div>
                        </div>
                    </div>
                    <input type="range" id="fx-slider" min="100000" max="250000" step="1000" value="165000" class="w-full" oninput="handleSliderChange(this.value)">
                    <div class="flex justify-between text-[10px] text-slate-400 font-bold mt-2 px-1">
                        <span>۱۰۰ هزار تومان</span>
                        <span>۲۵۰ هزار تومان</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto mt-8">
                    <div class="card-glow-macro p-6 rounded-2xl flex justify-between items-center transition-transform hover:scale-105 duration-300 cursor-default">
                        <div class="text-right">
                            <p class="text-sm font-black text-indigo-900/60 mb-1">سهم پروژه‌های فرامحله‌ای</p>
                            <p class="text-3xl font-black text-indigo-800" id="macro-total">۱۰,۶۵۰ <span class="text-sm text-indigo-800/60">م.ت</span></p>
                        </div>
                        <div class="w-14 h-14 rounded-full bg-white/60 shadow-sm flex items-center justify-center text-indigo-600 text-2xl"><i class="fa-solid fa-globe"></i></div>
                    </div>
                    <div class="card-glow-local p-6 rounded-2xl flex justify-between items-center transition-transform hover:scale-105 duration-300 cursor-default">
                        <div class="text-right">
                            <p class="text-sm font-black text-amber-900/60 mb-1">سهم زیرساخت‌های محلات</p>
                            <p class="text-3xl font-black text-amber-700" id="local-total">۲,۳۵۰ <span class="text-sm text-amber-700/60">م.ت</span></p>
                        </div>
                        <div class="w-14 h-14 rounded-full bg-white/60 shadow-sm flex items-center justify-center text-amber-600 text-2xl"><i class="fa-solid fa-map-location-dot"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-panel rounded-3xl p-6 md:p-8 mb-10 border border-slate-200 shadow-sm">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                <div class="w-10 h-10 rounded-xl bg-sky-50 flex items-center justify-center text-sky-500 shadow-inner"><i class="fa-solid fa-grip text-xl"></i></div>
                <div>
                    <h3 class="text-xl font-black text-slate-800">برآورد هزینه‌های زیرساختی به تفکیک ۸ شریان کلان</h3>
                    <p class="text-xs font-bold text-slate-400 mt-1">تجمیع هزینه‌های درون‌محله‌ای و فرامحله‌ای (پویا و وابسته به نرخ ارز)</p>
                </div>
            </div>
            
            <div id="dynamic-summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-5">
                </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
            <div class="lg:col-span-5 glass-panel rounded-2xl p-6 flex flex-col justify-center">
                <h3 class="font-black text-slate-700 mb-6 text-lg border-b border-slate-100 pb-3"><i class="fa-solid fa-microscope text-teal-500 ml-2"></i>آناتومی استراتژیک هزینه‌ها</h3>
                
                <div class="mb-8">
                    <div class="flex justify-between text-sm font-bold mb-2">
                        <span class="text-slate-700">سهم ارزی (متاثر از دلار)</span>
                        <span class="text-teal-600" id="fx-pct-txt">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-5 overflow-hidden flex border border-slate-200">
                        <div id="fx-bar" class="bg-teal-500 h-full animate-stripes transition-all duration-500" style="width: 0%"></div>
                        <div id="irr-bar" class="bg-slate-300 h-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                    <div class="flex justify-between text-[11px] text-slate-500 font-bold mt-2">
                        <span class="text-teal-700 bg-teal-50 px-2 py-0.5 rounded">مبلغ ارزی: <span id="fx-val-txt">0</span></span>
                        <span class="text-slate-600 bg-slate-100 px-2 py-0.5 rounded">سهم ریالی (ثابت): <span id="irr-val-txt">0</span></span>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-sm font-bold mb-2">
                        <span class="text-slate-700">تامین کالا و تجهیزات</span>
                        <span class="text-indigo-500" id="proc-pct-txt">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-5 overflow-hidden flex border border-slate-200">
                        <div id="proc-bar" class="bg-indigo-400 h-full transition-all duration-500" style="width: 0%"></div>
                        <div id="const-bar" class="bg-slate-300 h-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                    <div class="flex justify-between text-[11px] text-slate-500 font-bold mt-2">
                        <span class="text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded">ارزش کالا: <span id="proc-val-txt">0</span></span>
                        <span class="text-slate-600 bg-slate-100 px-2 py-0.5 rounded">اجرای کار: <span id="const-val-txt">0</span></span>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7 glass-panel rounded-2xl p-6">
                <h3 class="font-black text-slate-700 mb-4 text-lg border-b border-slate-100 pb-3"><i class="fa-solid fa-fire-flame-curved text-orange-500 ml-2"></i>۱۰ گلوگاه اصلی هزینه‌ها (Top 10 CAPEX)</h3>
                <div id="top10-container" class="space-y-1.5 mt-2"></div>
            </div>
        </div>

        <div class="glass-panel rounded-3xl overflow-hidden mb-10 border border-slate-200">
            <div class="bg-slate-100 text-slate-800 p-4 border-b border-slate-200">
                <h2 class="text-xl font-black"><i class="fa-solid fa-layer-group text-indigo-500 ml-2"></i>تحلیل جزئیات پروژه‌های کلان (فرامحله‌ای)</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-12 min-h-[350px]">
                <div class="md:col-span-4 lg:col-span-3 bg-white border-l border-slate-200" id="macro-tabs"></div>
                <div class="md:col-span-8 lg:col-span-9 p-6 lg:p-8 bg-slate-50/50" id="macro-details"></div>
            </div>
        </div>

        <div class="glass-panel rounded-3xl p-6 md:p-8 mb-10">
            <h2 class="text-xl font-black text-slate-800 mb-2"><i class="fa-solid fa-border-all text-amber-500 ml-2"></i>ماتریس هوشمند سرمایه‌گذاری در محلات و حوزه‌ها</h2>
            <p class="text-xs font-bold text-slate-400 mb-6">این ماتریس بر اساس بودجه مورد نیاز مرتب شده است. برای مشاهده جزئیات پیشرفت (آب، برق، گاز و راه)، موس را روی کارت هر محله قرار دهید.</p>
            
            <div id="matrix-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-8">
                </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 border-t border-slate-100 pt-8">
                <div class="bg-indigo-50/50 p-5 rounded-2xl border border-indigo-100 flex flex-col transition hover:shadow-md">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center shrink-0"><i class="fa-solid fa-network-wired text-lg"></i></div>
                        <h4 class="font-bold text-sm text-slate-700">تمرکز سرمایه فرامحله‌ای</h4>
                    </div>
                    <p class="text-[11px] leading-relaxed text-slate-500 font-bold text-justify">بیش از ۸۱ درصد کل سرمایه‌گذاری شهرک، متمرکز بر احداث زیرساخت‌های پایه‌ای و پدافندی (نیروگاه اختصاصی و تصفیه‌خانه‌ها) است که ارزش افزوده قطعی برای تمام محلات ایجاد می‌کند.</p>
                </div>
                
                <div class="bg-amber-50/50 p-5 rounded-2xl border border-amber-100 flex flex-col transition hover:shadow-md">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-500 flex items-center justify-center shrink-0"><i class="fa-solid fa-map-location-dot text-lg"></i></div>
                        <h4 class="font-bold text-sm text-slate-700">اولویت‌بندی و بحران محلات</h4>
                    </div>
                    <p class="text-[11px] leading-relaxed text-slate-500 font-bold text-justify">محله ۸ با بلعیدن بخش عظیمی از بودجه محلات، گلوگاه اصلی توسعه است. در مقابل، محله‌های ۳ و ۵ با کمترین نیاز مالی، آماده بهره‌برداری کامل و تحویل نهایی هستند.</p>
                </div>
                
                <div class="bg-teal-50/50 p-5 rounded-2xl border border-teal-100 flex flex-col transition hover:shadow-md">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-500 flex items-center justify-center shrink-0"><i class="fa-solid fa-shield-halved text-lg"></i></div>
                        <h4 class="font-bold text-sm text-slate-700">مدیریت ریسک تورم ارزی</h4>
                    </div>
                    <p class="text-[11px] leading-relaxed text-slate-500 font-bold text-justify">تامین تجهیزات الکترومکانیکال (ژنراتورها و پمپ‌ها) پاشنه آشیل ارزی پروژه است. تسریع در خرید این اقلام پیش از جهش‌های احتمالی نرخ ارز، برای کنترل بودجه حیاتی است.</p>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center py-8 text-slate-500 text-xs font-bold no-print mb-4">
        <p>
            تهیه شده توسط 
            <span class="group relative cursor-help text-indigo-600 border-b border-dashed border-indigo-400 pb-0.5">
                مهندسین مشاور ایده پرداز محیط
                <span class="custom-tooltip bottom-full left-1/2 -translate-x-1/2 mb-2 text-center w-max px-4 py-3 bg-slate-800 text-white rounded-lg shadow-xl pointer-events-none z-50 leading-relaxed">
                    تحلیل و شبیه‌سازی مالی: حمیدرضا ترابی<br>
                    <span class="font-normal text-[10px] text-slate-300 mt-1 block">hr.torabii@gmail.com</span>
                </span>
            </span>
            - اسفند ۱۴۰۴
        </p>
    </footer>

    <script>
        const BASE_RATE = 165000;
        let currentRate = BASE_RATE;
        const formatNum = (num) => new Intl.NumberFormat('fa-IR').format(Math.round(num));

        const top10Colors = ['#dc2626', '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#10b981', '#14b8a6', '#0ea5e9', '#3b82f6'];

        const cMap = {
            indigo: { text: 'text-indigo-500', bg: 'bg-indigo-50', hoverBorder: 'hover:border-indigo-400', hoverText: 'group-hover:text-indigo-600', stroke: 'stroke-indigo-500' },
            amber: { text: 'text-amber-500', bg: 'bg-amber-50', hoverBorder: 'hover:border-amber-400', hoverText: 'group-hover:text-amber-600', stroke: 'stroke-amber-500' },
            cyan: { text: 'text-cyan-500', bg: 'bg-cyan-50', hoverBorder: 'hover:border-cyan-400', hoverText: 'group-hover:text-cyan-600', stroke: 'stroke-cyan-500' },
            slate: { text: 'text-slate-500', bg: 'bg-slate-50', hoverBorder: 'hover:border-slate-400', hoverText: 'group-hover:text-slate-700', stroke: 'stroke-slate-500' },
            rose: { text: 'text-rose-500', bg: 'bg-rose-50', hoverBorder: 'hover:border-rose-400', hoverText: 'group-hover:text-rose-600', stroke: 'stroke-rose-500' },
            red: { text: 'text-red-500', bg: 'bg-red-50', hoverBorder: 'hover:border-red-400', hoverText: 'group-hover:text-red-600', stroke: 'stroke-red-500' },
            yellow: { text: 'text-yellow-500', bg: 'bg-yellow-50', hoverBorder: 'hover:border-yellow-400', hoverText: 'group-hover:text-yellow-600', stroke: 'stroke-yellow-500' },
            blue: { text: 'text-blue-500', bg: 'bg-blue-50', hoverBorder: 'hover:border-blue-400', hoverText: 'group-hover:text-blue-600', stroke: 'stroke-blue-500' }
        };

        let macroData = [
            { id: 'm1', title: 'فاضلاب و تصفیه‌خانه', icon: 'fa-water', color: 'indigo', design: 'احداث تصفیه‌خانه اصلی با ظرفیت ۱۵۳۱ مترمکعب برای محلات متراکم و پکیج‌های غیرمتمرکز برای مناطق شیب‌دار جهت توزیع ریسک و رعایت الزامات پدافند غیرعامل.', price: 'مبنای فهرست‌بهای آب و فاضلاب ۱۴۰۴، تخصیص دلار ۱۶۷ هزار تومانی برای تجهیزات، اعمال ضریب منطقه‌ای و شرایط کار.', rows: [ { name: 'لوله‌گذاری شبکه اصلی متمرکز', base: 520, fxPct: 0.40, procPct: 0.60 }, { name: 'ایستگاه‌های پمپاژ و سیویل', base: 780, fxPct: 0.45, procPct: 0.40 }, { name: 'تجهیزات الکترومکانیکال متمرکز', base: 500, fxPct: 0.95, procPct: 0.90 }, { name: 'تامین پکیج‌های غیرمتمرکز', base: 850, fxPct: 0.85, procPct: 0.80 }, { name: 'شبکه محلی و مهندسی', base: 1350, fxPct: 0.35, procPct: 0.50 } ] },
            { id: 'm2', title: 'توزیع برق و نیروگاه', icon: 'fa-bolt', color: 'amber', design: 'احداث نیروگاه ۱۵ مگاواتی گازسوز (اجرای فاز اول ۱۰ مگاوات) با قابلیت Island Mode کامل جهت تاب‌آوری ۱۰۰٪. اجرای رینگ ۲۰kV کاملاً زیرزمینی.', price: 'تامین ژنراتورهای صنعتی دائم‌کار. فهرست‌بهای تاسیسات برقی ۱۴۰۴. فازبندی خرید جهت کاهش خواب سرمایه.', rows: [ { name: 'نیروگاه گازسوز (ژنراتورها)', base: 1550, fxPct: 0.98, procPct: 0.95 }, { name: 'شبکه زیرزمینی ۲۰kV و LV', base: 820, fxPct: 0.70, procPct: 0.70 }, { name: 'پست‌های توزیع کمپکت', base: 420, fxPct: 0.80, procPct: 0.85 }, { name: 'سیستم مانیتورینگ', base: 120, fxPct: 0.90, procPct: 0.80 }, { name: 'ابنیه و بالاسری', base: 440, fxPct: 0.30, procPct: 0.30 } ] },
            { id: 'm3', title: 'زهکشی و آب‌های سطحی', icon: 'fa-cloud-showers-heavy', color: 'cyan', design: 'طراحی مبتنی بر هیدرولوژی کوهپایه‌ای (دوره بازگشت ۵۰ ساله). ترکیب حوضچه‌های آرام‌کننده بالادست با خطوط انتقال.', price: 'استفاده حداکثری از مصالح بومی (کانال‌های سنگی/بتنی درجا) برای کاهش هزینه. بخش GRP مبتنی بر دلار روز.', rows: [ { name: 'خطوط انتقال GRP قطور', base: 1100, fxPct: 0.85, procPct: 0.80 }, { name: 'کانال‌های بتنی/سنگی', base: 650, fxPct: 0.35, procPct: 0.40 }, { name: 'حوضچه‌های سرریز', base: 250, fxPct: 0.35, procPct: 0.50 }, { name: 'کالورت‌ها و پل‌ها', base: 150, fxPct: 0.35, procPct: 0.50 }, { name: 'مهندسی و آزادسازی', base: 300, fxPct: 0.20, procPct: 0.10 } ] },
            { id: 'm4', title: 'خدماتی (امداد و درمان)', icon: 'fa-truck-medical', color: 'rose', design: 'احداث ۱۰۰۰ مترمربع ایستگاه آتش‌نشانی و ۲۰۰ مترمربع درمانگاه اورژانس جهت تثبیت بیماران.', price: 'ابنیه مبتنی بر فهرست‌بهای ۱۴۰۴. تجهیزات تخصصی امدادی کاملاً ارزی و مبتنی بر نرخ روز.', rows: [ { name: 'ماشین‌آلات آتش‌نشانی نردبان‌دار', base: 200, fxPct: 0.98, procPct: 0.98 }, { name: 'آمبولانس مجهز (ICU)', base: 65, fxPct: 0.95, procPct: 0.95 }, { name: 'ابنیه آتش‌نشانی', base: 35, fxPct: 0.40, procPct: 0.50 }, { name: 'ابنیه درمانگاه', base: 10, fxPct: 0.40, procPct: 0.50 }, { name: 'محوطه‌سازی و هلی‌پد', base: 40, fxPct: 0.35, procPct: 0.40 } ] },
            { id: 'm5', title: 'اصلاح هندسی و پل ورودی', icon: 'fa-bridge', color: 'slate', design: 'تقاطع غیرهمسطح (عرشه ۵۷۰۰ مترمربع) جهت اتصال ایمن جاده ساحلی به گیت شهرک.', price: 'مبتنی بر هزینه روز پل‌سازی با احتساب شمع‌کوبی عمیق در بستر جلگه‌ای.', rows: [ { name: 'اجرای عرشه و دال', base: 110, fxPct: 0.55, procPct: 0.60 }, { name: 'شمع‌کوبی و پایه‌ها', base: 85, fxPct: 0.40, procPct: 0.40 }, { name: 'رمپ و دیوارهای حائل', base: 45, fxPct: 0.45, procPct: 0.50 }, { name: 'تاسیسات و ایمنی', base: 15, fxPct: 0.60, procPct: 0.70 }, { name: 'طراحی و بالاسری', base: 25, fxPct: 0.20, procPct: 0.10 } ] },
            { id: 'm6', title: 'معبر دسترسی غربی', icon: 'fa-road', color: 'slate', design: 'شریان جدید ارتباطی به طول ۸۹۰ متر (۳۳ هزار مترمربع روسازی) جهت توزیع ترافیک پدافندی.', price: 'وابستگی مستقیم به نرخ روز قیر در بورس کالا. فهرست‌بهای راه و باند ۱۴۰۴.', rows: [ { name: 'اساس و آسفالت (قیر)', base: 95, fxPct: 0.65, procPct: 0.70 }, { name: 'عملیات خاکی', base: 45, fxPct: 0.35, procPct: 0.20 }, { name: 'جدول‌گذاری و پیاده‌رو', base: 25, fxPct: 0.35, procPct: 0.40 }, { name: 'مبلمان ترافیکی و روشنایی', base: 25, fxPct: 0.65, procPct: 0.80 }, { name: 'نقشه‌برداری', base: 30, fxPct: 0.20, procPct: 0.10 } ] }
        ];

        let localData = [
            { id: 'l1', title: 'محله ۱', base: 216.7, fxPct: 0.60, p: { r: 80, w: 86, e: 92, g: 83 } }, { id: 'l2', title: 'محله ۲', base: 125.8, fxPct: 0.60, p: { r: 90, w: 93, e: 98, g: 90 } }, { id: 'l3', title: 'محله ۳', base: 81.4,  fxPct: 0.60, p: { r: 90, w: 93, e: 91, g: 94 } },
            { id: 'l4', title: 'محله ۴', base: 369.1, fxPct: 0.60, p: { r: 74, w: 72, e: 73, g: 83 } }, { id: 'l5', title: 'محله ۵', base: 14.0,  fxPct: 0.60, p: { r: 97, w: 99, e: 99, g: 99 } }, { id: 'l6', title: 'محله ۶', base: 111.9, fxPct: 0.60, p: { r: 78, w: 85, e: 89, g: 89 } },
            { id: 'l7', title: 'محله ۷', base: 438.5, fxPct: 0.60, p: { r: 57, w: 53, e: 49, g: 43 } }, { id: 'l8', title: 'محله ۸', base: 743.3, fxPct: 0.60, p: { r: 46, w: 64, e: 44, g: 44 } }, { id: 'ls', title: 'حوزه خدماتی', base: 249.2, fxPct: 0.60, p: { r: 60, w: 75, e: 80, g: 60 } }
        ];

        let activeMacroId = 'm1';

        function calculateDynamicCost(baseCost, fxPct, rate) {
            return (baseCost * fxPct * (rate / BASE_RATE)) + (baseCost * (1 - fxPct));
        }

        function getComputedRows(rate) {
            let allRows = [];
            macroData.forEach(m => { m.rows.forEach(r => { allRows.push({ ...r, parentTitle: m.title, currentCost: calculateDynamicCost(r.base, r.fxPct, rate) }); }); });
            localData.forEach(l => { allRows.push({ name: `زیرساخت ${l.title}`, parentTitle: 'محلات و حوزه‌ها', base: l.base, fxPct: l.fxPct, procPct: 0.60, currentCost: calculateDynamicCost(l.base, l.fxPct, rate) }); });
            return allRows;
        }

        function getMacroTotals(rate) {
            let totals = {};
            macroData.forEach(m => totals[m.id] = m.rows.reduce((sum, r) => sum + calculateDynamicCost(r.base, r.fxPct, rate), 0));
            return totals;
        }
        function getLocalTotal(rate) { return localData.reduce((sum, l) => sum + calculateDynamicCost(l.base, l.fxPct, rate), 0); }

        function handleSliderChange(val) { currentRate = parseInt(val); document.getElementById('current-rate-display').innerText = formatNum(currentRate); updateDashboard(); }
        function resetSlider() { document.getElementById('fx-slider').value = BASE_RATE; handleSliderChange(BASE_RATE); }

        function updateDashboard() {
            const rate = currentRate;
            const macroTotals = getMacroTotals(rate);
            const sumMacro = Object.values(macroTotals).reduce((a,b)=>a+b,0);
            const sumLocal = getLocalTotal(rate);
            const grandTotal = sumMacro + sumLocal;
            
            document.getElementById('total-budget').innerHTML = `${formatNum(grandTotal)} <span class="text-2xl md:text-3xl text-slate-400 font-bold">میلیارد تومان</span>`;
            document.getElementById('macro-total').innerHTML = `${formatNum(sumMacro)} <span class="text-sm text-indigo-800/60 font-bold">م.ت</span>`;
            document.getElementById('local-total').innerHTML = `${formatNum(sumLocal)} <span class="text-sm text-amber-700/60 font-bold">م.ت</span>`;

            renderSummaryCards(rate, macroTotals, sumLocal, grandTotal);

            const allRows = getComputedRows(rate);
            let totalFX = 0; let totalIRR = 0; let totalProc = 0; let totalConst = 0;
            allRows.forEach(r => {
                totalFX += r.base * r.fxPct * (rate / BASE_RATE); totalIRR += r.base * (1 - r.fxPct);
                totalProc += r.currentCost * r.procPct; totalConst += r.currentCost * (1 - r.procPct);
            });
            
            const fxPctStr = ((totalFX / grandTotal) * 100).toFixed(1);
            const procPctStr = ((totalProc / grandTotal) * 100).toFixed(1);

            document.getElementById('fx-pct-txt').innerText = `${fxPctStr}٪`; document.getElementById('fx-bar').style.width = `${fxPctStr}%`; document.getElementById('irr-bar').style.width = `${100 - fxPctStr}%`;
            document.getElementById('fx-val-txt').innerText = `${formatNum(totalFX)} م.ت`; document.getElementById('irr-val-txt').innerText = `${formatNum(totalIRR)} م.ت`;
            document.getElementById('proc-pct-txt').innerText = `${procPctStr}٪`; document.getElementById('proc-bar').style.width = `${procPctStr}%`; document.getElementById('const-bar').style.width = `${100 - procPctStr}%`;
            document.getElementById('proc-val-txt').innerText = `${formatNum(totalProc)} م.ت`; document.getElementById('const-val-txt').innerText = `${formatNum(totalConst)} م.ت`;

            const sorted = [...allRows].sort((a,b) => b.currentCost - a.currentCost).slice(0, 10);
            const maxCost = sorted[0].currentCost;
            let top10Html = '';
            sorted.forEach((item, index) => {
                const w = (item.currentCost / maxCost) * 100;
                const color = top10Colors[index];
                top10Html += `
                    <div class="mb-3.5 relative">
                        <div class="flex justify-between text-[13px] font-bold mb-1">
                            <span class="text-slate-700">${index + 1}. ${item.name} <span class="text-[10px] text-slate-400 font-normal">(${item.parentTitle})</span></span>
                            <span style="color:${color}">${formatNum(item.currentCost)} م.ت</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5"><div class="h-1.5 rounded-full transition-all duration-300" style="width: ${w}%; background-color: ${color}"></div></div>
                    </div>`;
            });
            document.getElementById('top10-container').innerHTML = top10Html;

            renderMacroTabs(macroTotals); 
            renderMacroDetails(activeMacroId, macroTotals);
            renderMatrixGrid(rate);
        }

        function renderSummaryCards(rate, macroTotals, sumLocal, grandTotal) {
            const localRatio = sumLocal / 2350; 
            const categories = [
                { id: 'c1', title: 'فاضلاب و تصفیه‌خانه', type: '(فرامحله‌ای)', cost: macroTotals['m1'], colorKey: 'indigo', icon: 'fa-water' },
                { id: 'c2', title: 'پست برق و نیروگاه', type: '(فرامحله‌ای)', cost: macroTotals['m2'], colorKey: 'amber', icon: 'fa-bolt' },
                { id: 'c3', title: 'زهکشی و آب‌های سطحی', type: '(فرامحله‌ای)', cost: macroTotals['m3'], colorKey: 'cyan', icon: 'fa-cloud-showers-heavy' },
                { id: 'c4', title: 'شبکه راه و معابر', type: '(فرامحله‌ای + محلات)', cost: macroTotals['m5'] + macroTotals['m6'] + (1472 * localRatio), colorKey: 'slate', icon: 'fa-road' },
                { id: 'c5', title: 'ساختمان‌های خدماتی', type: '(فرامحله‌ای)', cost: macroTotals['m4'], colorKey: 'rose', icon: 'fa-truck-medical' },
                { id: 'c6', title: 'شبکه گازرسانی', type: '(کل محلات)', cost: 343 * localRatio, colorKey: 'red', icon: 'fa-fire' },
                { id: 'c7', title: 'برق‌رسانی و روشنایی', type: '(داخل محلات)', cost: 322 * localRatio, colorKey: 'yellow', icon: 'fa-lightbulb' },
                { id: 'c8', title: 'شبکه آبرسانی', type: '(کل محلات)', cost: 213 * localRatio, colorKey: 'blue', icon: 'fa-droplet' },
            ];

            let html = '';
            categories.forEach(c => {
                const pct = (c.cost / grandTotal) * 100;
                const dashOffset = 100 - pct; 
                const tColor = cMap[c.colorKey]; 

                html += `
                    <div class="summary-card group relative bg-white rounded-2xl p-4 md:p-5 border border-slate-100 cursor-default transition-all duration-300 hover:-translate-y-1.5 hover:shadow-xl ${tColor.hoverBorder}">
                        <div class="absolute inset-0 rounded-2xl overflow-hidden pointer-events-none z-0">
                            <i class="fa-solid ${c.icon} watermark-icon absolute -bottom-4 -left-4 text-7xl ${tColor.text} opacity-[0.03] transition-all duration-500"></i>
                        </div>
                        <div class="relative z-10 flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl ${tColor.bg} flex items-center justify-center ${tColor.text} transition-colors group-hover:bg-white border border-transparent group-hover:border-slate-100">
                                    <i class="fa-solid ${c.icon} text-lg"></i>
                                </div>
                                <div>
                                    <h4 class="text-sm font-black text-slate-700 leading-tight ${tColor.hoverText} transition-colors">${c.title}</h4>
                                    <p class="text-[10px] text-slate-400 font-bold mt-1">${c.type}</p>
                                </div>
                            </div>
                            <div class="relative w-8 h-8 group/chart cursor-help shrink-0">
                                <svg viewBox="0 0 36 36" class="w-8 h-8 transform -rotate-90 drop-shadow-sm">
                                    <circle cx="18" cy="18" r="15.915" fill="none" class="stroke-slate-100" stroke-width="4"></circle>
                                    <circle cx="18" cy="18" r="15.915" fill="none" class="${tColor.stroke} transition-all duration-500" stroke-width="4" stroke-dasharray="100 100" stroke-dashoffset="${dashOffset}"></circle>
                                </svg>
                                <div class="custom-tooltip text-[10px]">سهم از کل: ${pct.toFixed(1)}٪</div>
                            </div>
                        </div>
                        <div class="relative z-10 text-right mt-2">
                            <p class="text-[10px] text-slate-400 font-bold mb-0.5">هزینه کل برآوردی</p>
                            <p class="text-2xl font-black text-slate-800 flex items-baseline gap-1 ${tColor.hoverText} transition-colors">${formatNum(c.cost)} <span class="text-[10px] text-slate-500 font-bold">م.ت</span></p>
                        </div>
                    </div>`;
            });
            document.getElementById('dynamic-summary-cards').innerHTML = html;
        }

        function renderMacroTabs(totals) {
            document.getElementById('macro-tabs').innerHTML = macroData.map(m => `
                <button onclick="selectMacro('${m.id}')" class="tab-btn w-full text-right p-4 border-b border-slate-100 flex items-center justify-between ${m.id === activeMacroId ? 'active' : 'text-slate-600'}">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid ${m.icon} ${m.id === activeMacroId ? cMap[m.color].text : 'text-slate-400'} w-5 text-center"></i>
                        <span class="text-sm font-bold">${m.title}</span>
                    </div>
                    <span class="text-xs font-black">${formatNum(totals[m.id])}</span>
                </button>
            `).join('');
        }
        function selectMacro(id) { activeMacroId = id; updateDashboard(); }

        function renderMacroDetails(id, totals) {
            const m = macroData.find(x => x.id === id);
            const totalCost = totals[m.id];
            const tColor = cMap[m.color];
            
            let rowsHtml = '';
            m.rows.forEach(r => {
                const cCost = calculateDynamicCost(r.base, r.fxPct, currentRate);
                let rowPct = 0; if(totalCost > 0) rowPct = Math.round((cCost / totalCost) * 100);
                rowsHtml += `
                    <div class="flex items-center justify-between py-3 border-b border-slate-200 border-dashed">
                        <div class="w-[45%] pr-2">
                            <p class="font-bold text-slate-700 text-sm">${r.name}</p>
                            <p class="text-[10px] text-slate-400 font-bold mt-1">وابستگی ارزی: ${Math.round(r.fxPct*100)}٪</p>
                        </div>
                        <div class="w-[35%] px-4 hidden sm:block">
                            <div class="w-full bg-slate-200 h-2.5 rounded-full overflow-hidden border border-slate-300">
                                <div class="${tColor.bg.replace('bg-', 'bg-').replace('50', '500')} h-full animate-stripes transition-all duration-300" style="width:${rowPct}%"></div>
                            </div>
                            <p class="text-[9px] text-slate-500 font-bold mt-1.5 text-center">سهم از این بخش: ${rowPct}٪</p>
                        </div>
                        <div class="w-[20%] text-left pl-2">
                            <span class="font-black text-slate-800 text-lg">${formatNum(cCost)}</span> <span class="text-[10px] font-bold text-slate-500">م.ت</span>
                        </div>
                    </div>`;
            });

            document.getElementById('macro-details').innerHTML = `
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200 group relative">
                    <div class="flex items-center gap-3">
                        <h3 class="text-2xl font-black text-slate-800">${m.title}</h3>
                        <div class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center cursor-help transition hover:bg-slate-300"><i class="fa-solid fa-info text-xs"></i></div>
                    </div>
                    <div class="custom-tooltip top-full bottom-auto mt-2 text-right w-[300px]">
                        <div class="mb-2 border-b border-slate-600 pb-2"><span class="text-amber-400 font-bold text-xs"><i class="fa-solid fa-pen-ruler ml-1"></i>مبانی طراحی:</span><p class="text-xs font-normal mt-1 leading-relaxed text-justify">${m.design}</p></div>
                        <div><span class="text-cyan-400 font-bold text-xs"><i class="fa-solid fa-tags ml-1"></i>مبانی قیمت‌گذاری:</span><p class="text-xs font-normal mt-1 leading-relaxed text-justify">${m.price}</p></div>
                    </div>
                    <div class="text-left">
                        <p class="text-3xl font-black ${tColor.text} transition-all duration-300">${formatNum(totalCost)}</p>
                        <p class="text-[10px] font-bold text-slate-500">مجموع (میلیارد تومان)</p>
                    </div>
                </div>
                <div>${rowsHtml}</div>
            `;
        }

        // --- NEW: Smart Matrix Grid for Locals ---
        function getProgressColor(avg) {
            if(avg >= 85) return '#10b981'; // Emerald 500
            if(avg >= 50) return '#f59e0b'; // Amber 500
            return '#ef4444';               // Red 500
        }

        function renderMatrixGrid(rate) {
            const localsWithCost = localData.map(l => {
                const cCost = calculateDynamicCost(l.base, l.fxPct, rate);
                const avgProg = (l.p.r + l.p.w + l.p.e + l.p.g) / 4;
                return { ...l, currentCost: cCost, avgProg: avgProg, colorCode: getProgressColor(avgProg) };
            }).sort((a,b) => b.currentCost - a.currentCost); // Sort by Cost

            let html = '';
            localsWithCost.forEach(l => {
                const circ = 2 * Math.PI * 22; // ~138.2
                const offset = circ - (l.avgProg / 100) * circ;
                
                html += `
                    <div class="group relative bg-white rounded-2xl p-5 border border-slate-200 shadow-sm overflow-hidden transition-all duration-300 hover:shadow-lg hover:-translate-y-1 cursor-default">
                        <div class="flex justify-between items-center h-full">
                            <div class="relative w-[60px] h-[60px] flex items-center justify-center shrink-0">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="30" cy="30" r="22" stroke="#f1f5f9" stroke-width="5" fill="none" />
                                    <circle cx="30" cy="30" r="22" stroke="${l.colorCode}" stroke-width="5" fill="none" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round" class="transition-all duration-700" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-[11px] font-black" style="color: ${l.colorCode}">${Math.round(l.avgProg)}٪</span>
                                </div>
                            </div>
                            <div class="text-left pl-1">
                                <h4 class="text-sm font-black text-slate-800 mb-1">${l.title}</h4>
                                <p class="text-2xl font-black text-slate-700 transition-all duration-300">${formatNum(l.currentCost)} <span class="text-[10px] text-slate-400 font-bold">م.ت</span></p>
                            </div>
                        </div>
                        
                        <div class="absolute inset-0 bg-slate-900/95 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-center p-5 z-20">
                            <p class="text-white font-black text-sm border-b border-slate-700 pb-2 mb-3 text-center">${l.title} <span class="text-[10px] text-slate-400 font-normal">(پیشرفت فیزیکی)</span></p>
                            <div class="grid grid-cols-2 gap-y-3 gap-x-4 text-xs">
                                <div class="flex justify-between items-center"><span class="text-slate-400"><i class="fa-solid fa-road ml-1 text-slate-500 text-[10px]"></i>راه:</span><span class="font-bold text-orange-400">${l.p.r}٪</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-400"><i class="fa-solid fa-droplet ml-1 text-slate-500 text-[10px]"></i>آب:</span><span class="font-bold text-blue-400">${l.p.w}٪</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-400"><i class="fa-solid fa-bolt ml-1 text-slate-500 text-[10px]"></i>برق:</span><span class="font-bold text-yellow-400">${l.p.e}٪</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-400"><i class="fa-solid fa-fire ml-1 text-slate-500 text-[10px]"></i>گاز:</span><span class="font-bold text-red-400">${l.p.g}٪</span></div>
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('matrix-container').innerHTML = html;
        }

        window.onload = () => updateDashboard();
    </script>

    <script>
    window.addEventListener('keydown', function(e){
      if (e.key === 'Backspace') {
        const el = e.target;
        const tag = el && el.tagName;
        const isEditable = tag === 'INPUT' || tag === 'TEXTAREA' || (el && el.isContentEditable);
        if (!isEditable) {
          e.preventDefault();
          window.parent.postMessage({ type: 'NAVIGATE_BACK' }, '*');
        }
      }
    });
    </script>
</body>
</html>
