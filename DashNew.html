<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شناسنامه مدیریتی پروژه‌های عمرانی نمک‌آبرود</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for creating charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Persian Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .chart-container {
            height: 300px;
            width: 100%;
        }
        .summary-chart-container {
            height: 550px;
            width: 100%;
        }
        
        /* --- PDF & Print Styling --- */
        .pdf-page {
            page-break-inside: avoid !important; 
        }
        .cover-page {
            page-break-after: always !important;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        @media print {
            html, body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff;
            }
            .no-print {
                display: none !important;
            }
            .pdf-page:not(.cover-page) {
                page-break-before: always !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-2 sm:p-4 md:p-6">

    <div id="report-content" class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-10">
        
        <header class="text-center pdf-page cover-page">
            <div class="border-y-4 border-indigo-700 py-10 px-6 md:py-12 md:px-8 w-full">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-indigo-900">شناسنامه پروژه‌های بالقوه</h1>
                <p class="text-lg md:text-xl text-slate-600 mt-4">گزارش مدیریتی و تحلیلی شهرک نمک‌آبرود</p>
                <p class="text-sm text-slate-400 mt-12">بر اساس طرح بهنگام - ویرایش ششم - تابستان ۱۴۰۴</p>
            </div>
        </header>

        <main id="neighborhoods-container">
            <!-- This will be populated by JavaScript -->
        </main>
        
        <div class="pdf-page">
            <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
            <section class="pt-2">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-indigo-900 mb-4">نمودار تعاملی مقایسه پیشرفت محلات</h2>
                 <p class="text-center text-base md:text-lg text-slate-600 max-w-3xl mx-auto mb-10">این نمودار، وضعیت پیشرفت هر حوزه پروژه را به تفکیک در تمام محلات نمایش می‌دهد. با کلیک بر روی نام هر پروژه در بالای نمودار، می‌توانید آن را مخفی یا نمایان کرده و حوزه‌های مورد نظر را با هم مقایسه کنید.</p>
                 <div class="bg-slate-50 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="summary-chart-container relative">
                        <canvas id="summary-bar-chart"></canvas>
                    </div>
                </div>
            </section>
        </div>

        <div class="pdf-page">
            <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
            <section class="pt-2">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-indigo-900 mb-4">تحلیل چالش‌ها و شاخص‌های کلیدی</h2>
                <p class="text-center text-base md:text-lg text-slate-600 max-w-3xl mx-auto mb-10">نمای کلی از وضعیت پروژه‌ها و ارزیابی مهم‌ترین چالش‌های پیش رو در سطح شهرک.</p>
                <div id="analysis-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- This will be populated by JavaScript -->
                </div>
            </section>
        </div>

        <div class="pdf-page">
            <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
            <section class="pt-2">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-indigo-900 mb-8">داشبورد پروژه‌های استراتژیک (فرامحله‌ای)</h2>
                <div id="supra-local-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- This will be populated by JavaScript -->
                </div>
            </section>
        </div>

        <footer class="text-center mt-20 pt-10 border-t-2 border-slate-200 no-print">
            <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                دانلود شناسنامه به صورت PDF
            </button>
             <div id="loading-spinner" class="hidden mt-4 flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-slate-600 mr-2">در حال آماده‌سازی فایل PDF...</span>
            </div>
        </footer>
    </div>
    
    <!-- MAIN APPLICATION SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const projectData = {
                "محله ۱": {
                    description: "محله‌ای با توسعه زیرساختی متوازن که چالش اصلی آن، کمبود شدید خدمات روبنایی است.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۲,۲۶۱ متر", incompleteness: 20 },
                        { name: "شبکه توزیع آب", quantity: "۱,۵۸۴ متر", incompleteness: 14 },
                        { name: "شبکه توزیع برق", quantity: "۹۲۰ متر", incompleteness: 8 },
                        { name: "شبکه توزیع گاز", quantity: "۱,۸۷۷ متر", incompleteness: 17 },
                        { name: "خدمات روبنایی", quantity: "۷۵,۵۲۴ م.م.", incompleteness: 81 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۱,۰۳۲ متر", incompleteness: 100 }
                    ]
                },
                "محله ۲": {
                    description: "پیشرفته‌ترین محله از نظر زیرساختی که اکنون نیازمند تمرکز بر توسعه خدمات آموزشی و درمانی است.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۱,۳۳۴ متر", incompleteness: 10 },
                        { name: "شبکه توزیع آب", quantity: "۸۵۱ متر", incompleteness: 7 },
                        { name: "شبکه توزیع برق", quantity: "۲۲۴ متر", incompleteness: 2 },
                        { name: "شبکه توزیع گاز", quantity: "۱,۳۶۱ متر", incompleteness: 10 },
                        { name: "خدمات روبنایی", quantity: "۵۵,۵۳۰ م.م.", incompleteness: 49 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۲,۸۵۶ متر", incompleteness: 99 }
                    ]
                },
                "محله ۳": {
                    description: "محله‌ای با زیرساخت‌های مطلوب که اولویت اصلی آن توسعه فضاهای تجاری محلی و فضای سبز است.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۸۱۲ متر", incompleteness: 10 },
                        { name: "شبکه توزیع آب", quantity: "۵۶۴ متر", incompleteness: 7 },
                        { name: "شبکه توزیع برق", quantity: "۷۲۸ متر", incompleteness: 9 },
                        { name: "شبکه توزیع گاز", quantity: "۴۸۹ متر", incompleteness: 6 },
                        { name: "خدمات روبنایی", quantity: "۳۶,۰۶۳ م.م.", incompleteness: 62 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۷,۸۳۴ متر", incompleteness: 100 }
                    ]
                },
                "محله ۴": {
                    description: "محله‌ای وسیع با حجم قابل توجهی از کارهای باقی‌مانده در حوزه زیرساخت، به‌ویژه راه و آب.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۳,۴۰۳ متر", incompleteness: 26 },
                        { name: "شبکه توزیع آب", quantity: "۳,۷۶۷ متر", incompleteness: 28 },
                        { name: "شبکه توزیع برق", quantity: "۳,۵۳۶ متر", incompleteness: 27 },
                        { name: "شبکه توزیع گاز", quantity: "۲,۲۶۸ متر", incompleteness: 17 },
                        { name: "خدمات روبنایی", quantity: "۸۹,۱۷۲ م.م.", incompleteness: 75 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۳,۲۴۷ متر", incompleteness: 100 }
                    ]
                },
                "محله ۵": {
                    description: "محله‌ای که زیرساخت‌های آن تقریباً کامل شده و اکنون تمرکز بر توسعه خدمات تجاری و اداری است.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۱۶۳ متر", incompleteness: 3 },
                        { name: "شبکه توزیع آب", quantity: "۷۱ متر", incompleteness: 1 },
                        { name: "شبکه توزیع برق", quantity: "۶۸ متر", incompleteness: 1 },
                        { name: "شبکه توزیع گاز", quantity: "۷۱ متر", incompleteness: 1 },
                        { name: "خدمات روبنایی", quantity: "۳۹,۶۲۳ م.م.", incompleteness: 20 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۵,۱۰۸ متر", incompleteness: 100 }
                    ]
                },
                "محله ۶": {
                    description: "محله‌ای با تمرکز بر زیرساخت‌های بلندمرتبه‌سازی که نیازمند خدمات پشتیبان تجاری و ورزشی است.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۱,۲۱۵ متر", incompleteness: 22 },
                        { name: "شبکه توزیع آب", quantity: "۸۱۶ متر", incompleteness: 15 },
                        { name: "شبکه توزیع برق", quantity: "۶۰۲ متر", incompleteness: 11 },
                        { name: "شبکه توزیع گاز", quantity: "۶۴۳ متر", incompleteness: 11 },
                        { name: "خدمات روبنایی", quantity: "۳۲,۰۷۸ م.م.", incompleteness: 64 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۵,۵۹۷ متر", incompleteness: 100 }
                    ]
                },
                "محله ۷": {
                    description: "محله‌ای توسعه‌نیافته که نیازمند اجرای کامل و بنیادین تمام شبکه‌های زیرساختی و خدمات پایه است.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۳,۵۹۸ متر", incompleteness: 43 },
                        { name: "شبکه توزیع آب", quantity: "۳,۹۶۰ متر", incompleteness: 47 },
                        { name: "شبکه توزیع برق", quantity: "۴,۲۹۵ متر", incompleteness: 51 },
                        { name: "شبکه توزیع گاز", quantity: "۴,۷۶۶ متر", incompleteness: 57 },
                        { name: "خدمات روبنایی", quantity: "۲۶,۶۷۹ م.م.", incompleteness: 93 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۸,۴۲۹ متر", incompleteness: 100 }
                    ]
                },
                "محله ۸": {
                    description: "عقب‌مانده‌ترین محله از نظر پیشرفت که اجرای کامل زیرساخت‌ها در آن یک اولویت کلیدی است.",
                    projects: [
                        { name: "شبکه راه و معابر", quantity: "۶,۷۹۱ متر", incompleteness: 54 },
                        { name: "شبکه توزیع آب", quantity: "۴,۵۰۸ متر", incompleteness: 36 },
                        { name: "شبکه توزیع برق", quantity: "۷,۰۷۳ متر", incompleteness: 56 },
                        { name: "شبکه توزیع گاز", quantity: "۷,۰۷۳ متر", incompleteness: 56 },
                        { name: "خدمات روبنایی", quantity: "۸۶,۳۸۰ م.م.", incompleteness: 74 },
                        { name: "شبکه جمع‌آوری فاضلاب", quantity: "۱۲,۶۷۳ متر", incompleteness: 100 }
                    ]
                }
            };
            const supraLocalProjects = [
                { name: "اجرای کامل شبکه جمع‌آوری و تصفیه فاضلاب", status: "اجرا نشده", quantity: "کل شهرک (طول نامشخص)", details: "پروژه کلان و حیاتی برای کل شهرک. اجرای آن برای صدور پایان‌کار بسیاری از واحدها ضروری است.", icon: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10' },
                { name: "توسعه یکپارچه عرصه ساحلی", status: "پروژه جدید پیشنهادی", quantity: "۳۱۷,۳۱۵ متر مربع", details: "احداث مارینا (بندرگاه قایق‌های تفریحی)، ایجاد پلاژ و خدمات سرگرمی‌های ساحلی و احداث هتل‌ویلا.", icon: 'M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945C19.955 11 21 9.537 21 8s-1.045-3-2.945-3H19V4a1 1 0 00-1-1H6a1 1 0 00-1 1v1H3.055C1.045 5 0 6.537 0 8s1.045 3 3.055 3z' },
                { name: "توسعه پارک جنگلی", status: "پروژه جدید پیشنهادی", quantity: "۵۵۴,۱۴۲ متر مربع", details: "ایجاد پارک ماجراجویی (Adventure Park) با رویکرد اکوتوریسم و احداث اقامتگاه‌های سازگار با محیط زیست.", icon: 'M17.657 18.343A8 8 0 016.343 7.657l-1.414-1.414A10 10 0 1019.07 19.07l-1.414-1.414zM16 12a4 4 0 11-8 0 4 4 0 018 0z' },
                { name: "توسعه ورودی شهرک", status: "پروژه جدید پیشنهادی", quantity: "۶۱۱,۳۳۴ متر مربع", details: "ایجاد مجموعه‌های بازی، مراکز آموزشی و سالن‌های ورزشی در ورودی شهرک برای جذب بازدیدکنندگان.", icon: 'M15 7a2 2 0 012 2m4 0a6 6 0 01-7.623 5.91L12 20.828l-1.377-1.91A6 6 0 013 9a2 2 0 012-2m10 0V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m10 0h-4' }
            ];
            const analysisData = {
                challenges: [
                    { title: "توسعه‌نیافتگی شدید در محلات ۷ و ۸", details: "این دو محله با میانگین پیشرفت زیرساختی کمتر از ۵۰٪، به عنوان نقاط بحرانی شهرک شناخته می‌شوند و نیازمند تخصیص منابع فوری هستند." },
                    { title: "کمبود خدمات روبنایی در کل شهرک", details: "حتی در محلات توسعه‌یافته، کمبود خدمات روبنایی (تجاری، فرهنگی, ورزشی) یک چالش عمومی است که بر کیفیت زندگی ساکنان تأثیر منفی می‌گذارد." },
                    { title: "عدم توازن در توسعه", details: "شکاف عمیقی بین محلات پیشرفته (مانند محله ۵ با تکمیل ۹۹٪ زیرساخت) و محلات عقب‌مانده (مانند محله ۷) وجود دارد که نیازمند یک برنامه توسعه متوازن است." }
                ],
                kpis: [
                    { value: "۶۶٪", label: "میانگین پیشرفت زیرساخت‌ها" },
                    { value: "۳۱٪", label: "میانگین پیشرفت خدمات روبنایی" },
                    { value: "محله ۵", label: "بهترین عملکرد زیرساختی" },
                    { value: "محله ۷", label: "بیشترین نیاز به توجه" }
                ]
            };

            function getColorForPercentage(percentage) {
                const p = Math.max(0, Math.min(100, percentage)) / 100;
                const red = { r: 239, g: 68, b: 68 };
                const yellow = { r: 245, g: 158, b: 11 };
                const green = { r: 34, g: 197, b: 94 };
                let r, g, b;
                if (p < 0.5) {
                    const t = p * 2;
                    r = Math.round(red.r + (yellow.r - red.r) * t);
                    g = Math.round(red.g + (yellow.g - red.g) * t);
                    b = Math.round(red.b + (yellow.b - red.b) * t);
                } else {
                    const t = (p - 0.5) * 2;
                    r = Math.round(yellow.r + (green.r - yellow.r) * t);
                    g = Math.round(yellow.g + (green.g - yellow.g) * t);
                    b = Math.round(yellow.b + (green.b - yellow.b) * t);
                }
                return `rgba(${r}, ${g}, ${b}, 0.8)`;
            }

            function createNeighborhoodChart(projects, canvasId) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const labels = projects.map(p => p.name);
                const completionData = projects.map(p => 100 - p.incompleteness);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'درصد تکمیل',
                            data: completionData,
                            backgroundColor: completionData.map(p => getColorForPercentage(p)),
                            borderWidth: 1,
                            borderColor: '#fff',
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%', font: { family: "'Vazirmatn', sans-serif" } } },
                            y: { ticks: { font: { family: "'Vazirmatn', sans-serif", size: 12 } } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                enabled: true,
                                bodyFont: { family: "'Vazirmatn', sans-serif" }, 
                                titleFont: { family: "'Vazirmatn', sans-serif" }, 
                                callbacks: { 
                                    label: context => ` ${context.label}: ${context.raw}% تکمیل شده` 
                                } 
                            }
                        }
                    }
                });
            }
            
            function createInteractiveBarChart() {
                const projectTypes = [...new Set(Object.values(projectData).flatMap(data => data.projects.map(p => p.name)))];
                const neighborhoodNames = Object.keys(projectData);

                const datasets = projectTypes.map((type, index) => {
                    const dataPoints = neighborhoodNames.map(name => {
                        const project = projectData[name].projects.find(p => p.name === type);
                        return project ? 100 - project.incompleteness : null;
                    });
                    return {
                        label: type,
                        data: dataPoints,
                        backgroundColor: dataPoints.map(p => p !== null ? getColorForPercentage(p) : 'transparent'),
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1,
                        borderRadius: 4
                    };
                });

                const ctx = document.getElementById('summary-bar-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: { labels: neighborhoodNames, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%', font: { family: "'Vazirmatn', sans-serif" } } },
                            x: { ticks: { font: { family: "'Vazirmatn', sans-serif", size: 12 } } }
                        },
                        plugins: {
                            legend: { 
                                position: 'top', 
                                labels: { font: { family: "'Vazirmatn', sans-serif", size: 12 } },
                                onClick: (e, legendItem, legend) => {
                                    const index = legendItem.datasetIndex;
                                    const ci = legend.chart;
                                    if (ci.isDatasetVisible(index)) {
                                        ci.hide(index);
                                        legendItem.hidden = true;
                                    } else {
                                        ci.show(index);
                                        legendItem.hidden = false;
                                    }
                                }
                            },
                            tooltip: { 
                                bodyFont: { family: "'Vazirmatn', sans-serif" }, 
                                titleFont: { family: "'Vazirmatn', sans-serif" }, 
                                callbacks: { 
                                    label: function(context) {
                                        const neighborhoodName = context.label;
                                        const projectName = context.dataset.label;
                                        const completion = context.raw.toFixed(1);
                                        const projectDetails = projectData[neighborhoodName].projects.find(p => p.name === projectName);
                                        const quantity = projectDetails ? projectDetails.quantity : 'N/A';
                                        let status = completion > 75 ? 'پیشرفت عالی' : completion > 40 ? 'وضعیت مطلوب' : 'وضعیت بحرانی';
                                        
                                        return [
                                            `محله: ${neighborhoodName}`,
                                            `پروژه: ${projectName}`,
                                            `درصد تکمیل: ${completion}% (${status})`,
                                            `مقدار باقی‌مانده: ${quantity}`
                                        ];
                                    }
                                } 
                            }
                        }
                    }
                });
            }
            
            function populateContent() {
                const container = document.getElementById('neighborhoods-container');
                let neighborhoodIndex = 1;
                for (const [name, data] of Object.entries(projectData)) {
                    const canvasId = `chart-mahale-${neighborhoodIndex}`;
                    
                    const projectDetailsHtml = data.projects.map(p => {
                        const completion = 100 - p.incompleteness;
                        const colorName = completion > 75 ? 'green' : completion > 40 ? 'amber' : 'red';
                        return `
                            <div class="bg-white p-3 rounded-lg shadow-sm border-r-4 border-${colorName}-400">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-semibold text-slate-700">${p.name}</span>
                                    <span class="text-sm font-bold text-${colorName}-600">${completion}%</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-${colorName}-500 h-2 rounded-full" style="width: ${completion}%;"></div>
                                </div>
                                <p class="text-xs text-slate-500 mt-1 text-left">مقدار باقی‌مانده: ${p.quantity}</p>
                            </div>
                        `;
                    }).join('');

                    const sectionHtml = `
                        <div class="pdf-page">
                            <section>
                                <hr class="mb-8 border-t-2 border-slate-300 border-dashed">
                                <h2 class="text-3xl font-bold text-indigo-900">${name}</h2>
                                <p class="text-md text-slate-600 mt-1 italic">"${data.description}"</p>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                                    <div class="space-y-4 bg-slate-50 p-4 rounded-xl">
                                        <h3 class="font-bold text-lg text-slate-800 mb-3 text-center">جزئیات پیشرفت پروژه‌ها</h3>
                                        ${projectDetailsHtml}
                                    </div>
                                    <div class="flex flex-col justify-center">
                                        <div class="chart-container relative"><canvas id="${canvasId}"></canvas></div>
                                    </div>
                                </div>
                            </section>
                        </div>`;
                    container.innerHTML += sectionHtml;
                    neighborhoodIndex++;
                }
            }

            function populateAnalysisAndKPIs() {
                const analysisContainer = document.getElementById('analysis-container');
                const kpiHtml = analysisData.kpis.map(kpi => `
                    <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-lg text-center">
                        <p class="text-4xl font-bold">${kpi.value}</p>
                        <p class="text-sm opacity-80 mt-1">${kpi.label}</p>
                    </div>
                `).join('');

                const challengesHtml = analysisData.challenges.map(c => `
                    <div class="bg-white p-4 rounded-lg border-r-4 border-amber-500 shadow-md">
                        <h4 class="font-bold text-amber-700">${c.title}</h4>
                        <p class="text-sm text-slate-600 mt-1">${c.details}</p>
                    </div>
                `).join('');

                analysisContainer.innerHTML = `
                    <div class="space-y-4">${kpiHtml}</div>
                    <div class="space-y-4">${challengesHtml}</div>
                `;
            }
            
            function populateSupraLocal() {
                const container = document.getElementById('supra-local-container');
                container.innerHTML = supraLocalProjects.map(p => `
                    <div class="bg-slate-50 rounded-xl shadow-md p-5 border-r-4 border-indigo-500">
                        <div class="flex items-start space-x-4 space-x-reverse">
                            <div class="flex-shrink-0 p-3 bg-indigo-100 rounded-full">
                                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${p.icon}"></path></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-indigo-800">${p.name}</h3>
                                <span class="text-xs font-semibold py-1 px-2.5 uppercase rounded-full text-indigo-600 bg-indigo-100">${p.status}</span>
                                 <p class="text-sm text-slate-600 mt-2"><strong class="font-semibold">مقیاس:</strong> ${p.quantity}</p>
                                <p class="text-sm text-slate-500 mt-2 border-t pt-2">${p.details}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // --- Initial Load ---
            populateContent();
            populateAnalysisAndKPIs();
            populateSupraLocal();
            createInteractiveBarChart();
            
            let neighborhoodIndex = 1;
            for (const [name, data] of Object.entries(projectData)) {
                createNeighborhoodChart(data.projects, `chart-mahale-${neighborhoodIndex}`);
                neighborhoodIndex++;
            }

            // --- PDF Download Logic ---
            document.getElementById('download-btn').addEventListener('click', () => {
                const btn = document.getElementById('download-btn');
                const spinner = document.getElementById('loading-spinner');
                const content = document.getElementById('report-content');

                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                spinner.classList.remove('hidden');
                window.scrollTo(0, 0);

                const opt = {
                    margin: [0.4, 0.2, 0.4, 0.2],
                    filename: 'شناسنامه-مدیریتی-پروژه-ها.pdf',
                    image: { type: 'jpeg', quality: 1.0 },
                    html2canvas: { scale: 3, useCORS: true, logging: false },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                };

                setTimeout(() => {
                    html2pdf().from(content).set(opt).save().then(() => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        spinner.classList.add('hidden');
                    }).catch(err => {
                        console.error("PDF generation error:", err);
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        spinner.classList.add('hidden');
                    });
                }, 500);
            });
        });
    </script>
</body>
</html>
